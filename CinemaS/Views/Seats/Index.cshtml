@model CinemaS.Models.ViewModels.SeatLayoutEditorVM

@using CinemaS.Models
@using CinemaS.Models.ViewModels

@{
    ViewData["Title"] = "Chỉnh sửa bố cục ghế";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<link rel="stylesheet" href="~/css/management.css" asp-append-version="true" />
<link rel="stylesheet" href="~/css/seat-layout-editor.css" asp-append-version="true" />
<link rel="stylesheet" href="~/css/seat-layout-editor-advanced.css" asp-append-version="true" />
<link rel="stylesheet" href="~/css/toast-notification.css" asp-append-version="true" />

<style>
    /* Hide delete buttons by default and only show on last column and last row (explicit classes) */
    .column-number .delete-btn,
    .row-label .delete-btn {
        display: none !important;
    }

    /* Show delete X only for the explicitly marked last column */
    .column-number.last-column .delete-btn {
        display: inline-block !important;
    }

    /* Show delete X only for the explicitly marked last seat-row (both left/right row-label) */
    .seat-row.last-row .row-label .delete-btn {
        display: inline-block !important;
    }

    .column-number .delete-btn, .row-label .delete-btn {
        background: rgba(0,0,0,0.45);
        border: none;
        color: #fff;
        padding: 4px 6px;
        border-radius: 4px;
    }

    /* Confirm modal styles */
    #confirmBackdrop {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.6);
        z-index: 2000;
    }
    #confirmModal {
        display: none;
        position: fixed;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        min-width: 360px;
        max-width: 92%;
        background: linear-gradient(180deg, #1b1b1f, #151517);
        color: #fff;
        border-radius: 12px;
        padding: 18px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.6);
        z-index: 2100;
        border: 1px solid rgba(255,255,255,0.04);
    }
    #confirmModal .modal-title {
        font-weight: 700;
        margin-bottom: 8px;
    }
    #confirmModal .modal-body {
        color: #e6e6e6;
        margin-bottom: 14px;
        display: flex;
        gap: 10px;
        align-items: center;
    }
    #confirmModal .modal-body .icon {
        font-size: 22px;
        color: #ffd43b;
    }
    #confirmModal .modal-actions {
        display:flex;
        justify-content:flex-end;
        gap:10px;
    }
    #confirmModal .btn {
        border-radius: 8px;
    }
    #confirmModal .btn-primary {
        background: linear-gradient(90deg,#caa2ff,#7c3aed);
        border: none;
        color: #111;
        padding: 8px 16px;
    }
    #confirmModal .btn-secondary {
        background: rgba(255,255,255,0.06);
        border: none;
        color: #fff;
        padding: 8px 14px;
    }

    /* ✅ Showtime Section Styles */
    .showtime-section {
        background: var(--dark-card);
        border: 1px solid rgba(255,255,255,0.08);
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 20px;
        box-shadow: 0 2px 15px rgba(0, 0, 0, 0.4);
    }

    .showtime-header {
        margin-bottom: 20px;
        padding-bottom: 12px;
        border-bottom: 2px solid rgba(124, 58, 237, 0.3);
    }

    .showtime-header h5 {
        font-size: 1.4rem;
        font-weight: 700;
        color: #ffffff;
        margin: 0;
    }

    .showtime-section .alert-info {
        background-color: rgba(59, 92, 204, 0.2);
        border: 1px solid rgba(59, 92, 204, 0.3);
        color: var(--text-muted);
        padding: 16px;
        border-radius: 8px;
    }

    .showtime-scroll-container {
        max-height: 220px;
        overflow-y: auto;
        scrollbar-width: thin;
    }

    /* Seat layout scroll wrapper - new */
    .seat-layout-scroll-wrapper {
        width: 100%;
        /* ✅ Max width cho ~40 cột ghế */
        max-width: calc((40px * 2) + (45px * 40) + (6px * 41) + 60px); /* 2 row labels + 40 seats + gaps + padding */
        /* ✅ Max height cho ~30 hàng ghế */
        max-height: calc(30px + (45px * 30) + (8px * 30) + 80px); /* column header + 30 seats + gaps + padding */
        overflow-x: auto;
        overflow-y: auto;
        padding-bottom: 10px;
        scrollbar-width: thin;
        margin: 0 auto; /* ✅ căn giữa container */
        box-sizing: border-box;
    }

    /* ✅ Grid container - inline-flex để không crop */
    .seats-grid-container {
        min-width: min-content;
        display: inline-flex;
        flex-direction: column;
        margin: 0 auto; /* ✅ căn giữa grid khi nhỏ hơn container */
    }

    /* Webkit scrollbar styling */
    .seat-layout-scroll-wrapper::-webkit-scrollbar {
        height: 6px;
        width: 6px;
    }
    .seat-layout-scroll-wrapper::-webkit-scrollbar-thumb {
        background: rgba(255,255,255,0.25);
        border-radius: 4px;
    }

    /* ✅ NEW TOOLBAR STYLES - 2 SECTIONS */
    .toolbar-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 30px;
    }

    .toolbar-section {
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        border: 1px solid rgba(255,255,255,0.08);
        border-radius: 12px;
        padding: 20px;
    }

    .toolbar-section-title {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 16px;
        font-weight: 700;
        color: #ffd43b;
        margin-bottom: 16px;
    }

    .toolbar-section-title i {
        font-size: 14px;
    }

    /* Mode buttons - larger */
    .mode-buttons-group {
        display: flex;
        gap: 10px;
    }

    .mode-button {
        flex: 1;
        padding: 12px 16px;
        background: rgba(255,255,255,0.05);
        border: 2px solid rgba(255,255,255,0.15);
        border-radius: 8px;
        color: #e0e0e0;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 6px;
    }

    .mode-button i {
        font-size: 16px;
    }

    .mode-button:hover {
        background: rgba(124, 58, 237, 0.2);
        border-color: rgba(124, 58, 237, 0.5);
    }

    .mode-button.active {
        background: linear-gradient(135deg, rgba(124, 58, 237, 0.3) 0%, rgba(124, 58, 237, 0.15) 100%);
        border-color: #7c3aed;
        color: #fff;
        box-shadow: 0 0 15px rgba(124, 58, 237, 0.3);
    }

    /* Disabled mode button styles */
    .mode-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        background: rgba(255,255,255,0.1) !important;
        border-color: rgba(255,255,255,0.2) !important;
    }

    /* Action buttons - smaller */
    .action-buttons-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 10px;
    }

    .action-buttons-grid .action-row-2 {
        grid-column: span 4;
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
        margin-top: 0;
    }

    .action-button {
        padding: 8px 12px;
        background: rgba(255,255,255,0.05);
        border: 1px solid rgba(255,255,255,0.15);
        border-radius: 6px;
        color: #e0e0e0;
        font-size: 12px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
    }

    .action-button i {
        font-size: 12px;
    }

    .action-button:hover {
        background: rgba(124, 58, 237, 0.15);
        border-color: rgba(124, 58, 237, 0.4);
    }

    .action-button.active {
        background: linear-gradient(135deg, rgba(124, 58, 237, 0.4) 0%, rgba(124, 58, 237, 0.2) 100%);
        border-color: #7c3aed;
        color: #fff;
    }

    /* Delete button - special danger color */
    .action-button[data-action="delete"] {
        border-color: rgba(239, 68, 68, 0.3);
    }

    .action-button[data-action="delete"]:hover {
        background: rgba(239, 68, 68, 0.15);
        border-color: rgba(239, 68, 68, 0.5);
    }

    .action-button[data-action="delete"].active {
        background: linear-gradient(135deg, rgba(239, 68, 68, 0.4) 0%, rgba(239, 68, 68, 0.2) 100%);
        border-color: #ef4444;
    }

    /* Restore button - special success color */
    .action-button[data-action="restore"] {
        border-color: rgba(34, 197, 94, 0.3);
    }

    .action-button[data-action="restore"]:hover {
        background: rgba(34, 197, 94, 0.15);
        border-color: rgba(34, 197, 94, 0.5);
    }

    .action-button[data-action="restore"].active {
        background: linear-gradient(135deg, rgba(34, 197, 94, 0.4) 0%, rgba(34, 197, 94, 0.2) 100%);
        border-color: #22c55e;
    }

    @@media (max-width: 900px) {
        .toolbar-container {
            grid-template-columns: 1fr;
        }
        
        .action-buttons-grid {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .action-buttons-grid .action-row-2 {
            grid-column: span 2;
        }
    }

</style>

@Html.Raw("<style>@media (max-width: 768px) { .seat-layout-scroll-wrapper { width: 100%; } }</style>")

<div class="seat-editor-container">
    <!-- Header -->
    <div class="editor-header">
        <div class="header-content">
            <h1><i class="fas fa-th"></i> Chỉnh sửa bố cục ghế - @Model.TheaterName</h1>
        </div>
        <div class="header-actions">
            <a href="@Url.Action("Index", "CinemaTheaters")" class="btn btn-success">
                <i class="fas fa-check"></i> Hoàn tất
            </a>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(Model.CinemaTheaterId))
    {
        <input type="hidden" id="theaterSelect" value="@Model.CinemaTheaterId" />

        <select id="seatTypeSelector" style="display:none;">
            @foreach (var seatType in Model.SeatTypeOptions)
            {
                <option value="@seatType.SeatTypeId" data-name="@seatType.Name" data-price="@seatType.Price">
                    @seatType.Name
                </option>
            }
        </select>

        <!-- ✅ NEW TOOLBAR - 2 SECTIONS -->
        <div class="toolbar-container">
            <!-- Section 1: Chế độ chỉnh sửa -->
            <div class="toolbar-section">
                <div class="toolbar-section-title">
                    <i class="fas fa-mouse-pointer"></i>
                    Chế độ chỉnh sửa
                </div>
                <div class="mode-buttons-group">
                    <button class="mode-button active" data-mode="seat">
                        <i class="fas fa-hand-pointer"></i>
                        <span>Chọn theo ghế</span>
                    </button>
                    <button class="mode-button" data-mode="row">
                        <i class="fas fa-star"></i>
                        <span>Chọn theo hàng</span>
                    </button>
                    <button class="mode-button" data-mode="column">
                        <i class="fas fa-columns"></i>
                        <span>Chọn theo cột</span>
                    </button>
                </div>
            </div>

            <!-- Section 2: Hành động -->
            <div class="toolbar-section">
                <div class="toolbar-section-title">
                    <i class="fas fa-tools"></i>
                    Hành động
                </div>
                <div class="action-buttons-grid">
                    <button class="action-button active" data-action="normal">
                        <i class="fas fa-chair"></i>
                        <span>Ghế thường</span>
                    </button>
                    <button class="action-button" data-action="vip">
                        <i class="fas fa-star"></i>
                        <span>Ghế VIP</span>
                    </button>
                    <button class="action-button" data-action="couple">
                        <i class="fas fa-users"></i>
                        <span>Ghế đôi</span>
                    </button>
                    <button class="action-button" data-action="broken">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>Ghế hỏng</span>
                    </button>
                    <div class="action-row-2">
                        <button class="action-button" data-action="delete">
                            <i class="fas fa-trash-alt"></i>
                            <span>Bỏ ghế</span>
                        </button>
                        <button class="action-button" data-action="restore">
                            <i class="fas fa-undo"></i>
                            <span>Khôi phục</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Screen -->
        <div class="screen-container">
            <div class="screen">MÀN HÌNH</div>
        </div>

        <!-- Seat Grid -->
        <div class="seat-layout-scroll-wrapper">
            <div class="seats-grid-container">
                <!-- Column Numbers -->
                <div class="column-numbers">
                    <div class="row-label-space"></div>
                    @for (int col = 1; col <= Model.NumOfColumns; col++)
                    {
                        var isLastCol = col == Model.NumOfColumns;
                        <div class="column-number @(isLastCol ? "last-column" : "")" data-col-index="@col">
                            <span class="col-label-text">@col</span>
                            <button class="delete-btn" title="Xóa cột @col">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    }
                    <div class="add-column-btn" onclick="addColumnAtEnd()">
                        <i class="fas fa-plus"></i>
                    </div>
                </div>

                <!-- Rows -->
                @for (int r = 0; r < Model.Rows.Count; r++)
                {
                    var row = Model.Rows[r];
                    var isLastRow = r == Model.Rows.Count - 1;
                    <div class="seat-row @(isLastRow ? "last-row" : "")" data-row-number="@row.RowNumber" data-row-label="@row.RowLabel">
                        <div class="row-label" data-row-index="@row.RowNumber" data-row-label="@row.RowLabel">
                            <span class="row-label-text">@row.RowLabel</span>
                            <button class="delete-btn" title="Xóa hàng @row.RowLabel">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>

                        <div class="seats-in-row">
                            @foreach (var seat in row.Seats)
                            {
                                var seatClass = "seat";
                                if (!seat.IsActive) seatClass += " inactive";
                                if (seat.IsDeleted) seatClass += " removed-seat";
                                
                                var badge = "";
                                if (seat.SeatTypeName == "VIP") badge = "V";
                                else if (seat.SeatTypeName == "COUPLE" || seat.IsLeftOfPair || seat.IsRightOfPair) badge = "CP";

                                var dataAttrs = $"data-seat-id='{seat.SeatId}' data-seat-type-id='{seat.SeatTypeId}' data-seat-type-name='{seat.SeatTypeName}' data-row-number='{seat.RowNumber}' data-column-index='{seat.ColumnIndex}' data-is-active='{seat.IsActive.ToString().ToLower()}' data-is-deleted='{seat.IsDeleted.ToString().ToLower()}' data-seat-label='{seat.Label}' data-pair-id='{seat.PairId}'";

                                <div class="@seatClass seat-type-@(seat.SeatTypeName?.ToLower() ?? "normal")" @Html.Raw(dataAttrs) onclick="onSeatClick(this)">
                                    @if (seat.IsDeleted)
                                    {
                                        <span class="removed-icon">✗</span>
                                    }
                                    else
                                    {
                                        @if (!string.IsNullOrEmpty(badge))
                                        {
                                            <span class="seat-badge">@badge</span>
                                        }
                                        @if (!seat.IsActive)
                                        {
                                            <span class="broken-icon">✗</span>
                                        }
                                        <div class="seat-label-small">@seat.Label</div>
                                    }
                                </div>
                            }
                        </div>

                        <div class="row-label" data-row-index="@row.RowNumber" data-row-label="@row.RowLabel">
                            <span class="row-label-text">@row.RowLabel</span>
                            <button class="delete-btn" title="Xóa hàng @row.RowLabel">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                }
                
                <!-- Add Row Button -->
                <div class="add-row-section">
                    <button class="btn btn-success btn-add-row" onclick="addRowAtEnd()">
                        <i class="fas fa-plus"></i> Thêm hàng
                    </button>
                </div>
            </div>
        </div>

        <!-- Legend -->
        <div class="legend">
            <div class="legend-title"><i class="fas fa-info-circle"></i> Chú thích</div>
            <div class="legend-items">
                <div class="legend-item">
                    <div class="seat seat-type-normal"></div>
                    <span>Ghế thường</span>
                </div>
                <div class="legend-item">
                    <div class="seat seat-type-vip"><span class="seat-badge">V</span></div>
                    <span>Ghế VIP</span>
                </div>
                <div class="legend-item">
                    <div class="seat seat-type-couple"><span class="seat-badge">CP</span></div>
                    <span>Ghế đôi</span>
                </div>
                <div class="legend-item">
                    <div class="seat inactive"><span class="broken-icon">✗</span></div>
                    <span>Ghế hỏng</span>
                </div>
                <div class="legend-item">
                    <div class="seat removed-seat"><span class="removed-icon">✗</span></div>
                    <span>Ghế đã bỏ</span>
                </div>
            </div>
        </div>

        <!-- ✅ Suất chiếu đang có ở phòng này -->
        <div class="showtime-section" style="margin-top: 40px;">
            <div class="showtime-header">
                <h5><i class="fas fa-calendar-alt"></i> Suất chiếu đang có ở phòng này</h5>
            </div>
            @if (ViewBag.ShowTimes != null && ViewBag.ShowTimes.Count > 0)
            {
                var sortedShowtimes = (ViewBag.ShowTimes as IEnumerable<ShowTimeVM>).OrderBy(x => x.StartTime).ToList();
                <div class="showtime-scroll-container">
                    <div class="admin-table-wrap">
                        <table class="table admin-table align-middle">
                            <thead>
                                <tr>
                                    <th style="width:8%;"><i class="fa-solid fa-hashtag"></i> Mã</th>
                                    <th style="width:25%;"><i class="fa-solid fa-film"></i> Phim</th>
                                    <th style="width:12%;"><i class="fa-solid fa-calendar"></i> Ngày chiếu</th>
                                    <th style="width:10%;"><i class="fa-solid fa-clock"></i> Bắt đầu</th>
                                    <th style="width:10%;"><i class="fa-regular fa-hourglass-half"></i> Kết thúc</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var showTime in sortedShowtimes)
                                {
                                    <tr>
                                        <td><strong>@showTime.ShowTimeId</strong></td>
                                        <td>
                                            <div class="text-truncate-cell" title="@showTime.MovieTitle">
                                                @showTime.MovieTitle
                                            </div>
                                        </td>
                                        <td>@showTime.ShowDate?.ToString("dd/MM/yyyy")</td>
                                        <td>@showTime.StartTime?.ToString("HH:mm")</td>
                                        <td>@showTime.EndTime?.ToString("HH:mm")</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            }
            else
            {
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Chưa có suất chiếu nào cho phòng này.
                </div>
            }
        </div>
    }
</div>

<!-- Confirm modal markup -->
<div id="confirmBackdrop"></div>
<div id="confirmModal" role="dialog" aria-modal="true" aria-labelledby="confirmModalTitle">
    <div class="modal-title" id="confirmModalTitle">Xác nhận</div>
    <div class="modal-body">
        <div class="icon">⚠️</div>
        <div id="confirmModalMessage">Bạn có chắc chắn?</div>
    </div>
    <div class="modal-actions">
        <button id="confirmCancelBtn" class="btn btn-secondary">Hủy</button>
        <button id="confirmOkBtn" class="btn btn-primary">OK</button>
    </div>
</div>

<!-- Toast Notification -->
<div class="booking-toast" id="bookingToast"></div>

@section Scripts {
    <script src="~/js/toast-notification.js" asp-append-version="true"></script>
    <script src="~/js/seat-layout-editor-advanced.js" asp-append-version="true"></script>
}
