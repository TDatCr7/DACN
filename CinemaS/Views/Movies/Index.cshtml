@model CinemaS.Models.ViewModels.MovieListVM
@{
    ViewData["Title"] = "Danh sách phim";
    Layout = "~/Views/Shared/_Layout.cshtml";

    bool isAdmin = User.IsInRole("Admin");
    bool isLoggedIn = User.Identity?.IsAuthenticated ?? false;

    var currentGenre = Context.Request.Query["genre"].ToString();
    if (string.IsNullOrWhiteSpace(currentGenre)) currentGenre = "all";

    var currentStatus = Context.Request.Query["status"].ToString();
    if (string.IsNullOrWhiteSpace(currentStatus)) currentStatus = "all";

    var currentSearch = Context.Request.Query["q"].ToString() ?? "";
}
@functions {
    private static string NormalizeAgeCode(string? raw)
    {
        if (string.IsNullOrWhiteSpace(raw)) return "";
        var s = raw.Trim().ToUpperInvariant();

        if (s == "P" || s == "K" || s == "C" || s == "T13" || s == "T16" || s == "T18") return s;

        if (int.TryParse(s, out var n))
        {
            if (n <= 0) return "P";
            if (n < 13) return "K";
            if (n >= 18) return "T18";
            if (n >= 16) return "T16";
            return "T13";
        }

        return "";
    }

    private static string AgeLabel(string code)
        => string.IsNullOrWhiteSpace(code) ? "Chưa phân loại" : code;

    private static string AgeTooltip(string code)
        => code switch
        {
            "P" => "P: Phổ biến đến mọi đối tượng (không hạn chế độ tuổi).",
            "K" => "K: Khán giả dưới 13 tuổi (cần cha mẹ/người giám hộ đi cùng và giám sát).",
            "T13" => "T13: Khán giả từ đủ 13 tuổi trở lên.",
            "T16" => "T16: Khán giả từ đủ 16 tuổi trở lên.",
            "T18" => "T18: Khán giả từ đủ 18 tuổi trở lên (nội dung nhạy cảm).",
            "C" => "C: Cấm phổ biến đến công chúng.",
            _ => "Chưa có phân loại tuổi."
        };
}

<div class="admin-shell movies-admin">
    <div class="admin-panel">
        <!-- HEADING (chung panel) -->
        <div class="admin-heading movies-heading">
            <h1 class="movies-title">
                <i class="fa-solid fa-film"></i>
                Danh sách phim
            </h1>
        </div>

        <!-- TOOLBAR -->
        <form method="get" asp-action="Index" class="admin-toolbar movies-toolbar" id="movieFilterForm">

            <!-- ROW 1: -->
            <div class="movies-toolbar-row movies-toolbar-row-top">

                <div class="movies-toolbar-left">
                    @if (isAdmin)
                    {
                        <a asp-controller="Genres" asp-action="Index"
                           class="btn btn-outline-light-rounded btn-sweep px-3">
                            <i class="fa-solid fa-layer-group me-1"></i> Quản lý thể loại
                        </a>
                    }
                </div>

                <div class="movies-toolbar-right movies-toolbar-crud">
                    @if (isAdmin)
                    {
                        <a asp-controller="Admin" asp-action="Index"
                           class="btn btn-outline-light-rounded btn-sweep px-3">
                            <i class="fa-solid fa-arrow-left"></i> Quay lại
                        </a>

                        <a asp-action="Create"
                           class="btn btn-primary btn-sweep px-3">
                            <i class="fa-solid fa-plus me-1"></i> Thêm phim
                        </a>

                        <button type="button" id="deleteButton"
                                class="btn btn-danger px-3"
                                onclick="toggleDeleteMode()">
                            <i class="fa-solid fa-trash-can me-1"></i> Xóa phim
                        </button>

                        <button type="button" id="confirmDeleteButton"
                                class="btn btn-primary btn-sweep px-3"
                                style="display:none;"
                                onclick="deleteSelectedMovies()">
                            <i class="fa-solid fa-circle-check me-1"></i> Xác nhận xóa
                        </button>

                        <button type="button" id="cancelDeleteButton"
                                class="btn btn-outline-light-rounded btn-sweep px-3"
                                style="display:none;"
                                onclick="cancelDeleteMode()">
                            <i class="fa-solid fa-circle-xmark me-1"></i> Hủy
                        </button>
                    }
                </div>
            </div>

            <!-- divider -->
            <div class="movies-toolbar-divider"></div>

            <!-- ROW 2: LEFT = Search, RIGHT = Filters -->
            <div class="movies-toolbar-row movies-toolbar-row-bottom">
                <div class="movies-toolbar-search">
                    <div class="input-group admin-search-compact">
                        <input type="text"
                               id="searchInput"
                               name="q"
                               value="@currentSearch"
                               class="form-control admin-search-input"
                               placeholder="Tìm theo tên phim..." />
                        <button class="admin-search-btn" type="submit" title="Tìm kiếm">
                            <i class="fa-solid fa-magnifying-glass"></i>
                        </button>
                    </div>
                </div>

                <div class="movies-toolbar-filters">
                    <div class="movies-filter">
                        <span class="movies-filter-label">
                            <i class="fa-solid fa-filter me-1"></i> Thể loại
                        </span>
                        <select id="categoryFilter"
                                name="genre"
                                class="form-select admin-role-filter"
                                onchange="this.form.submit()">
                            <option value="all" selected="@(currentGenre == "all" ? "selected" : null)">Tất cả</option>
                            @foreach (var cat in Model.Genres)
                            {
                                <option value="@cat" selected="@(currentGenre == cat ? "selected" : null)">@cat</option>
                            }
                        </select>
                    </div>

                    <div class="movies-filter">
                        <span class="movies-filter-label">
                            <i class="fa-solid fa-clock me-1"></i> Trạng thái
                        </span>
                        <select id="statusFilter"
                                name="status"
                                class="form-select admin-role-filter"
                                onchange="this.form.submit()">
                            <option value="all" selected="@(currentStatus == "all" ? "selected" : null)">Tất cả</option>
                            <option value="RELEASED" selected="@(currentStatus == "RELEASED" ? "selected" : null)">Đang chiếu</option>
                            <option value="COMING" selected="@(currentStatus == "COMING" ? "selected" : null)">Sắp chiếu</option>
                            <option value="ENDED" selected="@(currentStatus == "ENDED" ? "selected" : null)">Không còn chiếu</option>
                        </select>
                    </div>

                    <input type="hidden" name="page" value="1" />
                </div>
            </div>
        </form>

        <!-- MESSAGE -->
        @if (!string.IsNullOrEmpty(Model.Message))
        {
            <div id="messageBox" class="cine-alert cine-alert-success" role="alert">
                <i class="fa-solid fa-circle-check"></i>
                <span>@Model.Message</span>
            </div>
            <script>setTimeout(() => document.getElementById('messageBox').style.display = 'none', 2000);</script>
        }
        @if (!string.IsNullOrEmpty(Model.Error))
        {
            <div id="errorBox" class="cine-alert cine-alert-danger" role="alert">
                <i class="fa-solid fa-triangle-exclamation"></i>
                <span>@Model.Error</span>
            </div>
            <script>setTimeout(() => document.getElementById('errorBox').style.display = 'none', 2500);</script>
        }

        <!-- GRID -->
        <form id="deleteMoviesForm" asp-action="DeleteMultiple" method="POST" class="mt-3">
            @Html.AntiForgeryToken()

            <div class="movie-grid" id="movieList">
                @if (Model.Movies.Any())
                {
                    @foreach (var mv in Model.Movies)
                    {
                        var poster = string.IsNullOrWhiteSpace(mv.PosterImage) ? "/images/no-poster.png" : mv.PosterImage;
                        var ageCode = NormalizeAgeCode(mv.Age);
                        if (ageCode == "C" && !isAdmin)
                        {
                            continue;
                        }

                        var ageText = AgeLabel(ageCode);
                        var ageTip = AgeTooltip(ageCode);
                        <div class="movie-item"
                             data-category="@mv.GenreName"
                             data-status="@mv.StatusId">

                            <article class="movie-card">
                                <div class="movie-flip">
                                    <div class="movie-face movie-front">
                                        <div class="movie-poster">
                                            <img src="@poster" alt="@mv.Title" title="@mv.Title" />
                                        </div>
                                    </div>

                                    <div class="movie-face movie-back">
                                        <div class="movie-back-content">
                                            <div class="movie-back-title" title="@mv.Title">@mv.Title</div>

                                            @if (!string.IsNullOrWhiteSpace(mv.Summary))
                                            {
                                                <p class="movie-desc">@mv.Summary</p>
                                            }
                                            else
                                            {
                                                <p class="movie-desc is-empty">Không có mô tả.</p>
                                            }

                                            <div class="movie-meta-col">
                                                <span class="meta-pill meta-genre" title="@mv.GenreName">
                                                    <i class="fa-solid fa-tags me-1"></i>
                                                    @(!string.IsNullOrWhiteSpace(mv.GenreName) ? mv.GenreName : "Khác")
                                                </span>

                                                <span class="meta-pill meta-age" title="@ageTip">
                                                    <i class="fa-solid fa-user-shield me-1"></i>
                                                    @ageText
                                                </span>
                                            </div>

                                            <div class="movie-meta-col">
                                                <span class="meta-pill meta-time">
                                                    <i class="fa-regular fa-calendar me-1"></i>
                                                    @(mv.ReleaseDate.HasValue? mv.ReleaseDate.Value.ToString("dd/MM/yyyy") : "Chưa có ngày chiếu")
                                                </span>
                                            </div>

                                            @if (isAdmin)
                                            {
                                                <label class="delete-checkbox" style="display:none;">
                                                    <input type="checkbox"
                                                           class="form-check-input movie-checkbox"
                                                           name="movie_ids"
                                                           value="@mv.MoviesId" />
                                                    <span>Chọn để xóa</span>
                                                </label>
                                            }

                                            <div class="movie-meta-col">
                                                <span class="meta-pill meta-rating">
                                                    <i class="fa-solid fa-star"></i>
                                                    @(string.IsNullOrWhiteSpace(mv.Rating) ? "NR" : mv.Rating)
                                                </span>
                                            </div>

                                            <div class="movie-actions">
                                                @if (isLoggedIn)
                                                {
                                                    <a asp-action="Details" asp-route-id="@mv.MoviesId"
                                                       class="btn btn-sm btn-primary btn-sweep movie-action-btn">
                                                        <i class="fa-solid fa-eye me-1"></i> Xem chi tiết
                                                    </a>
                                                }
                                                else
                                                {
                                                    <a asp-area="Identity" asp-page="/Account/Login"
                                                       class="btn btn-sm btn-outline-light-rounded movie-action-btn">
                                                        <i class="fa-solid fa-right-to-bracket me-1"></i> Đăng nhập
                                                    </a>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </article>

                        </div>
                    }
                }
                else
                {
                    <div class="movie-empty">
                        <div class="empty-card">
                            <div class="empty-ic"><i class="fa-regular fa-face-frown"></i></div>
                            <div class="empty-text">Không có phim để hiển thị.</div>
                        </div>
                    </div>
                }
            </div>
        </form>

        <!-- PAGER -->
        @if (Model.TotalPages > 1)
        {
            <nav aria-label="Phân trang phim" class="cine-pager" style="justify-content:center;">
                <a class="cine-page-btn @(Model.HasPreviousPage ? "" : "is-disabled")"
                   asp-action="Index"
                   asp-route-page="@(Model.PageIndex - 1)"
                   asp-route-genre="@currentGenre"
                   asp-route-status="@currentStatus"
                   asp-route-q="@currentSearch">
                    <i class="fa-solid fa-chevron-left"></i>
                </a>

                @for (var i = 1; i <= Model.TotalPages; i++)
                {
                    <a class="cine-page-btn @(i == Model.PageIndex ? "is-active" : "")"
                       asp-action="Index"
                       asp-route-page="@i"
                       asp-route-genre="@currentGenre"
                       asp-route-status="@currentStatus"
                       asp-route-q="@currentSearch">
                        @i
                    </a>
                }

                <a class="cine-page-btn @(Model.HasNextPage ? "" : "is-disabled")"
                   asp-action="Index"
                   asp-route-page="@(Model.PageIndex + 1)"
                   asp-route-genre="@currentGenre"
                   asp-route-status="@currentStatus"
                   asp-route-q="@currentSearch">
                    <i class="fa-solid fa-chevron-right"></i>
                </a>
            </nav>
        }
    </div>
</div>

<script>
    let isDeleteMode = false;

    function toggleDeleteMode() {
        isDeleteMode = !isDeleteMode;
        const checkboxes = document.querySelectorAll('.delete-checkbox');
        const deleteButton = document.getElementById('deleteButton');
        const confirmDeleteButton = document.getElementById('confirmDeleteButton');
        const cancelDeleteButton = document.getElementById('cancelDeleteButton');

        if (isDeleteMode) {
            checkboxes.forEach(cb => cb.style.display = 'flex');
            deleteButton.style.display = 'none';
            confirmDeleteButton.style.display = 'inline-flex';
            cancelDeleteButton.style.display = 'inline-flex';
        } else {
            cancelDeleteMode();
        }
    }

    function cancelDeleteMode() {
        const checkboxes = document.querySelectorAll('.delete-checkbox');
        const deleteButton = document.getElementById('deleteButton');
        const confirmDeleteButton = document.getElementById('confirmDeleteButton');
        const cancelDeleteButton = document.getElementById('cancelDeleteButton');

        checkboxes.forEach(box => {
            box.style.display = 'none';
            const input = box.querySelector('input');
            if (input) input.checked = false;

            const card = box.closest('.movie-item');
            card?.classList.remove('selected-for-delete');
        });

        deleteButton.style.display = 'inline-flex';
        confirmDeleteButton.style.display = 'none';
        cancelDeleteButton.style.display = 'none';
        isDeleteMode = false;
    }

    function deleteSelectedMovies() {
        const checked = document.querySelectorAll('.movie-checkbox:checked');
        if (checked.length === 0) {
            alert('Vui lòng chọn ít nhất một phim để xóa!');
            return;
        }
        if (confirm('Bạn có chắc chắn muốn xóa các phim đã chọn?')) {
            document.getElementById('deleteMoviesForm').submit();
        }
    }

    document.addEventListener('change', function (e) {
        if (e.target.classList.contains('movie-checkbox')) {
            const item = e.target.closest('.movie-item');
            if (!item) return;
            if (e.target.checked) item.classList.add('selected-for-delete');
            else item.classList.remove('selected-for-delete');
        }
    });
</script>
