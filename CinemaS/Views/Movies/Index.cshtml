@model CinemaS.Models.ViewModels.MovieListVM
@{
    ViewData["Title"] = "Danh sách phim";
    Layout = "~/Views/Shared/_Layout.cshtml";
    bool isAdmin = User.IsInRole("Admin");
    bool isLoggedIn = User.Identity?.IsAuthenticated ?? false;

    // đọc lại giá trị filter hiện tại từ query
    var currentGenre = Context.Request.Query["genre"].ToString();
    if (string.IsNullOrWhiteSpace(currentGenre)) currentGenre = "all";

    var currentStatus = Context.Request.Query["status"].ToString();
    if (string.IsNullOrWhiteSpace(currentStatus)) currentStatus = "all";

    var currentSearch = Context.Request.Query["q"].ToString() ?? "";
}

<link rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />

<h1 style="text-align: center;">
    <i class="fas fa-film"></i> Danh sách Phim
</h1>
<marquee style="
    color:#e5e7f5;
    font-style:italic;
    margin-bottom:14px;
    padding:10px 14px;
    border-radius:12px;

    /* Nền chuẩn layout */
    background: radial-gradient(circle at 0% 0%,
                rgba(59,130,246,0.25),
                rgba(30,41,59,0.85)),
                radial-gradient(circle at 100% 0%,
                rgba(124,58,237,0.25),
                rgba(30,41,59,0.85));

    border: 1px solid rgba(148,163,255,0.4);
    backdrop-filter: blur(12px);
">
    <i class="fas fa-star" style="color:#facc15;"></i>
    Kho tàng điện ảnh – Kết nối cảm xúc.
</marquee>

<!-- Lọc + tìm kiếm: gửi GET lên Movies/Index -->
<form method="get" asp-action="Index"
      class="filter-container"
      style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
    <div style="display:inline-flex;align-items:center;gap:10px;flex-wrap:wrap;">
        <label for="categoryFilter"><i class="fas fa-filter"></i> Thể loại: </label>
        <select id="categoryFilter"
                name="genre"
                style="padding:5px;border-radius:5px;border:1px solid #007bff;"
                onchange="this.form.submit()">
            <option value="all"
                    selected="@(currentGenre == "all" ? "selected" : null)">
                Tất cả
            </option>
            @foreach (var cat in Model.Genres)
            {
                <option value="@cat"
                        selected="@(currentGenre == cat ? "selected" : null)">
                    @cat
                </option>
            }
        </select>

        <label for="statusFilter" style="margin-left:12px;">
            <i class="fas fa-clock"></i> Trạng thái:
        </label>
        <select id="statusFilter"
                name="status"
                style="padding:5px;border-radius:5px;border:1px solid #007bff;"
                onchange="this.form.submit()">
            <option value="all"
                    selected="@(currentStatus == "all" ? "selected" : null)">
                Tất cả
            </option>
            <option value="RELEASED"
                    selected="@(currentStatus == "RELEASED" ? "selected" : null)">
                Đang chiếu
            </option>
            <option value="COMING"
                    selected="@(currentStatus == "COMING" ? "selected" : null)">
                Sắp chiếu
            </option>
            <option value="ENDED"
                    selected="@(currentStatus == "ENDED" ? "selected" : null)">
                Không còn chiếu
            </option>
        </select>

        @if (isAdmin)
        {
            <a asp-action="Create" class="btn btn-primary" style="white-space:nowrap;margin-left:10px;">
                <i class="fas fa-plus-circle"></i> Thêm phim
            </a>
            <button type="button" id="deleteButton" class="btn btn-danger simple"
                    style="white-space:nowrap;margin-left:10px;" onclick="toggleDeleteMode()">
                <i class="fas fa-trash-alt"></i> Xóa phim
            </button>
            <button type="button" id="confirmDeleteButton" class="btn btn-primary simple"
                    style="white-space:nowrap;margin-left:20px;display:none;" onclick="deleteSelectedMovies()">
                <i class="fas fa-check-circle"></i> Xác nhận xóa
            </button>
            <button type="button" id="cancelDeleteButton" class="btn btn-secondary"
                    style="white-space:nowrap;margin-left:10px;display:none;" onclick="cancelDeleteMode()">
                <i class="fas fa-times-circle"></i> Hủy
            </button>
        }
    </div>

    <div style="display:inline-flex;align-items:center;gap:10px;">
        <label for="searchInput"><i class="fas fa-search"></i> Tìm kiếm: </label>
        <input type="text"
               id="searchInput"
               name="q"
               value="@currentSearch"
               placeholder="Nhập tên phim..."
               style="padding:5px;border-radius:5px;border:1px solid #007bff;width:220px;"
               onkeypress="if(event.key==='Enter'){this.form.submit();}" />
    </div>
</form>

<!-- Thông báo -->
@if (!string.IsNullOrEmpty(Model.Message))
{
    <div id="messageBox" class="alert alert-success text-center" role="alert">
        <i class="fas fa-check-circle"></i> @Model.Message
    </div>
    <script>setTimeout(() => document.getElementById('messageBox').style.display = 'none', 2000);</script>
}
@if (!string.IsNullOrEmpty(Model.Error))
{
    <div id="errorBox" class="alert alert-danger text-center" role="alert">
        <i class="fas fa-exclamation-circle"></i> @Model.Error
    </div>
    <script>setTimeout(() => document.getElementById('errorBox').style.display = 'none', 2000);</script>
}

<div class="container">
    <form id="deleteMoviesForm" asp-action="DeleteMultiple" method="POST">
        @Html.AntiForgeryToken()
        <div class="row" id="movieList">
            @if (Model.Movies.Any())
            {
                @foreach (var mv in Model.Movies)
                {
                    <div class="col-md-3 mb-3 movie-item"
                         data-category="@mv.GenreName"
                         data-status="@mv.StatusId">
                        <div class="card">
                            <div class="content">
                                <div class="front">
                                    <div class="image-container">
                                        @{
                                            var poster = string.IsNullOrWhiteSpace(mv.PosterImage)
                                            ? "/images/no-poster.png"
                                            : mv.PosterImage;
                                        }
                                        <img src="@poster" alt="@mv.Title"
                                             class="card-img-top" title="@mv.Title" />
                                    </div>
                                </div>
                                <div class="back">
                                    <div class="back-content">
                                        <h5 class="card-title">
                                            <a asp-action="Details" asp-route-id="@mv.MoviesId"
                                               class="movie-link movie-title"
                                               title="@mv.Title">
                                                <i class="fas fa-tag"></i> @mv.Title
                                            </a>
                                        </h5>

                                        @if (!string.IsNullOrWhiteSpace(mv.Summary))
                                        {
                                            <p class="card-text movie-description">
                                                <i class="fas fa-info-circle"></i> @mv.Summary
                                            </p>
                                        }

                                        @if (mv.ReleaseDate.HasValue)
                                        {
                                            <p class="card-text movie-release">
                                                <strong><i class="fas fa-calendar-day"></i></strong>
                                                @mv.ReleaseDate.Value.ToString("dd/MM/yyyy")
                                            </p>
                                        }

                                        @* badge trạng thái *@
                                        @if (!string.IsNullOrWhiteSpace(mv.StatusName))
                                        {
                                            <span class="badge bg-success"
                                                  style="margin-bottom:6px;">
                                                @mv.StatusName
                                            </span>
                                        }

                                        @if (isAdmin)
                                        {
                                            <div class="form-check delete-checkbox" style="display: none;">
                                                <input type="checkbox"
                                                       class="form-check-input movie-checkbox"
                                                       name="movie_ids"
                                                       value="@mv.MoviesId" />
                                                <label class="form-check-label">Chọn để xóa</label>
                                            </div>
                                        }

                                        @if (isLoggedIn)
                                        {
                                            <a asp-action="Details" asp-route-id="@mv.MoviesId"
                                               class="btn-sm action-btn">
                                                <button type="button"><span>Xem chi tiết</span></button>
                                            </a>
                                        }
                                        else
                                        {
                                            <a asp-area="Identity" asp-page="/Account/Login"
                                               class="btn-sm action-btn">
                                                <button type="button"><span>Đăng nhập</span></button>
                                            </a>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="col-12 text-center">
                    <p>Không có phim để hiển thị.</p>
                </div>
            }
        </div>
    </form>

    <!-- PHÂN TRANG -->
    @if (Model.TotalPages > 1)
    {
        <nav aria-label="Phân trang phim" class="mt-3">
            <ul class="pagination pagination-sm justify-content-center">
                <li class="page-item @(Model.HasPreviousPage ? "" : "disabled")">
                    <a class="page-link"
                       asp-action="Index"
                       asp-route-page="@(Model.PageIndex - 1)"
                       asp-route-genre="@currentGenre"
                       asp-route-status="@currentStatus"
                       asp-route-q="@currentSearch">
                        «
                    </a>
                </li>

                @for (var i = 1; i <= Model.TotalPages; i++)
                {
                    <li class="page-item @(i == Model.PageIndex ? "active" : "")">
                        <a class="page-link"
                           asp-action="Index"
                           asp-route-page="@i"
                           asp-route-genre="@currentGenre"
                           asp-route-status="@currentStatus"
                           asp-route-q="@currentSearch">
                            @i
                        </a>
                    </li>
                }

                <li class="page-item @(Model.HasNextPage ? "" : "disabled")">
                    <a class="page-link"
                       asp-action="Index"
                       asp-route-page="@(Model.PageIndex + 1)"
                       asp-route-genre="@currentGenre"
                       asp-route-status="@currentStatus"
                       asp-route-q="@currentSearch">
                        »
                    </a>
                </li>
            </ul>
        </nav>
    }
</div>

<style>
    .card {
        overflow: visible;
        width: 200px;
        height: 250px;
        perspective: 1000px;
    }

    .movie-description {
        font-size: 16px;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
        height: 3.0em;
    }

    .movie-title {
        font-size: 20px;
        font-weight: 500;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
        height: 2.5em;
        cursor: default;
    }

    .content {
        width: 100%;
        height: 100%;
        transform-style: preserve-3d;
        transition: transform 300ms;
        box-shadow: 0px 0px 10px 1px #000000ee;
        border-radius: 5px;
        position: relative;
    }

    .front, .back {
        position: absolute;
        width: 100%;
        height: 100%;
        backface-visibility: hidden;
        border-radius: 5px;
        overflow: hidden;
    }

    .front {
        background-color: #90EE90;
    }

    .back {
        background-color: rgba(220, 253, 250, 0.91);
        transform: rotateY(180deg);
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .back-content {
        width: 100%;
        height: 100%;
        background-color: rgba(220, 253, 250, 0.91);
        color: black;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 20px;
        box-sizing: border-box;
    }

    .card:hover .content {
        transform: rotateY(180deg);
    }

    .image-container {
        width: 100%;
        height: 100%;
    }

        .image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

    .movie-link {
        color: black;
        text-decoration: none;
    }

    button {
        display: inline-block;
        width: 120px;
        height: 40px;
        border-radius: 10px;
        border: 1px solid #03045e;
        position: relative;
        overflow: hidden;
        transition: all 0.5s ease-in;
        z-index: 1;
    }

        button::before, button::after {
            content: '';
            position: absolute;
            top: 0;
            width: 0;
            height: 100%;
            transform: skew(15deg);
            transition: all 0.5s;
            overflow: hidden;
            z-index: -1;
        }

        button::before {
            left: -10px;
            background: #240046;
        }

        button::after {
            right: -10px;
            background: #5a189a;
        }

        button:hover::before, button:hover::after {
            width: 58%;
        }

        button:hover span {
            color: #e0aaff;
            transition: 0.3s;
        }

        button span {
            color: #03045e;
            font-size: 16px;
            transition: all 0.3s ease-in;
        }

    .movie-description, .movie-release {
        margin: 5px 0;
    }

    .selected-for-delete {
        border: 3px solid red !important;
        transition: border 0.3s ease;
    }

    .simple:hover {
        background-color: #c82333;
        color: white;
    }

    .simple::before, .simple::after {
        display: none !important;
    }
</style>

<script>
    let isDeleteMode = false;

    function toggleDeleteMode() {
        isDeleteMode = !isDeleteMode;
        const checkboxes = document.querySelectorAll('.delete-checkbox');
        const deleteButton = document.getElementById('deleteButton');
        const confirmDeleteButton = document.getElementById('confirmDeleteButton');
        const cancelDeleteButton = document.getElementById('cancelDeleteButton');

        if (isDeleteMode) {
            checkboxes.forEach(cb => cb.style.display = 'block');
            deleteButton.style.display = 'none';
            confirmDeleteButton.style.display = 'inline-block';
            cancelDeleteButton.style.display = 'inline-block';
        } else {
            cancelDeleteMode();
        }
    }

    function cancelDeleteMode() {
        const checkboxes = document.querySelectorAll('.delete-checkbox');
        const deleteButton = document.getElementById('deleteButton');
        const confirmDeleteButton = document.getElementById('confirmDeleteButton');
        const cancelDeleteButton = document.getElementById('cancelDeleteButton');

        checkboxes.forEach(box => {
            box.style.display = 'none';
            const input = box.querySelector('input');
            if (input) input.checked = false;
            const card = box.closest('.card');
            card?.classList.remove('selected-for-delete');
        });
        deleteButton.style.display = 'inline-block';
        confirmDeleteButton.style.display = 'none';
        cancelDeleteButton.style.display = 'none';
        isDeleteMode = false;
    }

    function deleteSelectedMovies() {
        const checked = document.querySelectorAll('.movie-checkbox:checked');
        if (checked.length === 0) {
            alert('Vui lòng chọn ít nhất một phim để xóa!');
            return;
        }
        if (confirm('Bạn có chắc chắn muốn xóa các phim đã chọn?')) {
            document.getElementById('deleteMoviesForm').submit();
        }
    }

    document.addEventListener('change', function (e) {
        if (e.target.classList.contains('movie-checkbox')) {
            const card = e.target.closest('.card');
            if (e.target.checked) card.classList.add('selected-for-delete');
            else card.classList.remove('selected-for-delete');
        }
    });
</script>
