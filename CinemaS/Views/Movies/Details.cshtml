@model CinemaS.Models.Movies
@{
    ViewData["Title"] = Model.Title ?? "Chi tiết phim";
    Layout = "~/Views/Shared/_Layout.cshtml";

    string? embed = null;
    if (!string.IsNullOrWhiteSpace(Model.TrailerLink))
    {
        var link = Model.TrailerLink!;
        if (link.Contains("youtu.be/")) { var id = link.Split("youtu.be/").Last().Split('?')[0]; embed = $"https://www.youtube.com/embed/{id}"; }
        else if (link.Contains("watch?v=")) { var id = link.Split("watch?v=").Last().Split('&')[0]; embed = $"https://www.youtube.com/embed/{id}"; }
        else if (link.Contains("/shorts/")) { var id = link.Split("/shorts/").Last().Split('?')[0]; embed = $"https://www.youtube.com/embed/{id}"; }
    }

    string genreText = (ViewBag.GenreText as string) ?? "Khác";
    string durationText = Model.Duration.HasValue ? $"{Model.Duration}’" : "Chưa có thông tin";
    string countryText = !string.IsNullOrWhiteSpace(Model.Country) ? Model.Country : "Chưa có thông tin";
    string audioText = !string.IsNullOrWhiteSpace(Model.AudioOption) ? Model.AudioOption : "Chưa có thông tin";
    string languageText = !string.IsNullOrWhiteSpace(Model.Language) ? Model.Language : "Chưa có thông tin";
    string summaryText = !string.IsNullOrWhiteSpace(Model.Summary) ? Model.Summary : "Chưa có thông tin";
    string contentText = !string.IsNullOrWhiteSpace(Model.DetailDescription) ? Model.DetailDescription : summaryText;
    string releaseText = Model.ReleaseDate?.ToString("dddd, dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")) ?? "Chưa có thông tin";

    var directors = (IEnumerable<string>)(ViewBag.Directors ?? new List<string> { "Chưa có thông tin" });
    var actors = (IEnumerable<string>)(ViewBag.Actors ?? new List<string> { "Chưa có thông tin" });

    bool isAdmin = User.IsInRole("Admin");

    var posterSrc = !string.IsNullOrWhiteSpace(Model.PosterImage) ? Model.PosterImage : "/images/no-poster.png";
    var bannerSrc = !string.IsNullOrWhiteSpace(Model.BannerImage) ? Model.BannerImage : "/images/no-poster.png";
    var ratingText = string.IsNullOrWhiteSpace(Model.Rating?.ToString()) ? "NR" : Model.Rating!.ToString();
}

<div class="admin-shell movies-admin movies-crud movies-detail">
    <div class="admin-panel">
        <div class="crud-head">
            <h1 class="crud-title">
                <i class="fa-solid fa-film"></i>
                Chi tiết phim
            </h1>

            <div class="crud-actions">
                <a class="btn btn-outline-light-rounded btn-sweep px-3" asp-action="Index">
                    <i class="fa-solid fa-list me-1"></i> Danh sách
                </a>

                @if (isAdmin)
                {
                    <a class="btn btn-outline-light-rounded btn-sweep px-3" asp-action="Edit" asp-route-id="@Model.MoviesId">
                        <i class="fa-solid fa-pen me-1"></i> Sửa
                    </a>

                    <form asp-action="Delete" asp-route-id="@Model.MoviesId" method="post" class="d-inline"
                          onsubmit="return confirm('Xoá phim này?');">
                        @Html.AntiForgeryToken()
                        <button type="submit" class="btn btn-danger px-3">
                            <i class="fa-solid fa-trash-can me-1"></i> Xoá
                        </button>
                    </form>
                }
            </div>
        </div>

        <div class="crud-divider"></div>

        <div class="crud-body">
            <div class="row g-3">
                <!-- LEFT: media (sticky) -->
                <div class="col-lg-4 movies-crud-col movie-media-sticky">
                    <div class="details-panel">
                        <div class="details-panel-title">Poster</div>
                        <img class="poster-img" src="@posterSrc" alt="@Model.Title" />

                        <div class="details-panel-divider"></div>

                        <div class="details-panel-title">Banner</div>
                        <img class="banner-img" src="@bannerSrc" alt="@Model.Title banner" />
                    </div>
                </div>

                <!-- RIGHT: info (sticky) -->
                <div class="col-lg-8 movie-info-sticky">
                    <div class="details-panel">
                        <div class="details-head">
                            <div class="details-head-left">
                                <div class="details-title">@Model.Title</div>
                                <div class="details-sub">@summaryText</div>
                            </div>

                            <div class="details-head-right">
                                <div class="details-pill">
                                    <span class="details-pill-label">IMDb</span>
                                    <span class="details-pill-value">@ratingText</span>
                                </div>
                            </div>
                        </div>

                        <div class="details-panel-divider"></div>

                        <div class="details-section-title">Thông tin</div>

                        <div class="details-kv-grid">
                            <div class="details-kv">
                                <div class="details-k">Thể loại</div>
                                <div class="details-v">@genreText</div>
                            </div>

                            <div class="details-kv">
                                <div class="details-k">Khởi chiếu</div>
                                <div class="details-v">@releaseText</div>
                            </div>

                            <div class="details-kv">
                                <div class="details-k">Thời lượng</div>
                                <div class="details-v">@durationText</div>
                            </div>

                            <div class="details-kv">
                                <div class="details-k">Quốc gia</div>
                                <div class="details-v">@countryText</div>
                            </div>

                            <div class="details-kv">
                                <div class="details-k">Âm thanh</div>
                                <div class="details-v">@audioText</div>
                            </div>

                            <div class="details-kv">
                                <div class="details-k">Ngôn ngữ</div>
                                <div class="details-v">@languageText</div>
                            </div>

                            <div class="details-kv details-kv-span2">
                                <div class="details-k">Đạo diễn</div>
                                <div class="details-v">@string.Join(", ", directors)</div>
                            </div>

                            <div class="details-kv details-kv-span2">
                                <div class="details-k">Diễn viên</div>
                                <div class="details-v">@string.Join(", ", actors)</div>
                            </div>
                        </div>

                        <div class="details-panel-divider"></div>

                        <div class="details-section-title">Nội dung</div>
                        <div class="details-content">
                            @Html.Raw(contentText)
                        </div>

                        @if (embed != null)
                        {
                            <div class="details-panel-divider"></div>

                            <div class="details-section-title">Trailer</div>
                            <div class="ratio ratio-16x9">
                                <iframe src="@embed" title="@Model.Title trailer" allowfullscreen
                                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"></iframe>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
