@model CinemaS.Models.Movies
@{
    ViewData["Title"] = "Tạo phim";
    Layout = "~/Views/Shared/_Layout.cshtml";

    var participants = (List<CinemaS.Models.Participants>)ViewBag.Participants ?? new();
    var genres = (List<CinemaS.Models.Genres>)ViewBag.Genres ?? new();
}

<div class="admin-shell movies-admin movies-crud movies-create">
    <div class="admin-panel">
        <div class="crud-head">
            <h1 class="crud-title">
                <i class="fa-solid fa-film"></i>
                Tạo phim
            </h1>

            <div class="crud-actions">
                <button type="button" class="btn btn-outline-light-rounded btn-sweep px-3" onclick="history.back()">
                    <i class="fa-solid fa-arrow-left-long me-1"></i> Quay lại
                </button>
                <button type="submit" form="movieCreateForm" class="btn btn-primary btn-sweep px-3">
                    <i class="fa-solid fa-plus me-1"></i> Tạo
                </button>
            </div>
        </div>

        <div class="crud-divider"></div>

        <div class="crud-body">
            <form id="movieCreateForm" asp-action="Create" enctype="multipart/form-data" novalidate>
                @Html.AntiForgeryToken()
                <div asp-validation-summary="ModelOnly" id="customValidationMsg" class="text-danger mb-2 d-none"></div>

                <div class="row g-3">
                    <!-- LEFT -->
                    <div class="col-lg-8">
                        <div class="create-panel">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label asp-for="MoviesId" class="form-label">Mã</label>
                                    <input asp-for="MoviesId" class="form-control movie-input" required />
                                    <span asp-validation-for="MoviesId" class="text-danger" data-valmsg-for="MoviesId" data-valmsg-replace="true"></span>
                                </div>
                                <div class="col-md-8">
                                    <label asp-for="Title" class="form-label">Tên phim</label>
                                    <input asp-for="Title" class="form-control movie-input" required />
                                    <span asp-validation-for="Title" class="text-danger" data-valmsg-for="Title" data-valmsg-replace="true"></span>
                                </div>

                                <div class="col-md-6">
                                    <label asp-for="StatusId" class="form-label">Trạng thái</label>
                                    <select asp-for="StatusId" asp-items="ViewBag.StatusId" class="form-select movie-select" required></select>
                                    <span asp-validation-for="StatusId" class="text-danger" data-valmsg-for="StatusId" data-valmsg-replace="true"></span>
                                </div>
                                <div class="col-md-6">
                                    <label asp-for="ReleaseDate" class="form-label">Khởi chiếu</label>
                                    <input asp-for="ReleaseDate" type="date" class="form-control movie-input" required />
                                    <span asp-validation-for="ReleaseDate" class="text-danger" data-valmsg-for="ReleaseDate" data-valmsg-replace="true"></span>
                                </div>

                                <div class="col-md-4">
                                    <label asp-for="Duration" class="form-label">Thời lượng (phút)</label>
                                    <input asp-for="Duration" type="number" min="1" class="form-control movie-input" required />
                                    <span asp-validation-for="Duration" class="text-danger" data-valmsg-for="Duration" data-valmsg-replace="true"></span>
                                </div>
                                <div class="col-md-4">
                                    <label asp-for="Age" class="form-label">Độ tuổi</label>
                                    <input asp-for="Age" type="number" min="0" class="form-control movie-input" required />
                                    <span asp-validation-for="Age" class="text-danger" data-valmsg-for="Age" data-valmsg-replace="true"></span>
                                </div>
                                <div class="col-md-4">
                                    <label asp-for="Rating" class="form-label">Điểm IMDb /10</label>
                                    <input asp-for="Rating" type="number" step="0.1" min="0" max="10" class="form-control movie-input" required />
                                    <span asp-validation-for="Rating" class="text-danger" data-valmsg-for="Rating" data-valmsg-replace="true"></span>
                                </div>

                                <div class="col-md-4">
                                    <label asp-for="Language" class="form-label">Ngôn ngữ</label>
                                    <input asp-for="Language" class="form-control movie-input" required />
                                    <span asp-validation-for="Language" class="text-danger" data-valmsg-for="Language" data-valmsg-replace="true"></span>
                                </div>
                                <div class="col-md-4">
                                    <label asp-for="Country" class="form-label">Quốc gia</label>
                                    <input asp-for="Country" class="form-control movie-input" required />
                                    <span asp-validation-for="Country" class="text-danger" data-valmsg-for="Country" data-valmsg-replace="true"></span>
                                </div>
                                <div class="col-md-4">
                                    <label asp-for="AudioOption" class="form-label">Âm thanh</label>
                                    <input asp-for="AudioOption" class="form-control movie-input" required />
                                    <span asp-validation-for="AudioOption" class="text-danger" data-valmsg-for="AudioOption" data-valmsg-replace="true"></span>
                                </div>

                                <div class="col-12">
                                    <label asp-for="TrailerLink" class="form-label">Trailer (YouTube)</label>
                                    <input asp-for="TrailerLink" class="form-control movie-input" required />
                                    <span asp-validation-for="TrailerLink" class="text-danger" data-valmsg-for="TrailerLink" data-valmsg-replace="true"></span>
                                </div>

                                <div class="col-12">
                                    <label asp-for="Summary" class="form-label">Mô tả ngắn</label>
                                    <textarea asp-for="Summary" class="form-control movie-input" rows="2" required></textarea>
                                    <span asp-validation-for="Summary" class="text-danger" data-valmsg-for="Summary" data-valmsg-replace="true"></span>
                                </div>

                                <div class="col-12">
                                    <label asp-for="DetailDescription" class="form-label">Nội dung</label>
                                    <textarea asp-for="DetailDescription" class="form-control movie-input" rows="5" required></textarea>
                                    <span asp-validation-for="DetailDescription" class="text-danger" data-valmsg-for="DetailDescription" data-valmsg-replace="true"></span>
                                </div>
                            </div>

                            <hr class="create-divider" />

                            <div class="d-flex justify-content-between align-items-center">
                                <div class="movie-section-title mb-0">Thể loại</div>
                                <a asp-controller="Genres" asp-action="Index" class="btn btn-sm btn-outline-light-rounded btn-sweep px-3">
                                    <i class="fa-solid fa-layer-group me-1"></i> Quản lý thể loại
                                </a>
                            </div>

                            <label class="form-label mt-2">Chọn thể loại</label>
                            <select id="genresSelect" name="selectedGenres" class="form-select movie-input" multiple="multiple" required>
                                @foreach (var g in genres)
                                {
                                    <option value="@g.GenresId">@g.Name</option>
                                }
                            </select>
                            <div class="text-danger mt-1 d-none" id="genresRequiredMsg">Vui lòng chọn ít nhất 1 thể loại.</div>

                            <hr class="create-divider" />

                            <div class="movie-section-title">Người tham gia</div>

                            <label class="form-label">Đạo diễn</label>
                            <select id="directorsSelect" name="selectedDirectors" class="form-select movie-input" multiple="multiple">
                                @foreach (var p in participants)
                                {
                                    var name = (p.NickName ?? p.BirthName) ?? p.ParticipantsId;
                                    <option value="@p.ParticipantsId">@name</option>
                                }
                            </select>
                            <div class="text-danger mt-1 d-none" id="directorsRequiredMsg">Vui lòng chọn ít nhất 1 đạo diễn.</div>

                            <small class="form-label d-block mt-3">Thêm đạo diễn mới (cách nhau bằng dấu phẩy):</small>
                            <input type="text" name="newDirectors" class="form-control movie-input"
                                   placeholder="Ví dụ: Christopher Nolan, Denis Villeneuve" />

                            <div class="mt-4">
                                <label class="form-label">Diễn viên</label>
                                <select id="actorsSelect" name="selectedActors" class="form-select movie-input" multiple="multiple">
                                    @foreach (var p in participants)
                                    {
                                        var name = (p.NickName ?? p.BirthName) ?? p.ParticipantsId;
                                        <option value="@p.ParticipantsId">@name</option>
                                    }
                                </select>
                                <div class="text-danger mt-1 d-none" id="actorsRequiredMsg">Vui lòng chọn ít nhất 1 diễn viên.</div>

                                <small class="form-label d-block mt-3">Thêm diễn viên mới (cách nhau bằng dấu phẩy):</small>
                                <input type="text" name="newActors" class="form-control movie-input"
                                       placeholder="Ví dụ: Tom Cruise, Emily Blunt" />
                            </div>
                        </div>
                    </div>


                    <!-- RIGHT: NOT sticky -->
                    <div class="col-lg-4 movies-crud-col movie-media-sticky">
                        <div class="media-card">
                            <div class="media-label">Poster</div>
                            <img id="posterPreview" class="poster-img d-none" alt="Poster preview" />
                            <div id="posterPlaceholder" class="media-placeholder">Chưa chọn ảnh</div>
                            <input type="file" name="posterFile" id="posterFile" accept="image/*"
                                   class="form-control movie-input file-input" required />
                            <div class="text-danger mt-1 d-none" id="posterRequiredMsg">Vui lòng chọn ảnh poster.</div>
                        </div>

                        <div class="media-card">
                            <div class="media-label">Banner</div>
                            <img id="bannerPreview" class="banner-img d-none" alt="Banner preview" />
                            <div id="bannerPlaceholder" class="media-placeholder">Chưa chọn ảnh</div>
                            <input type="file" name="bannerFile" id="bannerFile" accept="image/*"
                                   class="form-control movie-input file-input" required />
                            <div class="text-danger mt-1 d-none" id="bannerRequiredMsg">Vui lòng chọn ảnh banner.</div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    @await Html.PartialAsync("_ValidationScriptsPartial")

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script>
        function bindImagePreview(fileInputId, imgId, placeholderId) {
            const input = document.getElementById(fileInputId);
            const img = document.getElementById(imgId);
            const placeholder = placeholderId ? document.getElementById(placeholderId) : null;
            if (!input || !img) return;

            input.addEventListener('change', function () {
                const file = this.files && this.files[0];
                if (file) {
                    const url = URL.createObjectURL(file);
                    img.src = url;
                    img.classList.remove('d-none');
                    if (placeholder) placeholder.classList.add('d-none');
                } else {
                    img.src = '';
                    img.classList.add('d-none');
                    if (placeholder) placeholder.classList.remove('d-none');
                }
            });
        }

        function toggleMsg(id, show) {
            const el = document.getElementById(id);
            if (!el) return;
            el.classList.toggle('d-none', !show);
        }

        // =========================
        // CHỈ CHO NHẬP: chữ + khoảng trắng + dấu phẩy
        // =========================
        function sanitizeCommaNames(raw) {
            if (raw == null) return "";

            // 1) Xoá ký tự không hợp lệ: chỉ giữ chữ (Unicode), dấu chữ (combining marks), khoảng trắng, dấu phẩy
            //    - \p{L}: letter; \p{M}: marks (dấu tiếng Việt dạng tổ hợp); \s: whitespace
            let v = raw.replace(/[^\p{L}\p{M}\s,]/gu, "");

            // 2) Chuẩn hoá dấu phẩy: bỏ khoảng trắng thừa quanh dấu phẩy -> ", "
            v = v.replace(/\s*,\s*/g, ", ");

            // 3) Gộp nhiều dấu phẩy liên tiếp -> 1 dấu phẩy
            v = v.replace(/,{2,}/g, ",");

            // 4) Gộp nhiều space -> 1 space
            v = v.replace(/\s{2,}/g, " ");

            // 5) Không cho bắt đầu bằng dấu phẩy
            v = v.replace(/^\s*,+\s*/g, "");

            return v;
        }

        function isValidCommaNames(v) {
            // cho phép rỗng (user có thể không nhập thêm mới)
            const s = (v || "").trim();
            if (s.length === 0) return true;

            // không được kết thúc bằng dấu phẩy
            if (/,(\s*)$/.test(s)) return false;

            // tách theo dấu phẩy: mỗi token phải có ít nhất 1 chữ
            const parts = s.split(",").map(x => x.trim()).filter(x => x.length > 0);
            if (parts.length === 0) return false;

            // mỗi token phải có chữ (Unicode letter). (tránh token chỉ có space)
            for (const p of parts) {
                if (!/\p{L}/u.test(p)) return false;
            }
            return true;
        }

        function bindCommaNameInput(selector) {
            const el = document.querySelector(selector);
            if (!el) return;

            // chặn nhập/paste ký tự lạ bằng sanitize realtime
            el.addEventListener("input", function () {
                const cleaned = sanitizeCommaNames(this.value);
                if (this.value !== cleaned) this.value = cleaned;
            });

            el.addEventListener("paste", function () {
                // để paste xong mới sanitize
                setTimeout(() => {
                    const cleaned = sanitizeCommaNames(el.value);
                    if (el.value !== cleaned) el.value = cleaned;
                }, 0);
            });
        }

        $(document).ready(function () {
            function initMulti(selector, placeholder) {
                $(selector).select2({
                    placeholder: placeholder,
                    width: '100%',
                    closeOnSelect: false
                });
            }

            initMulti('#genresSelect', 'Chọn thể loại...');
            initMulti('#directorsSelect', 'Chọn đạo diễn...');
            initMulti('#actorsSelect', 'Chọn diễn viên...');

            bindImagePreview('posterFile', 'posterPreview', 'posterPlaceholder');
            bindImagePreview('bannerFile', 'bannerPreview', 'bannerPlaceholder');

            // áp dụng cho 2 ô thêm mới (CHỈ create)
            bindCommaNameInput('input[name="newDirectors"]');
            bindCommaNameInput('input[name="newActors"]');

            // --- SUPPRESS default unobtrusive/server validation messages FOR THIS FORM ONLY ---
            var $form = $('#movieCreateForm');

            // clear any server-rendered messages in this form
            $form.find('.field-validation-error, .field-validation-valid, .validation-summary-errors, .validation-summary-valid').text('');

            // get or init validator for this form and suppress default placements
            var validator = $form.data('validator') || $form.validate();
            if (validator) {
                validator.settings.errorPlacement = function () { /* prevent default message insertion */ };

                // custom showErrors: populate per-field data-valmsg-for spans in this form with Vietnamese messages
                validator.settings.showErrors = function (errorMap, errorList) {
                    var self = this;

                    // clear previous messages inside this form's data-valmsg-for spans
                    $($form).find('[data-valmsg-for]').each(function () {
                        $(this).text('');
                    });

                    // apply highlight/unhighlight as default would
                    if (self.settings.unhighlight) {
                        // unhighlight success elements
                        $.each(self.successList || [], function (i, el) {
                            try { self.settings.unhighlight.call(self, el, self.settings.errorClass, self.settings.validClass); } catch (e) { }
                        });
                    }

                    // add errors to spans
                    errorList = errorList || [];
                    $.each(errorList, function (i, err) {
                        var name = err.element.name || err.element.id;
                        if (!name) return;
                        var $span = $form.find('[data-valmsg-for="' + name + '"]');
                        if ($span.length) {
                            $span.text(err.message).removeClass('d-none');
                        } else {
                            // fallback: show in top summary if no span
                            // do nothing here; top summary handled elsewhere
                        }

                        // apply highlight for the element
                        try { if (self.settings.highlight) self.settings.highlight.call(self, err.element, self.settings.errorClass, self.settings.validClass); } catch (e) { }
                    });

                    // keep internal state
                    this.errorList = errorList || [];
                    this.errorMap = errorMap || {};
                };
            }

            // helper to show custom message inside the form for 3s
            function showFormMessage(msg) {
                var $msg = $('#customValidationMsg');
                $msg.text(msg).removeClass('d-none');
                clearTimeout($form.data('validationTimeout'));
                var t = setTimeout(function () { $msg.text(''); $msg.addClass('d-none');
                    // also clear per-field messages after timeout
                    $form.find('[data-valmsg-for]').each(function () { $(this).text(''); });
                }, 3000);
                $form.data('validationTimeout', t);
            }

            $form.on('submit', function (e) {
                // 1) Let unobtrusive validate run (but showErrors will place messages into spans in Vietnamese)
                var formValid = $form.valid();

                if (!formValid) {
                    e.preventDefault();

                    // determine if missing required values exist
                    var errorList = (validator && validator.errorList) || [];
                    var hasMissing = false;
                    for (var i = 0; i < errorList.length; i++) {
                        var el = errorList[i].element;
                        try {
                            if (el && el.validity && el.validity.valueMissing) { hasMissing = true; break; }
                        } catch (ex) { }
                    }

                    showFormMessage(hasMissing ? 'Vui lòng điền đủ thông tin' : 'Thông tin không hợp lệ');
                    return;
                }

                // 2) Validate riêng cho select2 multiple
                const genresOk = ($('#genresSelect').val() || []).length > 0;
                const directorsOk = ($('#directorsSelect').val() || []).length > 0;
                const actorsOk = ($('#actorsSelect').val() || []).length > 0;

                toggleMsg('genresRequiredMsg', !genresOk);
                toggleMsg('directorsRequiredMsg', !directorsOk);
                toggleMsg('actorsRequiredMsg', !actorsOk);

                // 3) Validate file bắt buộc
                const posterOk = ($('#posterFile')[0].files || []).length > 0;
                const bannerOk = ($('#bannerFile')[0].files || []).length > 0;

                toggleMsg('posterRequiredMsg', !posterOk);
                toggleMsg('bannerRequiredMsg', !bannerOk);

                // 4) Validate 2 ô thêm mới: chỉ chữ + space + dấu phẩy
                const nd = document.querySelector('input[name="newDirectors"]')?.value || "";
                const na = document.querySelector('input[name="newActors"]')?.value || "";

                const newDirectorsOk = isValidCommaNames(nd);
                const newActorsOk = isValidCommaNames(na);

                if (!newDirectorsOk || !newActorsOk) {
                    e.preventDefault();
                    showFormMessage('Thông tin không hợp lệ');
                    return;
                }

                if (!genresOk || !directorsOk || !actorsOk || !posterOk || !bannerOk) {
                    e.preventDefault();
                    showFormMessage('Vui lòng điền đủ thông tin');
                    toggleMsg('genresRequiredMsg', !genresOk);
                    toggleMsg('directorsRequiredMsg', !directorsOk);
                    toggleMsg('actorsRequiredMsg', !actorsOk);
                    toggleMsg('posterRequiredMsg', !posterOk);
                    toggleMsg('bannerRequiredMsg', !bannerOk);
                    return;
                }

                // otherwise allow submit to proceed (do not change original flow)
            });

            // Hide msg realtime
            $('#genresSelect').on('change', () => toggleMsg('genresRequiredMsg', ((($('#genresSelect').val() || []).length === 0))));
            $('#directorsSelect').on('change', () => toggleMsg('directorsRequiredMsg', ((($('#directorsSelect').val() || []).length === 0))));
            $('#actorsSelect').on('change', () => toggleMsg('actorsRequiredMsg', ((($('#actorsSelect').val() || []).length === 0))));
            $('#posterFile').on('change', () => toggleMsg('posterRequiredMsg', ((($('#posterFile')[0].files || []).length === 0))));
            $('#bannerFile').on('change', () => toggleMsg('bannerRequiredMsg', ((($('#bannerFile')[0].files || []).length === 0))));
        });
    </script>
}

