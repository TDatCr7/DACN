@model CinemaS.Models.Movies
@{
    ViewData["Title"] = "Cập nhật phim";
    Layout = "~/Views/Shared/_Layout.cshtml";

    var participants = (List<CinemaS.Models.Participants>)ViewBag.Participants ?? new();
    var selectedDir = ViewBag.CurrentDirectors as List<string> ?? new();
    var selectedAct = ViewBag.CurrentActors as List<string> ?? new();
    var genres = (List<CinemaS.Models.Genres>)ViewBag.Genres ?? new();
    var currentGenres = ViewBag.CurrentGenres as List<string> ?? new();
}

<style>
    .movie-edit-shell {
        max-width: 1200px;
        margin: 22px auto 40px;
    }

    .movie-edit-card {
        border-radius: 28px;
        background: radial-gradient(circle at 0 0, rgba(59,130,246,.40), transparent 55%), radial-gradient(circle at 100% 0, rgba(124,58,237,.35), transparent 55%), linear-gradient(145deg, #020617, #020617);
        border: 1px solid rgba(148,163,255,.55);
        box-shadow: 0 22px 60px rgba(15,23,42,.95), 0 0 0 1px rgba(15,23,42,.85);
        padding: 24px 26px 26px;
        color: #e5e7f5;
    }

    .movie-edit-title {
        font-size: 24px;
        font-weight: 800;
        margin-bottom: 18px;
    }

    .form-label {
        font-size: 13px;
        font-weight: 600;
        color: #c7d2fe;
    }

    .movie-input,
    .movie-select,
    .form-control,
    .form-select {
        background: radial-gradient(circle at 0 0, rgba(15,23,42,.96), rgba(2,6,23,1));
        border-radius: 14px;
        border: 1px solid rgba(148,163,255,.35);
        color: #e5e7f5;
        font-size: 14px;
    }

        .movie-input::placeholder {
            color: #6b7280;
            font-size: 13px;
        }

        .movie-input:focus,
        .movie-select:focus,
        .form-control:focus,
        .form-select:focus {
            background: radial-gradient(circle at 0 0, rgba(15,23,42,1), rgba(2,6,23,1));
            color: #e5e7f5;
            border-color: #3b82f6;
            box-shadow: 0 0 0 1px rgba(59,92,204,.7), 0 0 0 6px rgba(37,99,235,.35);
        }

        .movie-select option,
        .form-select option {
            background: #020617;
            color: #e5e7f5;
        }

    .movie-section-title {
        font-size: 16px;
        font-weight: 700;
        margin-top: 10px;
        margin-bottom: 6px;
    }

    .poster-thumb,
    .banner-thumb {
        max-height: 160px;
        border-radius: 14px;
        border: 1px solid rgba(148,163,255,.4);
        box-shadow: 0 12px 30px rgba(15,23,42,.8);
        object-fit: cover;
        width: 100%;
    }

    .movie-edit-actions .btn {
        border-radius: 999px;
        padding-inline: 22px;
    }

    .btn-gradient {
        background: linear-gradient(120deg, #3b5ccc, #7c3aed);
        border: none;
        color: #fff;
        font-weight: 700;
    }

        .btn-gradient:hover {
            filter: brightness(1.06);
            color: #fff;
        }

    .btn-outline-light {
        border-radius: 999px;
        padding-inline: 20px;
        border-color: rgba(148,163,255,.75);
        color: #e5e7ff;
        background: rgba(15,23,42,.9);
    }

        .btn-outline-light:hover {
            background: rgba(37,99,235,.9);
            border-color: rgba(129,140,248,1);
            color: #fff;
        }

    .text-danger {
        font-size: 12px;
    }

    @@media (max-width: 767.98px) {
        .movie-edit-card {
            padding-inline: 18px;
        }

        .movie-edit-actions {
            flex-direction: column;
            gap: 10px;
        }
    }

    /* ==== Select2 styling ==== */
    .select2-container--default .select2-selection--multiple,
    .select2-container--default .select2-selection--single {
        background: radial-gradient(circle at 0 0, rgba(15,23,42,.96), rgba(2,6,23,1));
        border-radius: 14px;
        border: 1px solid rgba(148,163,255,.35);
        min-height: 42px;
        padding: 2px 6px;
        color: #e5e7f5;
        font-size: 14px;
    }

        .select2-container--default .select2-selection--multiple .select2-selection__rendered {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        .select2-container--default .select2-selection--multiple .select2-selection__choice {
            background: linear-gradient(120deg, #2563eb, #7c3aed);
            border: none;
            border-radius: 999px;
            color: #f9fafb;
            padding: 2px 10px;
            font-size: 12px;
        }

        .select2-container--default .select2-selection--multiple .select2-selection__choice__remove {
            color: #e5e7f5;
            margin-right: 4px;
        }

    .select2-dropdown {
        background-color: #020617;
        border: 1px solid rgba(148,163,255,.35);
        border-radius: 14px;
        overflow: hidden;
    }

    .select2-search--dropdown .select2-search__field {
        background-color: #020617;
        border-radius: 999px;
        border: 1px solid rgba(148,163,255,.55);
        color: #e5e7f5;
        padding-inline: 10px;
        font-size: 13px;
    }

    .select2-results__option {
        padding: 6px 10px;
        font-size: 14px;
        color: #e5e7f5;
    }

    .select2-results__option--highlighted.select2-results__option--selectable {
        background: linear-gradient(120deg, #2563eb, #7c3aed);
        color: #fff;
    }
</style>

<div class="movie-edit-shell">
    <div class="movie-edit-card">
        <div class="movie-edit-title">@ViewData["Title"]</div>

        <form asp-action="Edit" enctype="multipart/form-data">
            @Html.AntiForgeryToken()
            <input type="hidden" asp-for="MoviesId" />
            <div asp-validation-summary="ModelOnly" class="text-danger mb-2"></div>

            <div class="row g-3">
                <div class="col-lg-8">
                    <div class="mb-2">
                        <label asp-for="Title" class="form-label">Tên phim</label>
                        <input asp-for="Title" class="form-control movie-input" />
                        <span asp-validation-for="Title" class="text-danger"></span>
                    </div>

                    <div class="row g-3">
                        <div class="col-md-4">
                            <label asp-for="ReleaseDate" class="form-label">Ngày phát hành</label>
                            <input asp-for="ReleaseDate" type="date" class="form-control movie-input" />
                        </div>
                        <div class="col-md-4">
                            <label asp-for="Duration" class="form-label">Thời lượng (phút)</label>
                            <input asp-for="Duration" class="form-control movie-input" />
                        </div>
                        <div class="col-md-4">
                            <label asp-for="Age" class="form-label">Độ tuổi</label>
                            <input asp-for="Age" class="form-control movie-input" />
                        </div>
                    </div>

                    <div class="mt-3">
                        <label asp-for="Summary" class="form-label">Tóm tắt</label>
                        <textarea asp-for="Summary" rows="3" class="form-control movie-input"></textarea>
                    </div>

                    <div class="mt-3">
                        <label asp-for="DetailDescription" class="form-label">Mô tả chi tiết</label>
                        <textarea asp-for="DetailDescription" rows="5" class="form-control movie-input"></textarea>
                    </div>

                    <div class="row g-3 mt-3">
                        <div class="col-md-4">
                            <label asp-for="Language" class="form-label">Ngôn ngữ</label>
                            <input asp-for="Language" class="form-control movie-input" />
                        </div>
                        <div class="col-md-4">
                            <label asp-for="Country" class="form-label">Quốc gia</label>
                            <input asp-for="Country" class="form-control movie-input" />
                        </div>
                        <div class="col-md-4">
                            <label asp-for="AudioOption" class="form-label">Âm thanh</label>
                            <input asp-for="AudioOption" class="form-control movie-input" />
                        </div>
                    </div>

                    <div class="row g-3 mt-3">
                        <div class="col-md-4">
                            <label asp-for="StatusId" class="form-label">Trạng thái</label>
                            <select asp-for="StatusId" asp-items="ViewBag.StatusId" class="form-select movie-select"></select>
                        </div>
                        <div class="col-md-4">
                            <label asp-for="Rating" class="form-label">Điểm IMDb /10</label>
                            <input asp-for="Rating" type="number" step="0.1" min="0" max="10" class="form-control movie-input" />
                        </div>
                        <div class="col-md-4">
                            <label asp-for="TrailerLink" class="form-label">Link trailer</label>
                            <input asp-for="TrailerLink" class="form-control movie-input" />
                        </div>
                    </div>

                    <!-- ===== Thể loại ===== -->
                    <hr class="mt-4 mb-3" />
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="movie-section-title mb-0">Thể loại</div>
                        <a asp-controller="Genres" asp-action="Index" class="btn btn-sm btn-outline-light">
                            <i class="fa-solid fa-layer-group me-1"></i> Quản lý thể loại
                        </a>
                    </div>

                    <label class="form-label mt-2">Chọn thể loại</label>
                    <select id="genresSelect"
                            name="selectedGenres"
                            class="form-select movie-input"
                            multiple="multiple">
                        @foreach (var g in genres)
                        {
                            <option value="@g.GenresId">@g.Name</option>
                        }
                    </select>

                    <!-- ===== Người tham gia (dropdown + search) ===== -->
                    <hr class="mt-4 mb-3" />
                    <div class="movie-section-title">Người tham gia</div>

                    <label class="form-label">Đạo diễn</label>
                    <select id="directorsSelect"
                            name="selectedDirectors"
                            class="form-select movie-input participant-select"
                            multiple="multiple">
                        @foreach (var p in participants)
                        {
                            var name = (p.NickName ?? p.BirthName) ?? p.ParticipantsId;
                            <option value="@p.ParticipantsId">@name</option>
                        }
                    </select>

                    <small class="form-label d-block mt-3">Thêm đạo diễn mới (cách nhau bằng dấu phẩy):</small>
                    <input type="text"
                           name="newDirectors"
                           class="form-control movie-input"
                           placeholder="Ví dụ: Christopher Nolan, Denis Villeneuve" />

                    <div class="mt-4">
                        <label class="form-label">Diễn viên</label>
                        <select id="actorsSelect"
                                name="selectedActors"
                                class="form-select movie-input participant-select"
                                multiple="multiple">
                            @foreach (var p in participants)
                            {
                                var name = (p.NickName ?? p.BirthName) ?? p.ParticipantsId;
                                <option value="@p.ParticipantsId">@name</option>
                            }
                        </select>

                        <small class="form-label d-block mt-3">Thêm diễn viên mới (cách nhau bằng dấu phẩy):</small>
                        <input type="text"
                               name="newActors"
                               class="form-control movie-input"
                               placeholder="Ví dụ: Tom Cruise, Emily Blunt" />
                    </div>

                </div>

                <div class="col-lg-4">
                    <div class="movie-section-title">Poster</div>
                    <div class="mb-3">
                        <img id="posterPreview"
                             src="@(!string.IsNullOrEmpty(Model.PosterImage) ? Model.PosterImage : "/images/no-poster.png")"
                             alt="Poster"
                             class="poster-thumb mb-2" />
                        <input type="file" name="posterFile" id="posterFile" accept="image/*" class="form-control movie-input" />
                    </div>

                    <div class="movie-section-title">Banner</div>
                    <div class="mb-3">
                        <img id="bannerPreview"
                             src="@(!string.IsNullOrEmpty(Model.BannerImage) ? Model.BannerImage : "/images/no-poster.png")"
                             alt="Banner"
                             class="banner-thumb mb-2" />
                        <input type="file" name="bannerFile" id="bannerFile" accept="image/*" class="form-control movie-input" />
                    </div>
                </div>
            </div>

            <div class="movie-edit-actions mt-4 d-flex justify-content-between align-items-center">
                <button type="button" class="btn btn-outline-light" onclick="history.back()">
                    <i class="fa-solid fa-arrow-left-long me-1"></i> Quay lại
                </button>
                <button type="submit" class="btn btn-gradient">
                    <i class="fa-solid fa-floppy-disk me-1"></i> Lưu thay đổi
                </button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script>
        function bindImagePreview(fileInputId, imgId) {
            const input = document.getElementById(fileInputId);
            const img = document.getElementById(imgId);
            if (!input || !img) return;

            input.addEventListener('change', function () {
                const file = this.files && this.files[0];
                if (file) {
                    const url = URL.createObjectURL(file);
                    img.src = url;
                }
            });
        }

        $(document).ready(function () {
            function initMulti(selector, placeholder) {
                $(selector).select2({
                    placeholder: placeholder,
                    width: '100%',
                    closeOnSelect: false
                });
            }

            initMulti('#genresSelect', 'Chọn thể loại...');
            initMulti('#directorsSelect', 'Chọn đạo diễn...');
            initMulti('#actorsSelect', 'Chọn diễn viên...');

            var initialGenres = '@string.Join(",", currentGenres)';
            var initialDirectors = '@string.Join(",", selectedDir)';
            var initialActors = '@string.Join(",", selectedAct)';

            if (initialGenres) {
                $('#genresSelect').val(initialGenres.split(',')).trigger('change');
            }
            if (initialDirectors) {
                $('#directorsSelect').val(initialDirectors.split(',')).trigger('change');
            }
            if (initialActors) {
                $('#actorsSelect').val(initialActors.split(',')).trigger('change');
            }

            bindImagePreview('posterFile', 'posterPreview');
            bindImagePreview('bannerFile', 'bannerPreview');
        });
    </script>
}
