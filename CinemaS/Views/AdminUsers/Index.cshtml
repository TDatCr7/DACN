@model IEnumerable<CinemaS.ViewModels.AdminUsers.AdminUserListItemVm>

@{
    Layout = "_Layout";
    ViewData["Title"] = "Quản lý tài khoản";

    var role = (ViewBag.Role as string) ?? "";
    var page = (int)(ViewBag.CurrentPage ?? 1);
    var totalPages = (int)(ViewBag.TotalPages ?? 1);
    var search = (ViewBag.Search as string) ?? "";
}

@if (TempData["Error"] != null)
{
    <div class="alert alert-danger" style="border-radius:14px;margin-bottom:12px;">
        @TempData["Error"]
    </div>
}

<div class="admin-shell">
    <div class="admin-panel">
        <div class="admin-heading">
            <h1>
                <i class="fa-solid fa-users"></i>
                Quản lý tài khoản
            </h1>
            <div class="tt-subnote">
                <i class="fa-solid fa-circle-info me-2"></i>
                <span>Thêm, xoá, sửa và phân quyền người dùng.</span>
            </div>
        </div>

        <div class="admin-toolbar">
            <form method="get"
                  class="admin-search-shell d-flex gap-2 align-items-center"
                  id="adminFilterForm">

                <!-- SEARCH -->
                <div class="input-group admin-search-compact">
                    <input type="text"
                           name="search"
                           class="form-control admin-search-input"
                           placeholder="Tìm theo tên, email, username"
                           value="@search" />
                    <button class="admin-search-btn" type="submit" title="Tìm kiếm">
                        <i class="fa-solid fa-magnifying-glass"></i>
                    </button>
                </div>

                <!-- ROLE FILTER (AUTO LOAD) -->
                <select name="role"
                        class="form-select admin-role-filter"
                        id="roleFilter">
                    <option value="" selected="@(string.IsNullOrEmpty(role))">Tất cả quyền</option>
                    <option value="Admin" selected="@(role == "Admin")">Admin</option>
                    <option value="User" selected="@(role == "User")">User</option>
                </select>

                <!-- reset page về 1 khi lọc -->
                <input type="hidden" name="page" value="1" />
            </form>


            <div class="d-flex gap-2">
                <a asp-controller="AdminUsers" asp-action="Create"
                   class="btn btn-primary btn-sweep px-3"
                   style="border-radius:999px; padding:9px 20px; font-size:14px; font-weight:700; white-space:nowrap;">
                    <i class="fa-solid fa-plus me-1"></i>
                    Thêm tài khoản
                </a>

                <a asp-controller="Admin" asp-action="Index"
                   class="btn btn-outline-light-rounded btn-sweep px-3"
                   style="border-radius:999px; padding:9px 20px; font-size:14px; font-weight:700; white-space:nowrap;">
                    <i class="fa-solid fa-arrow-left"></i> Quay lại
                </a>
            </div>
        </div>


        <div class="admin-table-wrap">
            <table class="table admin-table align-middle">
                <thead>
                    <tr>
                        <th><i class="fa-solid fa-id-card"></i>Họ tên</th>
                        <th><i class="fa-solid fa-envelope"></i>Email</th>
                        <th><i class="fa-solid fa-user-gear"></i>Role</th>
                        <th><i class="fa-solid fa-shield-halved"></i>Xác thực email</th>
                        <th style="width:150px;">
                            <i class="fa-solid fa-ellipsis-vertical"></i> Thao tác
                        </th>
                    </tr>
                </thead>

                <tbody>
                    @if (!Model.Any())
                    {
                        <tr>
                            <td colspan="5" class="text-center admin-text-muted py-4">
                                Không tìm thấy tài khoản nào.
                            </td>
                        </tr>
                    }
                    else
                    {
                        foreach (var u in Model)
                        {
                            <tr>
                                <td>@u.FullName</td>
                                <td>@u.Email</td>
                                <td>
                                    @if (u.Roles.Any())
                                    {
                                        foreach (var r in u.Roles)
                                        {
                                            <span class="badge-role">@r</span>
                                        }
                                    }
                                    else
                                    {
                                        <span class="admin-text-muted">Chưa gán</span>
                                    }
                                </td>
                                <td>
                                    @if (u.EmailConfirmed)
                                    {
                                        <span class="badge-email-ok">Đã xác thực</span>
                                    }
                                    else
                                    {
                                        <span class="badge-email-no">Chưa</span>
                                    }
                                </td>

                                <td class="text-end">
                                    <div class="admin-actions">
                                        <a asp-controller="AdminUsers" asp-action="Details" asp-route-id="@u.Id"
                                           class="admin-icon-btn" title="Xem chi tiết" aria-label="Xem chi tiết">
                                            <i class="fa-regular fa-eye"></i>
                                        </a>

                                        <a asp-controller="AdminUsers" asp-action="Edit" asp-route-id="@u.Id"
                                           class="admin-icon-btn" title="Chỉnh sửa" aria-label="Chỉnh sửa">
                                            <i class="fa-solid fa-pen"></i>
                                        </a>

                                        <form asp-controller="AdminUsers" asp-action="Delete" asp-route-id="@u.Id"
                                              method="post" class="m-0">
                                            @Html.AntiForgeryToken()
                                            <button type="submit"
                                                    class="admin-icon-btn admin-icon-btn-danger"
                                                    onclick="return confirm('Xoá tài khoản này?');"
                                                    title="Xoá" aria-label="Xoá">
                                                <i class="fa-solid fa-trash-can"></i>
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>

        @if (totalPages > 1)
        {
            <div class="cine-pager">
                <a class="cine-page-btn @(page <= 1 ? "is-disabled" : "")"
                   asp-controller="AdminUsers"
                   asp-action="Index"
                   asp-route-search="@search"
                   asp-route-role="@role"
                   asp-route-page="@(page - 1)">
                    <i class="fa-solid fa-chevron-left"></i>
                </a>

                @for (int p = 1; p <= totalPages; p++)
                {
                    <a class="cine-page-btn @(p == page ? "is-active" : "")"
                       asp-controller="AdminUsers"
                       asp-action="Index"
                       asp-route-search="@search"
                       asp-route-role="@role"
                       asp-route-page="@p">
                        @p
                    </a>
                }

                <a class="cine-page-btn @(page >= totalPages ? "is-disabled" : "")"
                   asp-controller="AdminUsers"
                   asp-action="Index"
                   asp-route-search="@search"
                   asp-route-role="@role"
                   asp-route-page="@(page + 1)">
                    <i class="fa-solid fa-chevron-right"></i>
                </a>
            </div>
        }
    </div>
</div>
@section Scripts {
    <script>
        (function () {
            const roleSelect = document.getElementById('roleFilter');
            const form = document.getElementById('adminFilterForm');

            if (!roleSelect || !form) return;

            roleSelect.addEventListener('change', function () {
                form.submit();
            });
        })();
    </script>
}

