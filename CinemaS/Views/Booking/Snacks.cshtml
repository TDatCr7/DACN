@{
    ViewData["Title"] = "Đặt đồ ăn";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<link rel="stylesheet" href="~/css/seat-selection.css" asp-append-version="true" />
<link rel="stylesheet" href="~/css/booking-modal.css" asp-append-version="true" />
<link rel="stylesheet" href="~/css/toast-notification.css" asp-append-version="true" />

<div class="container mt-4 mb-5">
    <!-- HEADER -->
    <div class="admin-booking-header" style="text-align:center;">
        <h2>
            <i class="fas fa-utensils"></i>
            Đặt đồ ăn & nước uống
        </h2>
        <p class="subtitle">
            <i class="fas fa-info-circle"></i>
            Chọn món và áp dụng mã khuyến mãi trước khi thanh toán.
        </p>
    </div>

    <!-- SNACK LIST -->
    <div class="snack-selection mt-3">
        <div class="snack-header">
            <h5 class="fw-bold mb-0">
                <i class="fas fa-utensils"></i>
                Danh sách đồ ăn
                <span id="snackCount" class="snack-badge-count"></span>
            </h5>
        </div>

        <div class="snack-content" id="snackContent" style="display:block;">
            <div class="row g-3 mt-2">
                @if (ViewBag.Snacks != null)
                {
                    foreach (var snack in ViewBag.Snacks)
                    {
                        <div class="col-6 col-md-3 col-lg-2">
                            <div class="snack-card">
                                <div class="snack-image">
                                    @if (!string.IsNullOrEmpty(snack.Image))
                                    {
                                        <img src="@snack.Image" alt="@snack.Name" onerror="this.src='/images/snacks/SnackCinema.jpg'">
                                    }
                                    else
                                    {
                                        <img src="/images/snacks/SnackCinema.jpg" alt="@snack.Name">
                                    }
                                </div>

                                <div class="snack-info">
                                    <h6 class="snack-name">@snack.Name</h6>
                                    <p class="snack-price">@snack.Price?.ToString("N0") đ</p>

                                    <div class="snack-control"
                                         data-snack-id="@snack.SnackId"
                                         data-price="@snack.Price"
                                         data-name="@snack.Name">

                                        <button type="button"
                                                class="btn-choose-snack"
                                                onclick="handleChooseSnack(this)">
                                            Chọn
                                        </button>

                                        <div class="quantity-control" style="display:none;">
                                            <button type="button"
                                                    class="quantity-btn-snack"
                                                    onclick="updateSnackCardQuantity(this,-1)">
                                                -
                                            </button>

                                            <input type="number" class="quantity-input-snack" value="1" readonly>

                                            <button type="button"
                                                    class="quantity-btn-snack"
                                                    onclick="updateSnackCardQuantity(this,1)">
                                                +
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="col-12">
                        <p style="text-align:center;color:#9ca3af;padding:40px 0;">
                            <i class="fas fa-shopping-basket" style="font-size:48px;margin-bottom:10px;display:block;"></i>
                            Hiện chưa có đồ ăn nào
                        </p>
                    </div>
                }
            </div>
        </div>
    </div>

    <!-- SUMMARY (GIỐNG ADMIN: có PROMO) -->
    <div class="booking-summary">
        <div class="booking-summary-grid booking-summary-grid-3">
            <!-- LEFT -->
            <div class="summary-left">
                <div class="snack-summary">
                    <div class="snack-summary-title">
                        <strong>Bắp nước đã chọn:</strong>
                        <span id="snackTotalInline">0 đ</span>
                    </div>

                    <div class="snack-summary-list" id="snackSummaryList">
                        <div class="snack-empty">Chưa chọn</div>
                    </div>
                </div>

                <div class="total-price">
                    <strong>Tạm tính:</strong>
                    <span id="subTotalPrice">0 đ</span>
                </div>
            </div>

            <!-- PROMO -->
            <div class="summary-right">
                <div class="promo-box promo-box-compact">
                    <div class="promo-row">
                        <div class="promo-left">
                            <strong>Mã giảm giá</strong>
                            <div class="promo-hint">Áp dụng trước khi tạo hoá đơn</div>
                        </div>

                        <div class="promo-right">
                            <input id="promoCodeInput" type="text" class="promo-input" placeholder="Nhập mã (VD: SALE10)" />
                            <button type="button" class="promo-btn" onclick="applyPromoBeforeInvoice()">Áp</button>
                            <button type="button" class="promo-btn promo-btn-danger" onclick="clearPromoBeforeInvoice()">Gỡ mã</button>
                        </div>
                    </div>

                    <div class="promo-meta">
                        <div class="promo-line">
                            <span>Chương trình:</span>
                            <span id="promoNameText">-</span>
                        </div>

                        <div class="promo-line">
                            <span>Giảm (%):</span>
                            <span id="promoPercentText">-</span>
                        </div>

                        <div class="promo-line">
                            <span>Giảm:</span>
                            <span id="promoDiscountText">0 đ</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ACTION -->
            <div class="booking-action-col">
                <div class="payable-card">
                    <div class="payable-row">
                        <strong>Phải trả:</strong>
                        <span id="totalPrice">0 đ</span>
                    </div>
                </div>

                <button id="btnOrder" class="btn-book" onclick="openOrderModal()" disabled>
                    <i class="fas fa-shopping-cart"></i> Đặt hàng
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ORDER MODAL -->
<div class="booking-modal-overlay" id="orderModalOverlay">
    <div class="booking-modal">
        <div class="booking-modal-header">
            <h3>Xác nhận đặt đồ ăn</h3>
        </div>

        <div class="booking-modal-body">
            <div class="booking-info-item">
                <span class="booking-info-label">Tổng số món:</span>
                <span class="booking-info-value" id="modalSnackCount">0</span>
            </div>

            <div id="modalSnacksList" style="margin-top:20px;"></div>

            <div class="booking-total" style="margin-top:20px;">
                <div class="booking-info-item">
                    <span class="booking-info-label">TỔNG CỘNG:</span>
                    <span class="booking-info-value" id="modalGrandTotal">0 đ</span>
                </div>

                <div class="booking-info-item" style="margin-top:10px;">
                    <span class="booking-info-label">PHẢI TRẢ:</span>
                    <span class="booking-info-value" id="modalPayableTotal">0 đ</span>
                </div>
            </div>
        </div>

        <div class="booking-modal-footer">
            <button class="booking-modal-btn booking-modal-btn-cancel" onclick="closeOrderModal()">
                <i class="fas fa-times"></i> Hủy
            </button>
            <button class="booking-modal-btn booking-modal-btn-confirm" onclick="confirmOrder()">
                <i class="fas fa-check"></i> Xác nhận
            </button>
        </div>
    </div>
</div>

<div class="booking-loading-overlay" id="bookingLoadingOverlay">
    <div class="booking-loading-content">
        <div class="booking-loading-spinner"></div>
        <div class="booking-loading-text">Đang xử lý...</div>
    </div>
</div>

<div class="booking-toast" id="bookingToast"></div>

@section Scripts {
    <style>
        .snack-control {
            margin-top: 8px;
        }

        .btn-choose-snack {
            background-color: #3b82f6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
            transition: background-color 0.2s;
        }

            .btn-choose-snack:hover {
                background-color: #2563eb;
            }

        .quantity-control {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 5px;
        }

        .quantity-btn-snack {
            background-color: #facc15;
            color: #1f2937;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .quantity-input-snack {
            width: 40px;
            height: 32px;
            text-align: center;
            border: 1px solid #4b5563;
            background-color: #374151;
            color: white;
            border-radius: 6px;
            -moz-appearance: textfield;
        }

            .quantity-input-snack::-webkit-outer-spin-button,
            .quantity-input-snack::-webkit-inner-spin-button {
                -webkit-appearance: none;
                margin: 0;
            }

        .snack-header {
            background-color: #1f2937;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 10px;
        }
    </style>

    <script>
        // =========================
        // STATE
        // =========================
        let selectedSnacks = [];

        let currentInvoiceId = null;
        let currentInvoiceAmount = 0;

        let currentBaseTotal = 0;     // tạm tính
        let currentPayableTotal = 0;  // phải trả

        let promoDraftCode = '';
        let promoApplied = false;
        let promoName = '';
        let promoPercent = null;
        let promoDiscountAmount = 0;

        // =========================
        // UI HELPERS
        // =========================
        function showBookingLoading(show) {
            const overlay = document.getElementById('bookingLoadingOverlay');
            if (!overlay) return;
            if (show) overlay.classList.add('show');
            else overlay.classList.remove('show');
        }

        function showBookingToast(message, type) {
            const toast = document.getElementById('bookingToast');
            if (!toast) return;
            toast.innerHTML = message;
            toast.className = 'booking-toast booking-toast-' + type + ' show';
            setTimeout(() => { toast.classList.remove('show'); }, 5000);
        }

        function formatVND(n) {
            return (n || 0).toLocaleString('vi-VN') + ' đ';
        }

        function setPromoUI(nameText, percentText, discountText, payableText) {
            const nameEl = document.getElementById('promoNameText');
            const percentEl = document.getElementById('promoPercentText');
            const discountEl = document.getElementById('promoDiscountText');
            const payableEl = document.getElementById('totalPrice');

            if (nameEl) nameEl.textContent = nameText;
            if (percentEl) percentEl.textContent = percentText;
            if (discountEl) discountEl.textContent = discountText;
            if (payableEl) payableEl.textContent = payableText;
        }

        function resetPromoState() {
            promoDraftCode = '';
            promoApplied = false;
            promoName = '';
            promoPercent = null;
            promoDiscountAmount = 0;

            setPromoUI('-', '-', formatVND(0), formatVND(currentBaseTotal));

            const input = document.getElementById('promoCodeInput');
            if (input) input.value = '';
        }

        function updateSnackCounter() {
            const totalQuantity = selectedSnacks.reduce((sum, s) => sum + (s.quantity || 1), 0);
            const countElement = document.getElementById('snackCount');
            if (!countElement) return;

            if (totalQuantity > 0) {
                countElement.textContent = `(${totalQuantity} món đã chọn)`;
                countElement.style.backgroundColor = '#364747';
                countElement.style.color = '#fff';
                countElement.style.marginLeft = '8px';
                countElement.style.fontSize = '13px';
                countElement.style.padding = '2px 8px';
                countElement.style.borderRadius = '12px';
            } else {
                countElement.textContent = '';
            }
        }

        function updateSummary() {
            const snackTotal = selectedSnacks.reduce((sum, s) => sum + (s.price * (s.quantity || 1)), 0);

            currentBaseTotal = snackTotal;
            currentPayableTotal = snackTotal;

            const subTotal = document.getElementById('subTotalPrice');
            if (subTotal) subTotal.textContent = formatVND(snackTotal);

            const snackInline = document.getElementById('snackTotalInline');
            if (snackInline) snackInline.textContent = formatVND(snackTotal);

            const list = document.getElementById('snackSummaryList');
            if (list) {
                if (selectedSnacks.length === 0) {
                    list.innerHTML = `<div class="snack-empty">Chưa chọn</div>`;
                } else {
                    list.innerHTML = selectedSnacks.map(s => `
                        <div class="snack-line">
                            <div class="snack-line-name">${s.name}</div>
                            <div class="snack-line-meta">x${s.quantity || 1}</div>
                            <div class="snack-line-price">${formatVND((s.price || 0) * (s.quantity || 1))}</div>
                        </div>
                    `).join('');
                }
            }

            const totalPrice = document.getElementById('totalPrice');
            if (totalPrice) totalPrice.textContent = formatVND(currentPayableTotal);

            const btnOrder = document.getElementById('btnOrder');
            if (btnOrder) btnOrder.disabled = selectedSnacks.length === 0;

            updateSnackCounter();

            if (promoApplied && promoDraftCode) revalidatePromoAfterAmountChanged();
            else setPromoUI('-', '-', formatVND(0), formatVND(currentBaseTotal));
        }

        // =========================
        // SNACK PICK
        // =========================
        window.handleChooseSnack = function (button) {
            const control = button.closest('.snack-control');
            if (!control) return;

            const snackId = control.dataset.snackId;
            const price = parseFloat(control.dataset.price) || 0;
            const name = control.dataset.name;

            selectedSnacks.push({ id: snackId, name, price, quantity: 1 });

            button.style.display = 'none';
            const qc = control.querySelector('.quantity-control');
            if (qc) qc.style.display = 'flex';

            const input = control.querySelector('.quantity-input-snack');
            if (input) input.value = 1;

            updateSummary();
        }

        window.updateSnackCardQuantity = function (button, change) {
            const control = button.closest('.snack-control');
            if (!control) return;

            const snackId = control.dataset.snackId;
            const input = control.querySelector('.quantity-input-snack');
            const currentQuantity = parseInt(input?.value || '1', 10);
            const newQuantity = currentQuantity + change;

            const snack = selectedSnacks.find(s => s.id === snackId);

            if (newQuantity <= 0) {
                selectedSnacks = selectedSnacks.filter(s => s.id !== snackId);

                const qc = control.querySelector('.quantity-control');
                if (qc) qc.style.display = 'none';

                const chooseBtn = control.querySelector('.btn-choose-snack');
                if (chooseBtn) chooseBtn.style.display = 'block';
            } else {
                if (snack) snack.quantity = newQuantity;
                if (input) input.value = newQuantity;
            }

            updateSummary();
        }

        // =========================
        // PROMO (USER) - BEFORE INVOICE
        // =========================
        async function applyPromoBeforeInvoice() {
            if (currentBaseTotal <= 0) {
                showBookingToast('⚠️ Vui lòng chọn đồ ăn trước.', 'error');
                return;
            }

            const code = (document.getElementById('promoCodeInput')?.value || '').trim();
            if (!code) {
                showBookingToast('⚠️ Vui lòng nhập mã giảm giá.', 'error');
                return;
            }

            showBookingLoading(true);
            try {
                // USER dùng cùng validate endpoint như admin (đang có)
                const vRes = await fetch('/Admin/ValidatePromotion', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code, amount: currentBaseTotal })
                });

                const vData = await vRes.json();
                if (!vData?.success) {
                    showBookingToast('❌ ' + (vData?.message || 'Mã không hợp lệ'), 'error');
                    return;
                }

                promoDraftCode = code;
                promoApplied = true;

                promoName = vData.promotionName || '-';
                promoPercent = (typeof vData.discountPercent === 'number') ? vData.discountPercent : null;
                promoDiscountAmount = vData.discountAmount || 0;

                currentPayableTotal = vData.totalAfterDiscount ?? currentBaseTotal;

                const percentText = (promoPercent === null) ? '-' : (promoPercent.toLocaleString('vi-VN') + '%');
                setPromoUI(
                    promoName,
                    percentText,
                    formatVND(promoDiscountAmount),
                    formatVND(currentPayableTotal)
                );

                showBookingToast('✅ ' + (vData.message || 'Đã áp mã'), 'success');
            } catch (e) {
                showBookingToast('❌ Lỗi: ' + (e?.message || e), 'error');
            } finally {
                showBookingLoading(false);
            }
        }

        async function revalidatePromoAfterAmountChanged() {
            const code = promoDraftCode;
            if (!code || currentBaseTotal <= 0) return;

            try {
                const vRes = await fetch('/Admin/ValidatePromotion', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code, amount: currentBaseTotal })
                });

                const vData = await vRes.json();
                if (!vData?.success) {
                    resetPromoState();
                    return;
                }

                promoName = vData.promotionName || '-';
                promoPercent = (typeof vData.discountPercent === 'number') ? vData.discountPercent : null;
                promoDiscountAmount = vData.discountAmount || 0;

                currentPayableTotal = vData.totalAfterDiscount ?? currentBaseTotal;

                const percentText = (promoPercent === null) ? '-' : (promoPercent.toLocaleString('vi-VN') + '%');
                setPromoUI(
                    promoName,
                    percentText,
                    formatVND(promoDiscountAmount),
                    formatVND(currentPayableTotal)
                );
            } catch (_) { }
        }

        function clearPromoBeforeInvoice() {
            resetPromoState();
            showBookingToast('✅ Đã gỡ mã.', 'success');
        }

        window.applyPromoBeforeInvoice = applyPromoBeforeInvoice;
        window.clearPromoBeforeInvoice = clearPromoBeforeInvoice;

        // =========================
        // ORDER MODAL
        // =========================
        window.openOrderModal = function () {
            if (selectedSnacks.length === 0) {
                showBookingToast('⚠️ Vui lòng chọn ít nhất 1 món!', 'error');
                return;
            }

            const snackTotal = selectedSnacks.reduce((sum, s) => sum + (s.price * (s.quantity || 1)), 0);
            const totalQuantity = selectedSnacks.reduce((sum, s) => sum + (s.quantity || 1), 0);

            const modalSnackCount = document.getElementById('modalSnackCount');
            if (modalSnackCount) modalSnackCount.textContent = totalQuantity + ' món';

            const snacksList = document.getElementById('modalSnacksList');
            if (snacksList) snacksList.innerHTML = '';

            selectedSnacks.forEach((snack, index) => {
                const snackDiv = document.createElement('div');
                snackDiv.className = 'snack-quantity-item';
                snackDiv.innerHTML = `
                    <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid rgba(255,255,255,0.1);">
                      <span style="color:#fff;flex:1;">${snack.name || 'Snack'}</span>
                      <div style="display:flex;align-items:center;gap:10px;">
                        <button type="button" class="quantity-btn" onclick="updateSnackQuantityInModal(${index},-1)"><i class="fas fa-minus"></i></button>
                        <input type="number" class="quantity-input" value="${snack.quantity}" min="1" max="10" readonly
                               style="width:50px;text-align:center;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);color:#fff;padding:5px;border-radius:5px;">
                        <button type="button" class="quantity-btn" onclick="updateSnackQuantityInModal(${index},1)"><i class="fas fa-plus"></i></button>
                        <span style="color:#22c55e;font-weight:bold;min-width:100px;text-align:right;">${formatVND(snack.price * (snack.quantity || 1))}</span>
                      </div>
                    </div>`;
                if (snacksList) snacksList.appendChild(snackDiv);
            });

            const grand = document.getElementById('modalGrandTotal');
            if (grand) grand.textContent = formatVND(snackTotal);

            const payable = document.getElementById('modalPayableTotal');
            if (payable) payable.textContent = formatVND(currentPayableTotal || snackTotal);

            const overlay = document.getElementById('orderModalOverlay');
            if (overlay) overlay.classList.add('show');
        };

        window.updateSnackQuantityInModal = function (index, change) {
            if (index < 0 || index >= selectedSnacks.length) return;

            const snack = selectedSnacks[index];
            const newQuantity = (snack.quantity || 1) + change;

            if (newQuantity < 1 || newQuantity > 10) {
                showBookingToast('⚠️ Số lượng từ 1-10!', 'error');
                return;
            }

            snack.quantity = newQuantity;

            const controls = document.querySelectorAll('.snack-control');
            controls.forEach(control => {
                if (control.dataset.snackId === snack.id) {
                    const input = control.querySelector('.quantity-input-snack');
                    if (input) input.value = newQuantity;
                }
            });

            updateSummary();
            openOrderModal();
        };

        window.closeOrderModal = function () {
            const overlay = document.getElementById('orderModalOverlay');
            if (overlay) overlay.classList.remove('show');
        };

        // =========================
        // CREATE INVOICE + APPLY PROMO (IF ANY) + PAY VNPAY
        // =========================
        window.confirmOrder = async function () {
            closeOrderModal();
            showBookingLoading(true);

            try {
                const snacksData = selectedSnacks.map(snack => ({
                    snackId: snack.id,
                    quantity: snack.quantity || 1
                }));

                // 1) Create invoice (pending)
                const bookRes = await fetch('/Booking/BookSnacks', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ snacks: snacksData })
                });

                const bookData = await bookRes.json();
                if (!bookData?.success) {
                    showBookingToast('❌ ' + (bookData?.message || 'Đặt hàng thất bại'), 'error');
                    return;
                }

                currentInvoiceId = bookData.invoiceId;
                currentBaseTotal = bookData.totalPrice || 0;

                // 2) If promo applied: apply to invoice
                currentPayableTotal = currentPayableTotal || currentBaseTotal;
                currentInvoiceAmount = currentPayableTotal;

                if (promoApplied && promoDraftCode) {
                    const aRes = await fetch('/Admin/ApplyPromotionToInvoice', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ invoiceId: currentInvoiceId, code: promoDraftCode })
                    });

                    const aData = await aRes.json();
                    if (aData?.success) {
                        currentPayableTotal = aData.totalAfterDiscount ?? currentBaseTotal;
                        currentInvoiceAmount = currentPayableTotal;

                        const percentText = (typeof aData.discountPercent === 'number')
                            ? (aData.discountPercent.toLocaleString('vi-VN') + '%')
                            : '-';

                        setPromoUI(
                            aData.promotionName || promoName || '-',
                            percentText,
                            formatVND(aData.discountAmount || 0),
                            formatVND(currentPayableTotal)
                        );
                    }
                }

                // 3) VNPay
                const payRes = await fetch('/Payment/Create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        orderId: currentInvoiceId,
                        amount: currentInvoiceAmount,
                        orderInfo: `Dat do an ${currentInvoiceId}`
                    })
                });

                const payData = await payRes.json();
                if (payData?.success && payData?.paymentUrl) {
                    window.location.href = payData.paymentUrl;
                    return;
                }

                showBookingToast('❌ Không tạo được URL thanh toán.', 'error');
            } catch (error) {
                showBookingToast('❌ Lỗi: ' + (error?.message || error), 'error');
            } finally {
                showBookingLoading(false);
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            updateSummary();
            resetPromoState();
        });
    </script>
}
