@model CinemaS.Models.ViewModels.SeatSelectionVM
@{
	ViewData["Title"] = "Ch·ªçn gh·∫ø";
	Layout = "~/Views/Shared/_Layout.cshtml";
}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<link rel="stylesheet" href="~/css/seat-selection.css" asp-append-version="true" />
<link rel="stylesheet" href="~/css/booking-modal.css" asp-append-version="true" />

<div class="seat-selection-container">
	<input type="hidden" id="showTimeId" value="@Model.ShowTimeId" />

	<!-- Th√¥ng tin phim -->
	<div class="movie-info">
		<div class="movie-poster">
			<img src="@Model.MoviePoster" alt="@Model.MovieTitle" />
		</div>
		<div class="movie-details">
			<h2>@Model.MovieTitle</h2>
			<p><i class="fas fa-door-open"></i> <strong>Ph√≤ng:</strong> @Model.CinemaTheaterName</p>
			<p><i class="fas fa-calendar"></i> <strong>Ng√†y:</strong> @Model.ShowDate?.ToString("dd/MM/yyyy")</p>
			<p><i class="fas fa-clock"></i> <strong>Gi·ªù:</strong> @Model.StartTime?.ToString("HH:mm")</p>
		</div>
	</div>

	<!-- M√†n h√¨nh -->
	<div class="screen-container">
		<div class="screen">M√ÄN H√åNH</div>
	</div>

	<!-- S∆° ƒë·ªì gh·∫ø -->
	<div class="seats-grid-container">
		<!-- S·ªë c·ªôt (1-14) -->
		<div class="column-numbers">
			<div class="row-label-space"></div>
			@for (int col = 1; col <= Model.NumOfColumns; col++)
			{
				<div class="column-number">@col</div>
			}
		</div>

		<!-- C√°c h√†ng gh·∫ø -->
		@{
			var rows = Model.Seats.GroupBy(s => s.RowIndex).OrderBy(g => g.Key);
		}

		@foreach (var row in rows)
		{
			<div class="seat-row">
				<!-- K√Ω hi·ªáu h√†ng -->
				<div class="row-label">@row.Key</div>

				<!-- Gh·∫ø trong h√†ng -->
				<div class="seats-in-row">
					@{
						var seatsInRow = row.OrderBy(s => s.ColumnIndex).ToList();
						var isCoupleSeat = seatsInRow.FirstOrDefault()?.IsCouple ?? false;
					}

					@if (isCoupleSeat)
					{
						<!-- Gh·∫ø ƒë√¥i: hi·ªÉn th·ªã theo c·∫∑p -->
						for (int i = 0; i < seatsInRow.Count; i += 2)
						{
							var seat1 = seatsInRow[i];
							var seat2 = i + 1 < seatsInRow.Count ? seatsInRow[i + 1] : null;
							var combinedSeatIds = seat2 != null ? $"{seat1.SeatId},{seat2.SeatId}" : seat1.SeatId;
							var combinedLabels = seat2 != null ? $"{seat1.Label}-{seat2.Label}" : seat1.Label;
							var totalPrice = (seat1.SeatTypePrice ?? 0) + (seat2?.SeatTypePrice ?? 0);

							<div class="couple-seat-wrapper @(seat1.Status == "Booked" || seat2?.Status == "Booked" ? "booked" : "")"
								 data-seat-id="@combinedSeatIds"
								 data-seat-type="@seat1.SeatTypeId"
								 data-seat-price="@totalPrice"
								 data-seat-label="@combinedLabels"
								 data-is-couple="true"
								 onclick="toggleSeat(this)">
								<div class="couple-seat">
									<span class="seat-badge">CP</span>
									<div class="user-icons" style="display:none;">
										<img src="~/images/user.png" alt="user" class="user-icon" />
										<img src="~/images/user.png" alt="user" class="user-icon" />
									</div>
								</div>
								<div class="couple-seat-label">@combinedLabels</div>
							</div>
						}
					}
					else
					{
						<!-- Gh·∫ø th∆∞·ªùng/VIP -->
						foreach (var seat in seatsInRow)
						{
							var seatClass = seat.Status == "Booked" ? "booked" : "";
							seatClass += seat.IsVIP ? " vip" : " normal";

							<div class="seat @seatClass"
								 data-seat-id="@seat.SeatId"
								 data-seat-type="@seat.SeatTypeId"
								 data-seat-price="@(seat.SeatTypePrice ?? 0)"
								 data-seat-label="@seat.Label"
								 data-is-couple="false"
								 onclick="toggleSeat(this)">
								@if (seat.IsVIP)
								{
									<span class="seat-badge">V</span>
								}
								<div class="user-icon-wrapper" style="display:none;">
									<img src="~/images/user.png" alt="user" class="user-icon" />
								</div>
							</div>
						}
					}
				</div>

				<!-- K√Ω hi·ªáu h√†ng b√™n ph·∫£i -->
				<div class="row-label">@row.Key</div>
			</div>
		}
	</div>

	<!-- Ch√∫ th√≠ch -->
	<div class="legend">
		<div class="legend-title">
			<i class="fas fa-info-circle"></i> Ch√∫ Th√≠ch
		</div>
		<div class="legend-items">
			<div class="legend-item">
				<div class="seat normal"></div>
				<span>Gh·∫ø Tr·ªëng</span>
			</div>
			<div class="legend-item">
				<div class="seat normal selected">
					<img src="~/images/user.png" alt="user" class="user-icon" />
				</div>
				<span>ƒêang Ch·ªçn</span>
			</div>
			<div class="legend-item">
				<div class="seat booked"></div>
				<span>ƒê√£ ƒê·∫∑t</span>
			</div>
			<div class="legend-item">
				<div class="seat normal"><span class="seat-badge" style="background:red;">‚úó</span></div>
				<span>Gh·∫ø H·ªèng</span>
			</div>
			<div class="legend-item">
				<div class="seat vip"><span class="seat-badge">V</span></div>
				<span>Gh·∫ø VIP</span>
			</div>
			<div class="legend-item">
				<div class="couple-seat-wrapper">
					<div class="couple-seat"><span class="seat-badge">CP</span></div>
				</div>
				<span>Gh·∫ø ƒê√¥i</span>
			</div>
		</div>
	</div>

	<!-- Ch·ªçn ƒë·ªì ƒÉn k√®m - Collapsible -->
	<div class="snack-selection mt-4">
		<div class="snack-header" onclick="toggleSnackSection()">
			<h5 class="fw-bold mb-0">
				<i class="fas fa-utensils"></i> Ch·ªçn ƒë·ªì ƒÉn k√®m
			</h5>
			<button type="button" class="btn-collapse" id="snackToggleBtn">
				<i class="fas fa-chevron-down"></i>
			</button>
		</div>
		
		<div class="snack-content" id="snackContent" style="display: none;">
			<div class="row g-3 mt-2">
				@if (ViewBag.Snacks != null)
				{
					@foreach (var snack in ViewBag.Snacks)
					{
						<div class="col-6 col-md-3 col-lg-2">
							<div class="snack-card">
								<div class="snack-image">
									@if (!string.IsNullOrEmpty(snack.Image))
									{
										<img src="@snack.Image" alt="@snack.Name" onerror="this.src='/images/snacks/SnackCinema.jpg'">
									}
									else
									{
										<img src="/images/snacks/SnackCinema.jpg" alt="@snack.Name">
									}
								</div>
								<div class="snack-info">
									<h6 class="snack-name">@snack.Name</h6>
									<p class="snack-price">@snack.Price?.ToString("N0") ƒë</p>
									<label class="snack-checkbox-wrapper">
										<input class="snack-checkbox" 
											type="checkbox" 
											   value="@snack.SnackId" 
											   data-price="@snack.Price" 
											   id="snack-@snack.SnackId">
										<span class="checkmark">Ch·ªçn</span>
									</label>
								</div>
							</div>
						</div>
					}
				}
			</div>
		</div>
	</div>

	<!-- Th√¥ng tin ƒë·∫∑t v√© -->
	<div class="booking-summary">
		<div class="summary-content">
			<div class="selected-info">
				<strong>Gh·∫ø ƒë√£ ch·ªçn:</strong> <span id="selectedSeats">Ch∆∞a ch·ªçn</span>
			</div>
			<div class="total-price">
				<strong>T·ªïng ti·ªÅn:</strong> <span id="totalPrice">0 ƒë</span>
			</div>
		</div>
		<button id="btnBook" class="btn-book" onclick="openBookingModal()" disabled>
			<i class="fas fa-ticket-alt"></i> ƒê·∫∑t v√©
		</button>
	</div>
</div>

<!-- ===== BOOKING MODAL ===== -->
<div class="booking-modal-overlay" id="bookingModalOverlay">
	<div class="booking-modal">
		<div class="booking-modal-header">
			<div class="icon">üé¨</div>
			<h3>X√°c nh·∫≠n ƒë·∫∑t v√©</h3>
		</div>
		<div class="booking-modal-body">
			<!-- Th√¥ng tin gh·∫ø -->
			<div class="booking-info-item">
				<span class="booking-info-label">S·ªë gh·∫ø:</span>
				<span class="booking-info-value" id="modalSeatCount">0</span>
			</div>
			<div class="booking-info-item">
				<span class="booking-info-label">Gh·∫ø ƒë√£ ch·ªçn:</span>
				<span class="booking-info-value" id="modalSeatLabels">-</span>
			</div>
			<div class="booking-info-item">
				<span class="booking-info-label">Ti·ªÅn gh·∫ø:</span>
				<span class="booking-info-value" id="modalSeatTotal">0 ƒë</span>
			</div>

			<!-- Danh s√°ch snacks v·ªõi input s·ªë l∆∞·ª£ng -->
			<div id="modalSnacksList" style="margin-top: 20px;">
				<!-- S·∫Ω ƒë∆∞·ª£c ƒëi·ªÅn b·∫±ng JavaScript -->
			</div>

			<!-- T·ªïng ti·ªÅn snacks -->
			<div class="booking-info-item" style="margin-top: 10px;">
				<span class="booking-info-label">Ti·ªÅn ƒë·ªì ƒÉn:</span>
				<span class="booking-info-value" id="modalSnackTotal">0 ƒë</span>
			</div>

			<!-- T·ªïng c·ªông -->
			<div class="booking-total">
				<div class="booking-info-item">
					<span class="booking-info-label">T·ªîNG C·ªòNG:</span>
					<span class="booking-info-value" id="modalGrandTotal">0 ƒë</span>
				</div>
			</div>
		</div>
		<div class="booking-modal-footer">
			<button class="booking-modal-btn booking-modal-btn-cancel" onclick="closeBookingModal()">
				<i class="fas fa-times"></i> H·ªßy
			</button>
			<button class="booking-modal-btn booking-modal-btn-confirm" onclick="confirmBooking()">
				<i class="fas fa-check"></i> X√°c nh·∫≠n
			</button>
		</div>
	</div>
</div>

<!-- ===== LOADING OVERLAY ===== -->
<div class="booking-loading-overlay" id="bookingLoadingOverlay">
	<div class="booking-loading-content">
		<div class="booking-loading-spinner"></div>
		<div class="booking-loading-text">ƒêang x·ª≠ l√Ω ƒë·∫∑t v√©...</div>
	</div>
</div>

<!-- ===== TOAST NOTIFICATION ===== -->
<div class="booking-toast" id="bookingToast"></div>

@section Scripts {
	<script src="~/js/seat-selection.js" asp-append-version="true"></script>
	<script>
        // ‚úÖ Kh·ªüi t·∫°o bi·∫øn to√†n c·ª•c
  const showTimeId = '@Model.ShowTimeId';
  let selectedSnacks = [];

    // ===== MODAL FUNCTIONS =====
 
        // M·ªü modal x√°c nh·∫≠n
        window.openBookingModal = function() {
     if (selectedSeats.length === 0) {
   showBookingToast('‚ö†Ô∏è Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 gh·∫ø!', 'error');
      return;
        }

    // T√≠nh to√°n
          const seatTotal = selectedSeats.reduce((sum, s) => sum + s.price, 0);
    const snackTotal = selectedSnacks.reduce((sum, s) => sum + (s.price * s.quantity), 0);
     const grandTotal = seatTotal + snackTotal;
     const seatLabels = selectedSeats.map(s => s.label).join(', ');

      // ƒêi·ªÅn d·ªØ li·ªáu gh·∫ø v√†o modal
  document.getElementById('modalSeatCount').textContent = selectedSeats.length + ' gh·∫ø';
      document.getElementById('modalSeatLabels').textContent = seatLabels;
  document.getElementById('modalSeatTotal').textContent = seatTotal.toLocaleString('vi-VN') + ' ƒë';

     // ‚úÖ Hi·ªÉn th·ªã danh s√°ch snacks v·ªõi input s·ªë l∆∞·ª£ng
            const snacksList = document.getElementById('modalSnacksList');
    snacksList.innerHTML = '';

  if (selectedSnacks.length > 0) {
  selectedSnacks.forEach((snack, index) => {
    const snackDiv = document.createElement('div');
   snackDiv.className = 'snack-quantity-item';
    snackDiv.innerHTML = `
    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
  <span style="color: #fff; flex: 1;">${snack.name || 'Snack'}</span>
           <div style="display: flex; align-items: center; gap: 10px;">
      <button type="button" class="quantity-btn" onclick="updateSnackQuantity(${index}, -1)">
 <i class="fas fa-minus"></i>
        </button>
  <input type="number" 
          class="quantity-input" 
         value="${snack.quantity}" 
     min="1" 
  max="10"
         readonly
 style="width: 50px; text-align: center; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: #fff; padding: 5px; border-radius: 5px;">
      <button type="button" class="quantity-btn" onclick="updateSnackQuantity(${index}, 1)">
           <i class="fas fa-plus"></i>
      </button>
   <span style="color: #22c55e; font-weight: bold; min-width: 100px; text-align: right;">
           ${(snack.price * snack.quantity).toLocaleString('vi-VN')} ƒë
  </span>
           </div>
 </div>
   `;
         snacksList.appendChild(snackDiv);
     });
      } else {
         snacksList.innerHTML = '<p style="color: #9ca3af; text-align: center; padding: 10px 0;">Ch∆∞a ch·ªçn ƒë·ªì ƒÉn</p>';
    }

   // C·∫≠p nh·∫≠t t·ªïng ti·ªÅn
       document.getElementById('modalSnackTotal').textContent = snackTotal.toLocaleString('vi-VN') + ' ƒë';
     document.getElementById('modalGrandTotal').textContent = grandTotal.toLocaleString('vi-VN') + ' ƒë';

    // Hi·ªÉn th·ªã modal
     document.getElementById('bookingModalOverlay').classList.add('show');
};

 // ‚úÖ H√†m c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng snack
        window.updateSnackQuantity = function(index, change) {
   if (index < 0 || index >= selectedSnacks.length) return;

    const snack = selectedSnacks[index];
  const newQuantity = snack.quantity + change;

    if (newQuantity < 1 || newQuantity > 10) {
        showBookingToast('‚ö†Ô∏è S·ªë l∆∞·ª£ng t·ª´ 1-10!', 'error');
       return;
 }

      snack.quantity = newQuantity;

  // C·∫≠p nh·∫≠t l·∫°i modal
   openBookingModal();
        };

        // ƒê√≥ng modal
        window.closeBookingModal = function() {
            document.getElementById('bookingModalOverlay').classList.remove('show');
        };

        // X√°c nh·∫≠n ƒë·∫∑t v√©
      window.confirmBooking = async function() {
     closeBookingModal();
       showBookingLoading(true);

      try {
   // L·∫•y t·∫•t c·∫£ seatIds
 const allSeatIds = [];
     selectedSeats.forEach(seat => {
       const ids = seat.id.split(',');
      allSeatIds.push(...ids);
      });

   // ‚úÖ Chu·∫©n b·ªã d·ªØ li·ªáu snacks v·ªõi quantity
     const snacksData = selectedSnacks.map(snack => ({
    snackId: snack.id,
        quantity: snack.quantity || 1 // ‚úÖ L·∫•y quantity t·ª´ modal
    }));


  const response = await fetch('/Booking/BookSeats', {
        method: 'POST',
          headers: {
   'Content-Type': 'application/json',
    },
       body: JSON.stringify({
  showTimeId: showTimeId,
  seatIds: allSeatIds,
    snacks: snacksData
  })
});

       const result = await response.json();

   if (result.success) {
           showBookingToast('‚úÖ ƒê·∫∑t v√© th√†nh c√¥ng! T·ªïng ti·ªÅn: ' + result.totalPrice.toLocaleString('vi-VN') + ' ƒë', 'success');
      
   // ƒê√°nh d·∫•u gh·∫ø ƒë√£ ƒë·∫∑t
   document.querySelectorAll('.seat.selected, .couple-seat-wrapper.selected').forEach(el => {
  el.classList.remove('selected');
            el.classList.add('booked');
        el.onclick = null;
      
     const userIcons = el.querySelectorAll('.user-icon-wrapper, .user-icons');
 userIcons.forEach(icon => icon.style.display = 'none');
        });

     // Reset
     selectedSeats = [];
  selectedSnacks = [];
           updateSummary();

         // Reload sau 3s
   setTimeout(() => {
   window.location.reload();
      }, 3000);
  } else {
  showBookingToast('‚ùå ' + result.message, 'error');
   }
            } catch (error) {
      showBookingToast('‚ùå L·ªói: ' + error.message, 'error');
    } finally {
  showBookingLoading(false);
     }
      };

        // Hi·ªÉn th·ªã loading
        function showBookingLoading(show) {
       const overlay = document.getElementById('bookingLoadingOverlay');
            if (show) {
 overlay.classList.add('show');
   } else {
         overlay.classList.remove('show');
   }
        }

        // Hi·ªÉn th·ªã toast
        function showBookingToast(message, type) {
            const toast = document.getElementById('bookingToast');
        toast.textContent = message;
   toast.className = 'booking-toast booking-toast-' + type + ' show';

    setTimeout(() => {
                toast.classList.remove('show');
        }, 5000);
      }

        // ===== SNACK SECTION =====
  
        window.toggleSnackSection = function() {
        const content = document.getElementById('snackContent');
            const btn = document.getElementById('snackToggleBtn');
      const icon = btn.querySelector('i');
 
     if (content.style.display === 'none') {
 content.style.display = 'block';
     icon.classList.remove('fa-chevron-down');
      icon.classList.add('fa-chevron-up');
          } else {
       content.style.display = 'none';
      icon.classList.remove('fa-chevron-up');
         icon.classList.add('fa-chevron-down');
   }
        };

        document.querySelectorAll('.snack-checkbox').forEach(checkbox => {
  checkbox.addEventListener('change', () => {
    const snackId = checkbox.value;
          const price = parseFloat(checkbox.getAttribute('data-price'));
       const name = checkbox.closest('.snack-card').querySelector('.snack-name').textContent;
  
          if (checkbox.checked) {
       selectedSnacks.push({ 
         id: snackId, 
 price: price,
       name: name,
 quantity: 1 // ‚úÖ M·∫∑c ƒë·ªãnh s·ªë l∆∞·ª£ng = 1
     });
             } else {
   selectedSnacks = selectedSnacks.filter(s => s.id !== snackId);
  }
     updateSummary();
  });
        });

    // ===== TOGGLE SEAT =====
 
        window.toggleSeat = function(element) {
  if (element.classList.contains('booked')) {
   showBookingToast('‚ö†Ô∏è Gh·∫ø n√†y ƒë√£ ƒë∆∞·ª£c ƒë·∫∑t!', 'error');
    return;
 }

         const seatIds = element.getAttribute('data-seat-id').split(',');
        const price = parseFloat(element.getAttribute('data-seat-price'));
            const label = element.getAttribute('data-seat-label');
            const isCouple = element.getAttribute('data-is-couple') === 'true';

            if (element.classList.contains('selected')) {
      element.classList.remove('selected');
   
        if (isCouple) {
        const userIcons = element.querySelector('.user-icons');
  if (userIcons) userIcons.style.display = 'none';
                } else {
              const userIcon = element.querySelector('.user-icon-wrapper');
   if (userIcon) userIcon.style.display = 'none';
                }

        if (isCouple) {
       const combinedId = seatIds.join(',');
         selectedSeats = selectedSeats.filter(s => s.id !== combinedId);
   } else {
        selectedSeats = selectedSeats.filter(s => !seatIds.includes(s.id));
         }
            } else {
      element.classList.add('selected');
           
         if (isCouple) {
         const userIcons = element.querySelector('.user-icons');
       if (userIcons) userIcons.style.display = 'flex';
         } else {
          const userIcon = element.querySelector('.user-icon-wrapper');
    if (userIcon) userIcon.style.display = 'flex';
             }

    selectedSeats.push({
         id: seatIds.join(','),
    label: label,
         price: price,
        isCouple: isCouple
      });
   }

            updateSummary();
    };

   // ‚úÖ T·ª± ƒë·ªông refresh tr·∫°ng th√°i gh·∫ø m·ªói 10 gi√¢y
        setInterval(async () => {
 await refreshSeatsStatus();
        }, 10000);
    </script>
}
