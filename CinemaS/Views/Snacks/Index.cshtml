@model IEnumerable<CinemaS.Models.Snacks>

@{
	ViewData["Title"] = "Quản lý Đồ Ăn";
	Layout = "~/Views/Shared/_Layout.cshtml";
}

<link rel="stylesheet" href="~/css/management.css" />
<link rel="stylesheet" href="~/css/Snacks.css" />

<style>
    /* Modal xác nhận xóa */
    #deleteModal {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: #fff;
        border: 1px solid #ccc;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        padding: 20px;
        z-index: 1051;
        min-width: 400px;
    }
    #deleteModal .modal-header {
        font-weight: bold;
        margin-bottom: 10px;
        color: black;
    }
    #deleteModal .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 20px;
    }
    #deleteModal .modal-body {
        margin-bottom: 15px;
        color: black;
    }
    .modal-backdrop-custom {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1050;
    }
</style>

<div class="container-fluid mt-4">
	<!-- Header -->
	<div class="d-flex justify-content-between align-items-center mb-4">
		<h1 class="fw-bold">
			<i class="fas fa-utensils"></i> Quản lý Đồ Ăn
		</h1>
		<div class="d-flex gap-2">
			<a asp-action="Create" class="btn btn-primary btn-sweep px-3" style="border-radius:999px; padding:9px 20px; font-size:14px; font-weight:700; white-space:nowrap;">
				<i class="fa-solid fa-plus me-1"></i> Tạo mới
			</a>
			<a asp-controller="Admin" asp-action="Index" class="btn btn-outline-light-rounded btn-sweep px-3" style="border-radius:999px; padding:9px 20px; font-size:14px; font-weight:700; white-space:nowrap;">
				<i class="fa-solid fa-arrow-left"></i> Quay lại
			</a>
		</div>
	</div>

	<!-- Alerts -->
	@if (TempData["Message"] != null)
	{
		<div class="alert alert-success alert-dismissible fade show" role="alert">
			<i class="fas fa-check-circle"></i> @TempData["Message"]
			<button type="button" class="btn-close" data-bs-dismiss="alert"></button>
		</div>
	}
	@if (TempData["Warning"] != null)
	{
		<div class="alert alert-warning alert-dismissible fade show" role="alert">
			<i class="fas fa-exclamation-triangle"></i> @TempData["Warning"]
			<button type="button" class="btn-close" data-bs-dismiss="alert"></button>
		</div>
	}
	@if (TempData["Error"] != null)
	{
		<div class="alert alert-danger alert-dismissible fade show" role="alert">
			<i class="fas fa-times-circle"></i> @TempData["Error"]
			<button type="button" class="btn-close" data-bs-dismiss="alert"></button>
		</div>
	}

	<!-- Search -->
		<div class="admin-toolbar">
            <form method="get"
                  class="admin-search-shell d-flex gap-2 align-items-center"
                  id="adminFilterForm">

                <div class="input-group admin-search-compact">
                    <input type="text"
                           name="searchString"
                           class="form-control admin-search-input"
                           placeholder="Tìm theo tên, mã hoặc mô tả..."
                           value="@ViewData["CurrentFilter"]" />
                    <button class="admin-search-btn" type="submit">
                        <i class="fas fa-search"></i>
                    </button>
                </div>

            </form>
        </div>

	<!-- Table - sử dụng admin-table-wrap và admin-table -->
	<div class="admin-table-wrap">
		<table class="table admin-table align-middle">
			<thead>
				<tr>
					<th><i class="fa-solid fa-hashtag"></i>STT</th>
					<th><i class="fa-solid fa-image"></i>Ảnh</th>
					<th><i class="fa-solid fa-tag"></i>Mã</th>
					<th><i class="fa-solid fa-utensils"></i>Tên</th>
					<th><i class="fa-solid fa-money-bill"></i>Giá (VNĐ)</th>
					<th><i class="fa-solid fa-align-left"></i>Mô tả</th>
					<th><i class="fa-solid fa-toggle-on"></i>Trạng thái</th>
					<th style="text-align:right;"><i class="fa-solid fa-ellipsis-vertical"></i>Hành động</th>
				</tr>
			</thead>
			<tbody>
				@if (Model != null && Model.Any())
				{
					int index = 1;
					foreach (var item in Model)
					{
						<tr>
							<td class="text-center fw-bold">@index</td>
							<td class="text-center">
								<img src="@(string.IsNullOrEmpty(item.Image) ? "/images/snacks/default-snack.png" : item.Image)"
									 alt="@item.Name" class="rounded snack-image shadow-sm" />
							</td>
							<td><strong>@item.SnackId</strong></td>
							<td>@item.Name</td>
							<td class="text-end fw-semibold" style="color: #fbbf24;">
								@(item.Price.HasValue ? item.Price.Value.ToString("N0") : "Chưa định giá")
							</td>
							<td class="admin-text-muted">
								@(string.IsNullOrEmpty(item.Description)
									? "Không có mô tả"
									: (item.Description.Length > 50
										? item.Description.Substring(0, 50) + "..."
										: item.Description))
							</td>
							<td>
								@if (item.IsActive == true)
								{
									<span class="badge-email-ok"><i class="fas fa-check"></i> Đang bán</span>
								}
								else
								{
									<span class="badge-email-no"><i class="fas fa-ban"></i> Ngừng bán</span>
								}
							</td>
							<td class="text-end">
								<a asp-action="Edit" asp-route-id="@item.SnackId" 
								   class="admin-icon-btn" title="Chỉnh sửa">
									<i class="fa-solid fa-pen"></i>
								</a>
								<button type="button"
								        class="admin-icon-btn admin-icon-btn-danger" 
								        title="Xóa"
								        onclick="showDeletePopup('@item.SnackId', '@item.Name')">
									<i class="fa-solid fa-trash-can"></i>
								</button>
							</td>
						</tr>
						index++;
					}
				}
				else
				{
					<tr>
						<td colspan="8" class="text-center admin-text-muted py-4">
							<i class="fas fa-inbox fa-3x mb-3 d-block"></i>
							<strong>Không tìm thấy đồ ăn nào</strong>
							@if (!string.IsNullOrEmpty(ViewData["CurrentFilter"]?.ToString()))
							{
								<p class="mb-0">với từ khóa "<strong>@ViewData["CurrentFilter"]</strong>"</p>
							}
						</td>
					</tr>
				}
			</tbody>
		</table>
	</div>
</div>

<!-- Modal Xác nhận xóa -->
<div class="modal-backdrop-custom" id="modalBackdrop"></div>
<div id="deleteModal">
    <div class="modal-header">Xác nhận xóa</div>
    <div class="modal-body" id="deleteMessage">Bạn có chắc chắn muốn xóa đồ ăn này không?</div>
    <div class="modal-footer" id="deleteButtons">
        <button type="button" class="btn btn-secondary" onclick="closeModal()">Hủy</button>
        <form id="deleteForm" method="post" style="display:inline;">
            @Html.AntiForgeryToken()
            <button type="submit" class="btn btn-danger">Xóa</button>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        let deleteId = null;

        function showDeletePopup(id, name) {
            deleteId = id;
            const modal = document.getElementById("deleteModal");
            const backdrop = document.getElementById("modalBackdrop");
            const deleteForm = document.getElementById("deleteForm");

            deleteForm.action = `/Snacks/Delete/${id}`;
            document.getElementById("deleteMessage").innerText = `Bạn có chắc chắn muốn xóa đồ ăn "${name}" không?`;

            modal.style.display = "block";
            backdrop.style.display = "block";
        }

        function closeModal() {
            const modal = document.getElementById("deleteModal");
            const backdrop = document.getElementById("modalBackdrop");
            modal.style.display = "none";
            backdrop.style.display = "none";
        }

        // Đóng modal khi click vào backdrop
        document.getElementById("modalBackdrop").addEventListener("click", closeModal);
    </script>
}
