@model CinemaS.Models.ViewModels.PaymentResultVM
@using System.Globalization
@{
    ViewData["Title"] = "Kết quả thanh toán";
    Layout = "~/Views/Shared/_Layout.cshtml";

    DateTime? paidAt = null;
    if (!string.IsNullOrWhiteSpace(Model?.PayDateRaw))
    {
        if (DateTime.TryParseExact(
            Model.PayDateRaw.Trim(),
            "yyyyMMddHHmmss",
            CultureInfo.InvariantCulture,
            DateTimeStyles.None,
            out var parsed))
        {
            paidAt = parsed;
        }
    }
}

<style>
    /* QR Code Styles */
    .qr-section {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 16px;
        background: rgba(15,23,42,.55);
        border-radius: 16px;
        border: 1px solid rgba(148,163,255,.18);
        margin-top: 16px;
    }

    .qr-title {
        font-size: 13px;
        font-weight: 800;
        color: #c7d2fe;
        margin-bottom: 12px;
        text-transform: uppercase;
        letter-spacing: .5px;
    }

    .qr-image-container {
        background: #fff;
        padding: 12px;
        border-radius: 12px;
        box-shadow: 0 8px 20px rgba(0,0,0,.25);
    }

    .qr-image-container img {
        width: 160px;
        height: 160px;
        display: block;
    }

    .qr-actions {
        display: flex;
        gap: 10px;
        margin-top: 14px;
    }

    .qr-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 16px;
        border-radius: 999px;
        font-size: 12px;
        font-weight: 800;
        text-decoration: none;
        border: 1px solid rgba(148,163,255,.35);
        background: rgba(15,23,42,.75);
        color: #e5e7f5;
        cursor: pointer;
        transition: all .2s ease;
    }

    .qr-btn:hover {
        filter: brightness(1.1);
        color: #fff;
        transform: translateY(-2px);
    }

    .qr-btn-download {
        background: linear-gradient(120deg, #3b82f6, #8b5cf6);
        border-color: transparent;
    }

    .qr-btn-pdf {
        background: linear-gradient(120deg, #10b981, #3b82f6);
        border-color: transparent;
    }

    .ticket-header-with-qr {
        display: grid;
        grid-template-columns: 140px 1fr auto;
        gap: 14px;
        align-items: start;
    }

    .qr-side {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 12px;
        background: rgba(15,23,42,.55);
        border-radius: 16px;
        border: 1px solid rgba(148,163,255,.18);
    }

    .qr-side .qr-image-container {
        padding: 8px;
    }

    .qr-side .qr-image-container img {
        width: 120px;
        height: 120px;
    }

    .qr-side-label {
        font-size: 11px;
        font-weight: 700;
        color: #9ca3af;
        margin-top: 8px;
        text-align: center;
    }

    .qr-side-actions {
        display: flex;
        flex-direction: column;
        gap: 6px;
        margin-top: 10px;
        width: 100%;
    }

    .qr-side-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        padding: 8px 12px;
        border-radius: 999px;
        font-size: 11px;
        font-weight: 700;
        text-decoration: none;
        border: 1px solid rgba(148,163,255,.35);
        background: rgba(15,23,42,.75);
        color: #e5e7f5;
        cursor: pointer;
        transition: all .2s ease;
    }

    .qr-side-btn:hover {
        filter: brightness(1.1);
        color: #fff;
    }

    .qr-side-btn.download {
        background: linear-gradient(120deg, #3b82f6, #8b5cf6);
        border-color: transparent;
    }

    @@media (max-width: 768px) {
        .ticket-header-with-qr {
            grid-template-columns: 1fr;
        }

        .qr-side {
            order: -1;
            flex-direction: row;
            justify-content: center;
            gap: 16px;
            flex-wrap: wrap;
        }

        .qr-side-actions {
            flex-direction: row;
            width: auto;
        }
    }
</style>

<div class="payment-result">
    <div class="result-container">
        <div class="result-content">
            @if (Model != null)
            {
                <div id="paymentStatusBadge" class="status-badge-compact @(Model.IsSuccess ? "success" : "danger")">
                    <i class="fas @(Model.IsSuccess ? "fa-check-circle" : "fa-times-circle")"></i>
                    <span>@(Model.IsSuccess ? "THANH TOÁN THÀNH CÔNG" : "THANH TOÁN THẤT BẠI")</span>
                </div>

                <div class="result-card">
                    <div class="card-header-custom">
                        <div class="card-header-left">
                            <div class="card-header-icon">
                                <i class="fas fa-receipt"></i>
                            </div>
                            <h3 class="card-header-title">Thông tin Vé</h3>
                        </div>
                    </div>

                    <div class="card-body-custom">
                        @if (Model.Detail == null)
                        {
                            <div class="empty-detail">
                                <div class="empty-icon"><i class="fas fa-ticket-alt"></i></div>
                                <div class="empty-text">Không có dữ liệu chi tiết hóa đơn.</div>
                            </div>
                        }
                        else
                        {
                            var d = Model.Detail;
                            var hasQr = !Model.IsAdminAccount && (!string.IsNullOrWhiteSpace(d.QrImageBase64) || !string.IsNullOrWhiteSpace(Model.QrImageBase64));
                            var qrBase64 = d.QrImageBase64 ?? Model.QrImageBase64;

                            <div class="@(hasQr ? "ticket-header-with-qr" : "ticket-header")">
                                <div class="ticket-poster">
                                    @if (!string.IsNullOrWhiteSpace(d.MoviePoster))
                                    {
                                        <img src="@d.MoviePoster" alt="@d.MovieTitle" />
                                    }
                                    else
                                    {
                                        <img src="/images/no-poster.png" alt="Poster" />
                                    }
                                </div>

                                <div class="ticket-main">
                                    <div class="movie-title">@d.MovieTitle</div>

                                    <div class="ticket-detail-item">
                                        <i class="fas fa-building"></i>
                                        <strong>Rạp/Phòng:</strong>
                                        <span>@d.CinemaTheater</span>
                                    </div>

                                    <div class="ticket-detail-item">
                                        <i class="fas fa-calendar-alt"></i>
                                        <strong>Ngày chiếu:</strong>
                                        <span>@(d.ShowDate?.ToString("dd/MM/yyyy") ?? "N/A")</span>
                                    </div>

                                    <div class="ticket-detail-item">
                                        <i class="fas fa-clock"></i>
                                        <strong>Giờ:</strong>
                                        <span>
                                            @(d.StartTime?.ToString("HH:mm") ?? "N/A")
                                            -
                                            @(d.EndTime?.ToString("HH:mm") ?? "N/A")
                                        </span>
                                    </div>

                                    <div class="ticket-detail-item">
                                        <i class="fas fa-chair"></i>
                                        <strong>Ghế:</strong>
                                        <span>
                                            @(d.SeatLabels != null && d.SeatLabels.Any()
                                                ? string.Join(", ", d.SeatLabels)
                                                : "N/A")
                                        </span>
                                    </div>

                                    <div class="contact-info">
                                        @if (!string.IsNullOrWhiteSpace(d.InvoiceEmail))
                                        {
                                            <div class="contact-item">
                                                <i class="fas fa-envelope"></i>
                                                <span>@d.InvoiceEmail</span>
                                            </div>
                                        }
                                        @if (!string.IsNullOrWhiteSpace(d.InvoicePhone))
                                        {
                                            <div class="contact-item">
                                                <i class="fas fa-phone"></i>
                                                <span>@d.InvoicePhone</span>
                                            </div>
                                        }
                                        @if (!string.IsNullOrWhiteSpace(d.PaymentMethod))
                                        {
                                            <div class="contact-item">
                                                <i class="fas fa-credit-card"></i>
                                                <span>
                                                    @d.PaymentMethod
                                                    @if (paidAt.HasValue)
                                                    {
                                                        <span style="opacity:.85;"> • @paidAt.Value.ToString("dd/MM/yyyy HH:mm")</span>
                                                    }
                                                </span>
                                            </div>
                                        }
                                    </div>
                                </div>

                                @if (hasQr && Model.IsSuccess)
                                {
                                    <div class="qr-side">
                                        <div class="qr-image-container">
                                            <img id="qrImage" src="data:image/png;base64,@qrBase64" alt="QR Code" />
                                        </div>
                                        <div class="qr-side-label">Mã QR vé điện tử</div>
                                        <div class="qr-side-actions">
                                            <!--<a class="qr-side-btn download" href="/Qr/Image/@d.InvoiceId" download="CinemaS_Tickets.png">
                                                 <i class="fas fa-download"></i> Tải Xuống
                                             </a>-->

                                            <button type="button" class="qr-side-btn download" onclick="downloadPaymentQr()">
                                                <i class="fas fa-download"></i> Tải Xuống
                                            </button>
                                </div>
                            </div>
                                }
                            </div>

                            <div class="pricing-section">
                                <div class="pricing-item">
                                    <div class="pricing-title">TIỀN VÉ</div>
                                    <div class="pricing-value">@d.TicketTotal.ToString("N0") đ</div>
                                </div>

                                <div class="pricing-item">
                                    <div class="pricing-title">TIỀN ĐỒ ĂN</div>
                                    <div class="pricing-value">@d.SnackTotal.ToString("N0") đ</div>
                                </div>
                            </div>

                            <div class="block-stack">
                                <div class="pricing-item pricing-block">
                                    <div class="pricing-title">BẮP NƯỚC</div>

                                    @if (d.SnackItems != null && d.SnackItems.Any())
                                    {
                                        <ul class="snack-list">
                                            @foreach (var s in d.SnackItems)
                                            {
                                                <li>
                                                    <span class="snack-name">@s.Name × @s.Quantity</span>
                                                    <span class="snack-price">@s.LineTotal.ToString("N0") đ</span>
                                                </li>
                                            }
                                        </ul>
                                    }
                                    else
                                    {
                                        <div class="empty-snacks">Không có đồ ăn kèm</div>
                                    }
                                </div>

                                <div class="pricing-item pricing-block">
                                    <div class="pricing-title pricing-title-tight">KHUYẾN MÃI</div>

                                    <div class="promo-row-line">
                                        <span>Chương trình</span>
                                        <span class="promo-strong">
                                            @(string.IsNullOrWhiteSpace(d.PromotionName) ? "-" : d.PromotionName)
                                        </span>
                                    </div>

                                    <div class="promo-row-line">
                                        <span>Giảm (%)</span>
                                        <span class="promo-strong">
                                            @(d.DiscountPercent.HasValue ? (d.DiscountPercent.Value.ToString("0.##") + "%") : "-")
                                        </span>
                                    </div>

                                    <div class="promo-row-line">
                                        <span>Giá gốc</span>
                                        <span class="promo-original">@d.OriginalAmount.ToString("N0") đ</span>
                                    </div>

                                    <div class="promo-row-line">
                                        <span>Giảm</span>
                                        <span class="promo-discount">-@d.DiscountAmount.ToString("N0") đ</span>
                                    </div>

                                    <div class="promo-payable">
                                        <span class="promo-payable-title">PHẢI TRẢ</span>
                                        <span class="promo-payable-value">@d.PayableAmount.ToString("N0") đ</span>
                                    </div>
                                </div>
                            </div>

                            <div class="action-buttons">
                                <a class="btn-custom btn-home" href="/">
                                    <i class="fas fa-home"></i> Trang chủ
                                </a>

                                <a class="btn-custom btn-history" href="/Payment/History">
                                    <i class="fas fa-history"></i> Lịch sử hóa đơn
                                </a>
                            </div>
                        }
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        (function () {
            const isSuccess = @((Model?.IsSuccess ?? false).ToString().ToLower());
            if (!isSuccess) return;

            const orderId = "@(Model?.OrderId ?? "")";
            if (!orderId) return;

            const key = "pay_success_shown:" + orderId;

            try {
                const alreadyShown = sessionStorage.getItem(key) === "1";
                if (alreadyShown) {
                    const badge = document.getElementById("paymentStatusBadge");
                    if (badge) badge.style.display = "none";
                    return;
                }
                sessionStorage.setItem(key, "1");
            } catch (_) {
                
            }
        })();

        function downloadPaymentQr() {
            const img = document.getElementById('qrImage');
             if (!img || !img.src) {
                 alert('Không có ảnh QR để tải.');
                 return;
             }

             // Create a temporary anchor to trigger download with fixed filename
             const a = document.createElement('a');
             a.href = img.src;
             a.download = 'CinemaS_Tickets.png';
             document.body.appendChild(a);
             a.click();
             document.body.removeChild(a);
         }
    </script>
}
