@model CinemaS.Models.ViewModels.PaymentResultVM
@using System.Globalization
@{
    ViewData["Title"] = "Kết quả thanh toán";
    Layout = "~/Views/Shared/_Layout.cshtml";

    DateTime? paidAt = null;
    if (!string.IsNullOrWhiteSpace(Model?.PayDateRaw))
    {
        if (DateTime.TryParseExact(
            Model.PayDateRaw.Trim(),
            "yyyyMMddHHmmss",
            CultureInfo.InvariantCulture,
            DateTimeStyles.None,
            out var parsed))
        {
            paidAt = parsed;
        }
    }
}

<div class="payment-result">
    <div class="result-container">
        <div class="result-content">

            @if (Model != null)
            {
                <div class="status-badge-compact @(Model.IsSuccess ? "success" : "danger")">
                    <i class="fas @(Model.IsSuccess ? "fa-check-circle" : "fa-times-circle")"></i>
                    <span>@(Model.IsSuccess ? "THANH TOÁN THÀNH CÔNG" : "THANH TOÁN THẤT BẠI")</span>
                </div>

                <div class="result-card">
                    <div class="card-header-custom">
                        <div class="card-header-left">
                            <div class="card-header-icon">
                                <i class="fas fa-receipt"></i>
                            </div>
                            <h3 class="card-header-title">Thông tin hóa đơn</h3>
                        </div>

                        <div class="bill-code">
                            Mã: <span class="bill-code-value">@Model.OrderId</span>
                        </div>
                    </div>

                    <div class="card-body-custom">
                        @if (Model.Detail == null)
                        {
                            <div class="empty-detail">
                                <div class="empty-icon"><i class="fas fa-ticket-alt"></i></div>
                                <div class="empty-text">Không có dữ liệu chi tiết hóa đơn.</div>
                            </div>
                        }
                        else
                        {
                            var d = Model.Detail;

                            <div class="ticket-header">
                                <div class="ticket-poster">
                                    @if (!string.IsNullOrWhiteSpace(d.MoviePoster))
                                    {
                                        <img src="@d.MoviePoster" alt="@d.MovieTitle" />
                                    }
                                    else
                                    {
                                        <img src="/images/poster_default.jpg" alt="Poster" />
                                    }
                        </div>

                        <div class="ticket-main">
                            <div class="movie-title">@d.MovieTitle</div>

                            <div class="ticket-detail-item">
                                <i class="fas fa-building"></i>
                                <strong>Rạp/Phòng:</strong>
                                <span>@d.CinemaTheater</span>
                            </div>

                            <div class="ticket-detail-item">
                                <i class="fas fa-calendar-alt"></i>
                                <strong>Ngày chiếu:</strong>
                                <span>@(d.ShowDate?.ToString("dd/MM/yyyy") ?? "N/A")</span>
                            </div>

                            <div class="ticket-detail-item">
                                <i class="fas fa-clock"></i>
                                <strong>Giờ:</strong>
                                <span>
                                    @(d.StartTime?.ToString("HH:mm") ?? "N/A")
                                    -
                                    @(d.EndTime?.ToString("HH:mm") ?? "N/A")
                                </span>
                            </div>

                            <div class="ticket-detail-item">
                                <i class="fas fa-chair"></i>
                                <strong>Ghế:</strong>
                                <span>
                                    @(d.SeatLabels != null && d.SeatLabels.Any()
                                                                        ? string.Join(", ", d.SeatLabels)
                                                                        : "N/A")
                                        </span>
                                    </div>

                                    <div class="ticket-detail-item">
                                        <i class="fas fa-ticket-alt"></i>
                                        <strong>Số vé:</strong>
                                        <span>@d.TicketCount</span>
                                    </div>

                                    <div class="contact-info">
                                        @if (!string.IsNullOrWhiteSpace(d.InvoiceEmail))
                                        {
                                            <div class="contact-item">
                                                <i class="fas fa-envelope"></i>
                                                <span>@d.InvoiceEmail</span>
                                            </div>
                                        }
                                        @if (!string.IsNullOrWhiteSpace(d.InvoicePhone))
                                        {
                                            <div class="contact-item">
                                                <i class="fas fa-phone"></i>
                                                <span>@d.InvoicePhone</span>
                                            </div>
                                        }
                                        @if (!string.IsNullOrWhiteSpace(d.PaymentMethod))
                                        {
                                            <div class="contact-item">
                                                <i class="fas fa-credit-card"></i>
                                                <span>
                                                    @d.PaymentMethod
                                                    @if (paidAt.HasValue)
                                                    {
                                                        <span style="opacity:.85;"> • @paidAt.Value.ToString("dd/MM/yyyy HH:mm")</span>
                                                    }
                                                </span>
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>

                            <div class="pricing-section">
                                <div class="pricing-item">
                                    <div class="pricing-title">TIỀN VÉ</div>
                                    <div class="pricing-value">@d.TicketTotal.ToString("N0") đ</div>
                                </div>

                                <div class="pricing-item">
                                    <div class="pricing-title">TIỀN ĐỒ ĂN</div>
                                    <div class="pricing-value">@d.SnackTotal.ToString("N0") đ</div>
                                </div>
                            </div>

                            <div class="block-stack">
                                <div class="pricing-item pricing-block">
                                    <div class="pricing-title">BẮP NƯỚC</div>

                                    @if (d.SnackItems != null && d.SnackItems.Any())
                                    {
                                        <ul class="snack-list">
                                            @foreach (var s in d.SnackItems)
                                            {
                                                <li>
                                                    <span class="snack-name">@s.Name × @s.Quantity</span>
                                                    <span class="snack-price">@s.LineTotal.ToString("N0") đ</span>
                                                </li>
                                            }
                                        </ul>
                                    }
                                    else
                                    {
                                        <div class="empty-snacks">Không có đồ ăn kèm</div>
                                    }
                                </div>

                                <div class="pricing-item pricing-block">
                                    <div class="pricing-title pricing-title-tight">KHUYẾN MÃI</div>

                                    <div class="promo-row-line">
                                        <span>Chương trình</span>
                                        <span class="promo-strong">
                                            @(string.IsNullOrWhiteSpace(d.PromotionName) ? "-" : d.PromotionName)
                                        </span>
                                    </div>

                                    <div class="promo-row-line">
                                        <span>Giảm (%)</span>
                                        <span class="promo-strong">
                                            @(d.DiscountPercent.HasValue ? (d.DiscountPercent.Value.ToString("0.##") + "%") : "-")
                                        </span>
                                    </div>

                                    <div class="promo-row-line">
                                        <span>Giá gốc</span>
                                        <span class="promo-original">@d.OriginalAmount.ToString("N0") đ</span>
                                    </div>

                                    <div class="promo-row-line">
                                        <span>Giảm</span>
                                        <span class="promo-discount">-@d.DiscountAmount.ToString("N0") đ</span>
                                    </div>

                                    <div class="promo-payable">
                                        <span class="promo-payable-title">PHẢI TRẢ</span>
                                        <span class="promo-payable-value">@d.PayableAmount.ToString("N0") đ</span>
                                    </div>
                                </div>
                            </div>

                            <div class="action-buttons">
                                <a class="btn-custom btn-home" href="/">
                                    <i class="fas fa-home"></i> Trang chủ
                                </a>

                                <a class="btn-custom btn-history" href="/Payment/History">
                                    <i class="fas fa-history"></i> Lịch sử
                                </a>
                            </div>
                        }
                    </div>
                </div>
            }
        </div>
    </div>
</div>
