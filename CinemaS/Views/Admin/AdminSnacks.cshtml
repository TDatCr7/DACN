@{
    ViewData["Title"] = "Đặt đồ ăn cho khách hàng";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<link rel="stylesheet" href="~/css/seat-selection.css" asp-append-version="true" />

<div class="container mt-4 mb-5">
    <!-- HEADER -->
    <div class="admin-booking-header">
        <h2>
            <i class="fas fa-utensils"></i>
            Đặt đồ ăn cho khách hàng
        </h2>
        <p class="subtitle">
            <i class="fas fa-info-circle"></i>
            Nhập SĐT/Email khách hàng để tích điểm, hoặc để trống để lưu vào tài khoản Admin.
        </p>
    </div>

    <!-- CUSTOMER INFO -->
    <div class="customer-info-section">
        <h5>
            <i class="fas fa-user-circle"></i>
            Thông tin khách hàng (không bắt buộc)
        </h5>

        <div class="customer-input-group">
            <div class="customer-input-field">
                <label for="customerKey">
                    <i class="fas fa-search"></i> Số điện thoại hoặc Email khách hàng
                </label>

                <input type="text"
                       id="customerKey"
                       placeholder="Nhập SĐT hoặc Email"
                       autocomplete="off" />

                <div id="customerValidation" class="validation-message info">
                    <i class="fas fa-info-circle"></i>
                    <span>Để trống nếu muốn lưu vào tài khoản Admin</span>
                </div>

                <div id="customerInfoDisplay" class="customer-info-display"></div>
            </div>
        </div>
    </div>

    <!-- SNACK LIST -->
    <div class="snack-selection mt-3">
        <div class="snack-header">
            <h5 class="fw-bold mb-0">
                <i class="fas fa-utensils"></i>
                Danh sách đồ ăn
                <span id="snackCount" class="snack-badge-count"></span>
            </h5>
        </div>

        <div class="snack-content" id="snackContent" style="display:block;">
            <div class="row g-3 mt-2">
                @if (ViewBag.Snacks != null)
                {
                    foreach (var snack in ViewBag.Snacks)
                    {
                        <div class="col-6 col-md-3 col-lg-2">
                            <div class="snack-card">
                                <div class="snack-image">
                                    @if (!string.IsNullOrEmpty(snack.Image))
                                    {
                                        <img src="@snack.Image" alt="@snack.Name" onerror="this.src='/images/snacks/SnackCinema.jpg'">
                                    }
                                    else
                                    {
                                        <img src="/images/snacks/SnackCinema.jpg" alt="@snack.Name">
                                    }
                                </div>

                                <div class="snack-info">
                                    <h6 class="snack-name">@snack.Name</h6>
                                    <p class="snack-price">@snack.Price?.ToString("N0") đ</p>

                                    <div class="snack-control"
                                         data-snack-id="@snack.SnackId"
                                         data-price="@snack.Price"
                                         data-name="@snack.Name">

                                        <button type="button"
                                                class="btn-choose-snack"
                                                onclick="handleChooseSnack(this)">
                                            Chọn
                                        </button>

                                        <div class="quantity-control" style="display:none;">
                                            <button type="button"
                                                    class="quantity-btn-snack"
                                                    onclick="updateSnackCardQuantity(this,-1)">
                                                -
                                            </button>

                                            <input type="number" class="quantity-input-snack" value="1" readonly>

                                            <button type="button"
                                                    class="quantity-btn-snack"
                                                    onclick="updateSnackCardQuantity(this,1)">
                                                +
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="col-12">
                        <p style="text-align:center;color:#9ca3af;padding:40px 0;">
                            <i class="fas fa-shopping-basket" style="font-size:48px;margin-bottom:10px;display:block;"></i>
                            Hiện chưa có đồ ăn nào
                        </p>
                    </div>
                }
            </div>
        </div>
    </div>

    <!-- SUMMARY (REUSE CSS MUA VÉ) -->
    <div class="booking-summary">
        <div class="booking-summary-grid booking-summary-grid-3">
            <!-- LEFT -->
            <div class="summary-left">
                <!-- BỎ "Đồ ăn đã chọn" -->
                <div class="snack-summary">
                    <div class="snack-summary-title">
                        <strong>Bắp nước đã chọn:</strong>
                        <span id="snackTotalInline">0 đ</span>
                    </div>

                    <div class="snack-summary-list" id="snackSummaryList">
                        <div class="snack-empty">Chưa chọn</div>
                    </div>
                </div>

                <div class="total-price">
                    <strong>Tạm tính:</strong>
                    <span id="subTotalPrice">0 đ</span>
                </div>
            </div>

            <!-- PROMO (GIỮ KHUNG CŨ, nhưng bọc đúng class promo-box để ăn CSS mua vé) -->
            <div class="summary-right">
                <div class="promo-box promo-box-compact">
                    <div class="promo-row">
                        <div class="promo-left">
                            <strong>Mã giảm giá</strong>
                            <div class="promo-hint">Áp dụng trước khi tạo hoá đơn</div>
                        </div>

                        <div class="promo-right">
                            <input id="promoCodeInput" type="text" class="promo-input" placeholder="Nhập mã (VD: SALE10)" />
                            <button type="button" class="promo-btn" onclick="applyPromoBeforeInvoice()">Áp</button>
                            <button type="button" class="promo-btn promo-btn-danger" onclick="clearPromoBeforeInvoice()">Gỡ mã</button>
                        </div>
                    </div>

                    <div class="promo-meta">
                        <div class="promo-line">
                            <span>Chương trình:</span>
                            <span id="promoNameText">-</span>
                        </div>

                        <div class="promo-line">
                            <span>Giảm (%):</span>
                            <span id="promoPercentText">-</span>
                        </div>

                        <div class="promo-line">
                            <span>Giảm:</span>
                            <span id="promoDiscountText">0 đ</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ACTION (CỘT PHẢI GIỐNG MUA VÉ) -->
            <div class="booking-action-col">
                <div class="payable-card">
                    <div class="payable-row">
                        <strong>Phải trả:</strong>
                        <span id="totalPrice">0 đ</span>
                    </div>
                </div>

                <button id="btnOrder" class="btn-book" onclick="openOrderModal()" disabled>
                    <i class="fas fa-shopping-cart"></i> Đặt đồ ăn cho khách
                </button>
            </div>
        </div>
    </div>


</div>

<!-- ORDER MODAL -->
<div class="booking-modal-overlay" id="orderModalOverlay">
    <div class="booking-modal">
        <div class="booking-modal-header">
            <h3>Xác nhận đặt đồ ăn</h3>
        </div>

        <div class="booking-modal-body">
            <div class="booking-info-item">
                <span class="booking-info-label">Tổng số món:</span>
                <span class="booking-info-value" id="modalSnackCount">0</span>
            </div>

            <div id="modalSnacksList" style="margin-top:20px;"></div>

            <div class="booking-total" style="margin-top:20px;">
                <div class="booking-info-item">
                    <span class="booking-info-label">TỔNG CỘNG:</span>
                    <span class="booking-info-value" id="modalGrandTotal">0 đ</span>
                </div>

                <div class="booking-info-item" style="margin-top:10px;">
                    <span class="booking-info-label">PHẢI TRẢ:</span>
                    <span class="booking-info-value" id="modalPayableTotal">0 đ</span>
                </div>
            </div>

            <div style="margin-top:20px;padding:15px;background:rgba(251,191,36,0.1);border-left:4px solid #fbbf24;border-radius:4px;">
                <div style="color:#fef3c7;font-size:13px;">
                    <strong><i class="fas fa-user-circle"></i> Thông tin khách hàng:</strong>
                    <div id="modalCustomerInfo" style="margin-top:8px;line-height:1.6;"></div>
                </div>
            </div>
        </div>

        <div class="booking-modal-footer">
            <button class="booking-modal-btn booking-modal-btn-cancel" onclick="closeOrderModal()">
                <i class="fas fa-times"></i> Hủy
            </button>
            <button class="booking-modal-btn booking-modal-btn-confirm" onclick="confirmOrder()">
                <i class="fas fa-check"></i> Xác nhận
            </button>
        </div>
    </div>
</div>

<!-- PAYMENT METHOD MODAL -->
<div class="booking-modal-overlay" id="paymentMethodOverlay">
    <div class="booking-modal">
        <div class="booking-modal-header">
            <div class="icon">💳</div>
            <h3>Chọn phương thức thanh toán</h3>
        </div>

        <div class="booking-modal-body">
            <div class="booking-info-item">
                <span class="booking-info-label">Mã đơn:</span>
                <span class="booking-info-value" id="payInvoiceIdText">—</span>
            </div>

            <div class="booking-info-item">
                <span class="booking-info-label">Phải trả:</span>
                <span class="booking-info-value" id="payAmountText">0 đ</span>
            </div>

            <div style="display:flex;flex-direction:column;gap:12px;margin-top:14px;">
                <button type="button"
                        class="booking-modal-btn booking-modal-btn-confirm"
                        onclick="payWithVnPay()">
                    <i class="fas fa-qrcode"></i> Thanh toán VNPay
                </button>

                <button type="button"
                        class="booking-modal-btn booking-modal-btn-confirm"
                        style="background:#16a34a;border-color:#16a34a;"
                        onclick="payWithCash()">
                    <i class="fas fa-money-bill-wave"></i> Thanh toán tiền mặt
                </button>
            </div>
        </div>

        <div class="booking-modal-footer">
            <button class="booking-modal-btn booking-modal-btn-cancel" onclick="closePaymentMethodModal()">
                <i class="fas fa-times"></i> Đóng
            </button>
        </div>
    </div>
</div>

<div class="booking-loading-overlay" id="bookingLoadingOverlay">
    <div class="booking-loading-content">
        <div class="booking-loading-spinner"></div>
        <div class="booking-loading-text">Đang xử lý...</div>
    </div>
</div>

<div class="booking-toast" id="bookingToast"></div>

@section Scripts {
    <script>
                // =========================
                // STATE
                // =========================
                let selectedSnacks = [];

                let currentInvoiceId = null;
                let currentInvoiceAmount = 0;       // gửi qua Payment/Create
                let currentCustomerInfo = null;

                let currentBaseTotal = 0;           // tạm tính (client)
                let currentPayableTotal = 0;        // phải trả (client)

                let promoDraftCode = '';
                let promoApplied = false;
                let promoName = '';
                let promoPercent = null;
                let promoDiscountAmount = 0;

                // =========================
                // UI HELPERS
                // =========================
                function showBookingLoading(show) {
                    const overlay = document.getElementById('bookingLoadingOverlay');
                    if (!overlay) return;
                    if (show) overlay.classList.add('show');
                    else overlay.classList.remove('show');
                }

                function showBookingToast(message, type) {
                    const toast = document.getElementById('bookingToast');
                    if (!toast) return;
                    toast.innerHTML = message;
                    toast.className = 'booking-toast booking-toast-' + type + ' show';
                    setTimeout(() => { toast.classList.remove('show'); }, 5000);
                }

                function formatVND(n) {
                    return (n || 0).toLocaleString('vi-VN') + ' đ';
                }

                function setPromoUI(nameText, percentText, discountText, payableText) {
                    const nameEl = document.getElementById('promoNameText');
                    const percentEl = document.getElementById('promoPercentText');
                    const discountEl = document.getElementById('promoDiscountText');
                    const payableEl = document.getElementById('totalPrice'); // <-- đổi sang totalPrice

                    if (nameEl) nameEl.textContent = nameText;
                    if (percentEl) percentEl.textContent = percentText;
                    if (discountEl) discountEl.textContent = discountText;
                    if (payableEl) payableEl.textContent = payableText;
                }


                function resetPromoState() {
                    promoDraftCode = '';
                    promoApplied = false;
                    promoName = '';
                    promoPercent = null;
                    promoDiscountAmount = 0;

                    setPromoUI('-', '-', formatVND(0), formatVND(currentBaseTotal));

                    const input = document.getElementById('promoCodeInput');
                    if (input) input.value = '';
                }

                function updateSnackCounter() {
                    const totalQuantity = selectedSnacks.reduce((sum, s) => sum + (s.quantity || 1), 0);
                    const countElement = document.getElementById('snackCount');
                    if (!countElement) return;

                    if (totalQuantity > 0) {
                        countElement.textContent = `(${totalQuantity} món đã chọn)`;
                        countElement.style.backgroundColor = '#364747';
                        countElement.style.color = '#fff';
                        countElement.style.marginLeft = '8px';
                        countElement.style.fontSize = '13px';
                        countElement.style.padding = '2px 8px';
                        countElement.style.borderRadius = '12px';
                    } else {
                        countElement.textContent = '';
                    }
                }

                function updateSummary() {
            const snackTotal = selectedSnacks.reduce((sum, s) => sum + (s.price * (s.quantity || 1)), 0);

            currentBaseTotal = snackTotal;
            currentPayableTotal = snackTotal;

            // tạm tính (mua vé dùng subTotalPrice)
            const subTotal = document.getElementById('subTotalPrice');
            if (subTotal) subTotal.textContent = formatVND(snackTotal);

            // tổng snack inline
            const snackInline = document.getElementById('snackTotalInline');
            if (snackInline) snackInline.textContent = formatVND(snackTotal);

            // list snack (scroll như mua vé)
            const list = document.getElementById('snackSummaryList');
            if (list) {
                if (selectedSnacks.length === 0) {
                    list.innerHTML = `<div class="snack-empty">Chưa chọn</div>`;
                } else {
                    list.innerHTML = selectedSnacks.map(s => `
                        <div class="snack-line">
                            <div class="snack-line-name">${s.name}</div>
                            <div class="snack-line-meta">x${s.quantity || 1}</div>
                            <div class="snack-line-price">${formatVND((s.price || 0) * (s.quantity || 1))}</div>
                        </div>
                    `).join('');
                }
            }

            // phải trả (cột phải mua vé dùng totalPrice)
            const totalPrice = document.getElementById('totalPrice');
            if (totalPrice) totalPrice.textContent = formatVND(currentPayableTotal);

            const btnOrder = document.getElementById('btnOrder');
            if (btnOrder) btnOrder.disabled = selectedSnacks.length === 0;

            updateSnackCounter();

            if (promoApplied && promoDraftCode) revalidatePromoAfterAmountChanged();
            else setPromoUI('-', '-', formatVND(0), formatVND(currentBaseTotal));
        }



                // =========================
                // SNACK PICK
                // =========================
                window.handleChooseSnack = function (button) {
                    const control = button.closest('.snack-control');
                    if (!control) return;

                    const snackId = control.dataset.snackId;
                    const price = parseFloat(control.dataset.price) || 0;
                    const name = control.dataset.name;

                    selectedSnacks.push({ id: snackId, name, price, quantity: 1 });

                    button.style.display = 'none';
                    const qc = control.querySelector('.quantity-control');
                    if (qc) qc.style.display = 'flex';

                    const input = control.querySelector('.quantity-input-snack');
                    if (input) input.value = 1;

                    updateSummary();
                }

                window.updateSnackCardQuantity = function (button, change) {
                    const control = button.closest('.snack-control');
                    if (!control) return;

                    const snackId = control.dataset.snackId;
                    const input = control.querySelector('.quantity-input-snack');
                    const currentQuantity = parseInt(input?.value || '1', 10);
                    const newQuantity = currentQuantity + change;

                    const snack = selectedSnacks.find(s => s.id === snackId);

                    if (newQuantity <= 0) {
                        selectedSnacks = selectedSnacks.filter(s => s.id !== snackId);

                        const qc = control.querySelector('.quantity-control');
                        if (qc) qc.style.display = 'none';

                        const chooseBtn = control.querySelector('.btn-choose-snack');
                        if (chooseBtn) chooseBtn.style.display = 'block';
                    } else {
                        if (snack) snack.quantity = newQuantity;
                        if (input) input.value = newQuantity;
                    }

                    updateSummary();
                }

                // =========================
                // PROMO (LIKE SCREENSHOT) - BEFORE INVOICE
                // =========================
                async function applyPromoBeforeInvoice() {
                    if (currentBaseTotal <= 0) {
                        showBookingToast('⚠️ Vui lòng chọn đồ ăn trước.', 'error');
                        return;
                    }

                    const code = (document.getElementById('promoCodeInput')?.value || '').trim();
                    if (!code) {
                        showBookingToast('⚠️ Vui lòng nhập mã giảm giá.', 'error');
                        return;
                    }

                    showBookingLoading(true);
                    try {
                        const vRes = await fetch('/Admin/ValidatePromotion', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ code, amount: currentBaseTotal })
                        });

                        const vData = await vRes.json();
                        if (!vData?.success) {
                            showBookingToast('❌ ' + (vData?.message || 'Mã không hợp lệ'), 'error');
                            return;
                        }

                        promoDraftCode = code;
                        promoApplied = true;

                        promoName = vData.promotionName || '-';
                        promoPercent = (typeof vData.discountPercent === 'number') ? vData.discountPercent : null;
                        promoDiscountAmount = vData.discountAmount || 0;

                        currentPayableTotal = vData.totalAfterDiscount ?? currentBaseTotal;

                        const percentText = (promoPercent === null) ? '-' : (promoPercent.toLocaleString('vi-VN') + '%');
                        setPromoUI(
                            promoName,
                            percentText,
                            formatVND(promoDiscountAmount),
                            formatVND(currentPayableTotal)
                        );

                        showBookingToast('✅ ' + (vData.message || 'Đã áp mã'), 'success');
                    } catch (e) {
                        showBookingToast('❌ Lỗi: ' + (e?.message || e), 'error');
                    } finally {
                        showBookingLoading(false);
                    }
                }

                async function revalidatePromoAfterAmountChanged() {
                    const code = promoDraftCode;
                    if (!code || currentBaseTotal <= 0) return;

                    try {
                        const vRes = await fetch('/Admin/ValidatePromotion', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ code, amount: currentBaseTotal })
                        });

                        const vData = await vRes.json();
                        if (!vData?.success) {
                            // amount thay đổi khiến mã invalid -> clear
                            resetPromoState();
                            promoDraftCode = '';
                            promoApplied = false;
                            return;
                        }

                        promoName = vData.promotionName || '-';
                        promoPercent = (typeof vData.discountPercent === 'number') ? vData.discountPercent : null;
                        promoDiscountAmount = vData.discountAmount || 0;

                        currentPayableTotal = vData.totalAfterDiscount ?? currentBaseTotal;

                        const percentText = (promoPercent === null) ? '-' : (promoPercent.toLocaleString('vi-VN') + '%');
                        setPromoUI(
                            promoName,
                            percentText,
                            formatVND(promoDiscountAmount),
                            formatVND(currentPayableTotal)
                        );
                    } catch (_) {
                        // im lặng
                    }
                }

                function clearPromoBeforeInvoice() {
                    resetPromoState();
                    showBookingToast('✅ Đã gỡ mã.', 'success');
                }

                // expose
                window.applyPromoBeforeInvoice = applyPromoBeforeInvoice;
                window.clearPromoBeforeInvoice = clearPromoBeforeInvoice;

                // =========================
                // ORDER MODAL
                // =========================
                window.openOrderModal = function () {
                    if (selectedSnacks.length === 0) {
                        showBookingToast('⚠️ Vui lòng chọn ít nhất 1 món!', 'error');
                        return;
                    }

                    const snackTotal = selectedSnacks.reduce((sum, s) => sum + (s.price * (s.quantity || 1)), 0);
                    const totalQuantity = selectedSnacks.reduce((sum, s) => sum + (s.quantity || 1), 0);

                    const modalSnackCount = document.getElementById('modalSnackCount');
                    if (modalSnackCount) modalSnackCount.textContent = totalQuantity + ' món';

                    const snacksList = document.getElementById('modalSnacksList');
                    if (snacksList) snacksList.innerHTML = '';

                    selectedSnacks.forEach((snack, index) => {
                        const snackDiv = document.createElement('div');
                        snackDiv.className = 'snack-quantity-item';
                        snackDiv.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid rgba(255,255,255,0.1);">
          <span style="color:#fff;flex:1;">${snack.name || 'Snack'}</span>
          <div style="display:flex;align-items:center;gap:10px;">
            <button type="button" class="quantity-btn" onclick="updateSnackQuantityInModal(${index},-1)"><i class="fas fa-minus"></i></button>
            <input type="number" class="quantity-input" value="${snack.quantity}" min="1" max="10" readonly
                   style="width:50px;text-align:center;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);color:#fff;padding:5px;border-radius:5px;">
            <button type="button" class="quantity-btn" onclick="updateSnackQuantityInModal(${index},1)"><i class="fas fa-plus"></i></button>
            <span style="color:#22c55e;font-weight:bold;min-width:100px;text-align:right;">${formatVND(snack.price * (snack.quantity || 1))}</span>
          </div>
        </div>`;
                        if (snacksList) snacksList.appendChild(snackDiv);
                    });

                    const grand = document.getElementById('modalGrandTotal');
                    if (grand) grand.textContent = formatVND(snackTotal);

                    const payable = document.getElementById('modalPayableTotal');
                    if (payable) payable.textContent = formatVND(currentPayableTotal || snackTotal);

                    updateModalCustomerInfo();

                    const overlay = document.getElementById('orderModalOverlay');
                    if (overlay) overlay.classList.add('show');
                };

                window.updateSnackQuantityInModal = function (index, change) {
                    if (index < 0 || index >= selectedSnacks.length) return;

                    const snack = selectedSnacks[index];
                    const newQuantity = (snack.quantity || 1) + change;

                    if (newQuantity < 1 || newQuantity > 10) {
                        showBookingToast('⚠️ Số lượng từ 1-10!', 'error');
                        return;
                    }

                    snack.quantity = newQuantity;

                    const controls = document.querySelectorAll('.snack-control');
                    controls.forEach(control => {
                        if (control.dataset.snackId === snack.id) {
                            const input = control.querySelector('.quantity-input-snack');
                            if (input) input.value = newQuantity;
                        }
                    });

                    updateSummary();
                    openOrderModal();
                };

                window.closeOrderModal = function () {
                    const overlay = document.getElementById('orderModalOverlay');
                    if (overlay) overlay.classList.remove('show');
                };

                // =========================
                // CREATE INVOICE + APPLY PROMO TO INVOICE (IF ANY)
                // =========================
                window.confirmOrder = async function () {
                    closeOrderModal();
                    showBookingLoading(true);

                    try {
                        const snacksData = selectedSnacks.map(snack => ({
                            snackId: snack.id,
                            quantity: snack.quantity || 1
                        }));

                        const customerKey = (document.getElementById('customerKey')?.value || '').trim();

                        const bookRes = await fetch('/Admin/AdminBookSnacks', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                snacks: snacksData,
                                loyaltyKey: customerKey || null
                            })
                        });

                        const bookData = await bookRes.json();

                        if (!bookData?.success) {
                            showBookingToast('❌ ' + (bookData?.message || 'Đặt hàng thất bại'), 'error');
                            return;
                        }

                        if (bookData.memberNotFound === true && customerKey) {
                            showBookingToast('⚠️ Tài khoản tích điểm không tồn tại. Đơn hàng vẫn được tạo nhưng KHÔNG tích điểm.', 'warning');
                        }

                        currentInvoiceId = bookData.invoiceId;

                        // server trả về tổng gốc
                        currentBaseTotal = bookData.totalPrice || 0;

                        // mặc định amount = phải trả (sẽ update nếu apply promo to invoice)
                        currentPayableTotal = currentPayableTotal || currentBaseTotal;
                        currentInvoiceAmount = currentPayableTotal;

                        // nếu đã áp mã trước invoice -> apply vào invoice ngay
                        if (promoApplied && promoDraftCode) {
                            const aRes = await fetch('/Admin/ApplyPromotionToInvoice', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ invoiceId: currentInvoiceId, code: promoDraftCode })
                            });

                            const aData = await aRes.json();
                            if (aData?.success) {
                                currentPayableTotal = aData.totalAfterDiscount ?? currentBaseTotal;
                                currentInvoiceAmount = currentPayableTotal;

                                const percentText = (typeof aData.discountPercent === 'number')
                                    ? (aData.discountPercent.toLocaleString('vi-VN') + '%')
                                    : '-';

                                setPromoUI(
                                    aData.promotionName || promoName || '-',
                                    percentText,
                                    formatVND(aData.discountAmount || 0),
                                    formatVND(currentPayableTotal)
                                );
                            }
                        }

                        openPaymentMethodModal();
                    } catch (error) {
                        showBookingToast('❌ Lỗi: ' + (error?.message || error), 'error');
                    } finally {
                        showBookingLoading(false);
                    }
                };

                function openPaymentMethodModal() {
                    const invText = document.getElementById('payInvoiceIdText');
                    const amtText = document.getElementById('payAmountText');

                    if (invText) invText.textContent = currentInvoiceId || '—';
                    if (amtText) amtText.textContent = formatVND(currentInvoiceAmount || 0);

                    const ov = document.getElementById('paymentMethodOverlay');
                    if (ov) ov.classList.add('show');
                }

                function closePaymentMethodModal() {
                    const ov = document.getElementById('paymentMethodOverlay');
                    if (ov) ov.classList.remove('show');
                }

                async function payWithVnPay() {
                    if (!currentInvoiceId) {
                        showBookingToast('❌ Thiếu mã đơn hàng.', 'error');
                        return;
                    }

                    closePaymentMethodModal();
                    showBookingLoading(true);

                    try {
                        const payRes = await fetch('/Payment/Create', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                orderId: currentInvoiceId,
                                amount: currentInvoiceAmount,
                                orderInfo: `Dat do an ${currentInvoiceId}`
                            })
                        });

                        const payData = await payRes.json();
                        if (payData?.success && payData?.paymentUrl) {
                            window.location.href = payData.paymentUrl;
                            return;
                        }

                        showBookingToast('❌ Không tạo được URL thanh toán VNPay.', 'error');
                    } catch (e) {
                        showBookingToast('❌ Lỗi: ' + (e?.message || e), 'error');
                    } finally {
                        showBookingLoading(false);
                    }
                }

                async function payWithCash() {
                    if (!currentInvoiceId) {
                        showBookingToast('❌ Thiếu mã đơn hàng.', 'error');
                        return;
                    }

                    closePaymentMethodModal();
                    showBookingLoading(true);

                    try {
                        const res = await fetch('/Payment/PayByCash', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ invoiceId: currentInvoiceId })
                        });

                        const data = await res.json();
                        if (data?.success && data?.redirectUrl) {
                            window.location.href = data.redirectUrl;
                            return;
                        }

                        showBookingToast('❌ ' + (data?.message || 'Thanh toán tiền mặt thất bại.'), 'error');
                    } catch (e) {
                        showBookingToast('❌ Lỗi: ' + (e?.message || e), 'error');
                    } finally {
                        showBookingLoading(false);
                    }
                }

                // =========================
                // CUSTOMER CHECK
                // =========================
                function updateValidationMessage(type, message) {
                    const container = document.getElementById('customerValidation');
                    if (!container) return;

                    container.className = `validation-message ${type}`;

                    let iconClass = 'fas fa-info-circle';
                    if (type === 'success') iconClass = 'fas fa-check-circle';
                    if (type === 'error') iconClass = 'fas fa-exclamation-triangle';

                    container.innerHTML = `<i class="${iconClass}"></i><span>${message}</span>`;
                }

                function displayCustomerInfo(data) {
                    const displayDiv = document.getElementById('customerInfoDisplay');
                    if (!displayDiv) return;

                    let html = '<div style="padding:8px 0;">';

                    if (data.isAdmin) {
                        html += '<div class="info-row" style="color:#fbbf24;font-weight:700;margin-bottom:8px;"><i class="fas fa-crown"></i> ĐÂY LÀ TÀI KHOẢN ADMIN</div>';
                    }

                    html += `<div class="info-row"><strong>👤 Tên:</strong> ${data.fullName || 'Chưa cập nhật'}</div>`;
                    html += `<div class="info-row"><strong>📧 Email:</strong> ${data.email || 'Chưa cập nhật'}</div>`;
                    html += `<div class="info-row"><strong>📱 SĐT:</strong> ${data.phone || 'Chưa cập nhật'}</div>`;
                    html += `<div class="info-row"><strong>📍 Địa chỉ:</strong> ${data.address || 'Chưa cập nhật'}</div>`;
                    html += `<div class="info-row"><strong>🎂 Tuổi:</strong> ${data.age || 'Chưa cập nhật'}</div>`;
                    html += '</div>';

                    displayDiv.innerHTML = html;
                    displayDiv.classList.add('show');
                }

                function hideCustomerInfo() {
                    const displayDiv = document.getElementById('customerInfoDisplay');
                    if (!displayDiv) return;
                    displayDiv.classList.remove('show');
                    displayDiv.innerHTML = '';
                }

                async function checkCustomerAccount(key) {
                    if (!key || key.trim().length < 3) {
                        updateValidationMessage('info', 'Để trống nếu muốn lưu vào tài khoản Admin');
                        currentCustomerInfo = null;
                        hideCustomerInfo();

                        const input = document.getElementById('customerKey');
                        if (input) input.classList.remove('valid', 'invalid');
                        return;
                    }

                    const trimmedKey = key.trim();

                    try {
                        const response = await fetch(`/Admin/CheckCustomerAccount?key=${encodeURIComponent(trimmedKey)}`);
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                        const data = await response.json();
                        const input = document.getElementById('customerKey');

                        if (data.exists) {
                            updateValidationMessage('success', data.message);
                            if (input) {
                                input.classList.add('valid');
                                input.classList.remove('invalid');
                            }
                            currentCustomerInfo = data;
                            displayCustomerInfo(data);
                        } else {
                            updateValidationMessage('error', data.message);
                            if (input) {
                                input.classList.add('invalid');
                                input.classList.remove('valid');
                            }
                            currentCustomerInfo = { exists: false };
                            hideCustomerInfo();
                        }
                    } catch (_) {
                        updateValidationMessage('error', 'Lỗi kiểm tra tài khoản. Vui lòng thử lại.');
                        currentCustomerInfo = null;
                        hideCustomerInfo();

                        const input = document.getElementById('customerKey');
                        if (input) input.classList.remove('valid', 'invalid');
                    }
                }

                function updateModalCustomerInfo() {
                    const customerKey = (document.getElementById('customerKey')?.value || '').trim();
                    const modalInfo = document.getElementById('modalCustomerInfo');
                    if (!modalInfo) return;

                    if (!customerKey) {
                        modalInfo.innerHTML = '<i class="fas fa-user-tie"></i> Đơn hàng sẽ lưu vào tài khoản Admin đang đăng nhập';
                        return;
                    }

                    if (currentCustomerInfo && currentCustomerInfo.exists) {
                        let html = '';

                        if (currentCustomerInfo.isAdmin) {
                            html += '<div style="color:#fbbf24;font-weight:700;margin-bottom:8px;"><i class="fas fa-crown"></i> ĐÂY LÀ TÀI KHOẢN ADMIN</div>';
                        }

                        html += `<div style="color:#10b981;"><i class="fas fa-check-circle"></i> <strong>Khách hàng:</strong> ${currentCustomerInfo.fullName || 'N/A'}</div>`;
                        if (currentCustomerInfo.email) html += `<div>📧 Email: ${currentCustomerInfo.email}</div>`;
                        if (currentCustomerInfo.phone) html += `<div>📱 SĐT: ${currentCustomerInfo.phone}</div>`;
                        if (currentCustomerInfo.address) html += `<div>📍 Địa chỉ: ${currentCustomerInfo.address}</div>`;
                        if (currentCustomerInfo.age) html += `<div>🎂 Tuổi: ${currentCustomerInfo.age}</div>`;
                        html += '<div style="margin-top:6px;"><i class="fas fa-star" style="color:#fbbf24;"></i> Đơn hàng sẽ được lưu vào tài khoản này và tích điểm</div>';

                        modalInfo.innerHTML = html;
                        return;
                    }

                    modalInfo.innerHTML =
                        `<div style="color:#ef4444;"><i class="fas fa-exclamation-triangle"></i> Không tìm thấy tài khoản với thông tin: <strong>${customerKey}</strong></div>
                         <div style="margin-top:6px;color:#fbbf24;">⚠️ Đơn hàng vẫn được tạo nhưng KHÔNG tích điểm</div>`;
                }

                function debounce(func, wait) {
                    let timeout;
                    return function (...args) {
                        const later = () => {
                            clearTimeout(timeout);
                            func(...args);
                        };
                        clearTimeout(timeout);
                        timeout = setTimeout(later, wait);
                    };
                }

                const debouncedCheckCustomer = debounce((value) => {
                    checkCustomerAccount(value);
                }, 500);

                document.addEventListener('DOMContentLoaded', () => {
                    updateSummary();
                    resetPromoState();

                    const customerInput = document.getElementById('customerKey');
                    if (customerInput) {
                        customerInput.addEventListener('input', function () {
                            const value = this.value.trim();
                            debouncedCheckCustomer(value);
                        });
                    }
                });
    </script>
}
