@using System.Text.Json
@model CinemaS.Models.ViewModels.StatisticsDashboardVM

@{
    ViewData["Title"] = "Thống kê - Báo cáo";
    Layout = "~/Views/Shared/_Layout.cshtml";

    var labels = Model.RevenueByPeriod.Select(x => x.Label).ToList();
    var ticketSeries = Model.RevenueByPeriod.Select(x => x.TicketRevenue).ToList();
    var snackSeries = Model.RevenueByPeriod.Select(x => x.SnackRevenue).ToList();

    var topMovieLabels = Model.TopMoviesByTickets.Select(x => x.Title).ToList();
    var topMovieTickets = Model.TopMoviesByTickets.Select(x => x.TicketsSold).ToList();

    var pieTicket = Model.Kpi.TicketRevenue;
    var pieSnack = Model.Kpi.SnackRevenue;

    var maxTickets = Model.TopMoviesByTickets.Count > 0 ? Model.TopMoviesByTickets.Max(x => x.TicketsSold) : 0;
}

<style>
    .stats-shell {
        padding: 26px 0 40px;
    }

    .stats-title {
        font-weight: 900;
        font-size: 28px;
        color: #e5e7ff;
        text-align: center;
        margin: 0 0 8px;
    }

    .stats-sub {
        text-align: center;
        color: rgba(226,232,240,.85);
        font-weight: 700;
        font-size: 13px;
        margin-bottom: 18px;
    }

    .stats-card {
        background: radial-gradient(circle at 0 0, rgba(59,130,246,.20), transparent 55%), radial-gradient(circle at 100% 0, rgba(124,58,237,.18), transparent 55%), rgba(2,6,23,.92);
        border: 1px solid rgba(148,163,255,.35);
        border-radius: 20px;
        box-shadow: 0 18px 45px rgba(15,23,42,.65);
        color: #e5e7eb;
    }

    .stats-card-hd {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        padding: 14px 16px 0;
    }

        .stats-card-hd h3 {
            margin: 0;
            font-weight: 900;
            font-size: 15px;
            color: #f1f5f9;
        }

    .stats-card-bd {
        padding: 12px 16px 16px;
    }

    .kpi-grid {
        display: grid;
        grid-template-columns: repeat(5, minmax(0,1fr));
        gap: 12px;
    }

    .kpi {
        border-radius: 18px;
        border: 1px solid rgba(148,163,255,.25);
        background: rgba(15,23,42,.70);
        padding: 12px;
    }

        .kpi .k {
            color: rgba(226,232,240,.78);
            font-weight: 800;
            font-size: 12px;
        }

        .kpi .v {
            font-weight: 1000;
            font-size: 18px;
            margin-top: 2px;
            color: #fff;
        }

    .filters {
        display: flex;
        flex-wrap: wrap;
        align-items: end;
        gap: 10px;
        padding: 14px 16px 16px;
    }

        .filters label {
            font-weight: 800;
            font-size: 12px;
            color: rgba(226,232,240,.75);
        }

        .filters .form-control, .filters .form-select {
            background: rgba(2,6,23,.72);
            border: 1px solid rgba(148,163,255,.30);
            color: #e5e7eb;
            border-radius: 14px;
            font-weight: 700;
        }

    .btn-glow {
        border: none;
        border-radius: 999px;
        padding: 10px 14px;
        font-weight: 900;
        background: linear-gradient(90deg,#3b5ccc,#7c3aed);
        color: #fff;
    }

    .chart-box {
        position: relative;
        height: 320px;
    }

        .chart-box.sm {
            height: 260px;
        }

    table.table-darkish {
        color: #e5e7eb;
        border-color: rgba(148,163,255,.18);
        margin: 0;
    }

        table.table-darkish th {
            color: rgba(226,232,240,.85);
            font-size: 12px;
            font-weight: 900;
            border-color: rgba(148,163,255,.18);
        }

        table.table-darkish td {
            border-color: rgba(148,163,255,.12);
            vertical-align: middle;
            font-weight: 700;
            font-size: 13px;
        }

    /* ===== Ranking UI (UPDATED) ===== */
    .table-rank thead th {
        position: sticky;
        top: 0;
        background: rgba(2,6,23,.96);
        z-index: 2;
        backdrop-filter: blur(8px);
    }

    .table-rank tbody tr:hover {
        background: rgba(148,163,255,.06);
    }

    .rank-pill {
        width: 54px;
        height: 34px;
        border-radius: 999px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-weight: 1000;
        font-size: 12px;
        letter-spacing: .2px;
        border: 1px solid rgba(148,163,255,.25);
        background: rgba(15,23,42,.72);
    }

    .rank-1 {
        border-color: rgba(250,204,21,.70);
        background: radial-gradient(circle at 30% 30%, rgba(250,204,21,.22), rgba(15,23,42,.72));
        box-shadow: 0 0 0 1px rgba(250,204,21,.18) inset, 0 10px 25px rgba(250,204,21,.08);
    }

    .rank-2 {
        border-color: rgba(226,232,240,.55);
        background: radial-gradient(circle at 30% 30%, rgba(226,232,240,.18), rgba(15,23,42,.72));
        box-shadow: 0 0 0 1px rgba(226,232,240,.14) inset;
    }

    .rank-3 {
        border-color: rgba(251,146,60,.70);
        background: radial-gradient(circle at 30% 30%, rgba(251,146,60,.20), rgba(15,23,42,.72));
        box-shadow: 0 0 0 1px rgba(251,146,60,.14) inset;
    }

    .movie-cell {
        display: flex;
        flex-direction: column;
        gap: 6px;
        min-width: 0;
    }

    .movie-title {
        font-weight: 950;
        color: #fff;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        line-height: 1.15;
    }

    .movie-meta {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        font-size: 11px;
        font-weight: 800;
        color: rgba(226,232,240,.72);
    }

    .meter {
        height: 9px;
        border-radius: 999px;
        overflow: hidden;
        background: rgba(255,255,255,.08);
        border: 1px solid rgba(148,163,255,.14);
    }

        .meter > span {
            display: block;
            height: 100%;
            background: linear-gradient(90deg, rgba(59,130,246,.95), rgba(124,58,237,.95));
            width: 0%;
        }

    .val-strong {
        font-weight: 950;
        color: #fff;
        font-variant-numeric: tabular-nums;
    }

    .val-muted {
        font-weight: 800;
        color: rgba(226,232,240,.85);
        font-variant-numeric: tabular-nums;
    }

    .empty-rank {
        padding: 16px 0;
        color: rgba(226,232,240,.75);
        font-weight: 800;
        text-align: center;
    }
    /* ===== Ranking UI: đổi màu nền row giống chip "Tất cả quyền" ===== */

    /* 1) Bỏ nền trắng của table (Bootstrap) */
    .table-rank.table,
    .table-rank.table > :not(caption) > * > * {
        background-color: transparent !important;
    }

    /* 2) Header: giữ tone tối, có blur nhẹ */
    .table-rank thead th {
        position: sticky;
        top: 0;
        z-index: 2;
        background: rgba(2,6,23,.92) !important;
        backdrop-filter: blur(10px);
    }

    /* 3) Màu nền từng dòng giống chip "Tất cả quyền" (gradient tím) */
    .table-rank tbody tr {
        background: linear-gradient(180deg, rgba(124,58,237,.22), rgba(59,92,204,.14)) !important;
    }

    /* 4) Tạo khoảng cách giữa các dòng + bo góc */
    .table-rank {
        border-collapse: separate !important;
        border-spacing: 0 10px; /* khoảng cách giữa row */
    }

        .table-rank tbody td {
            border-top: 1px solid rgba(148,163,255,.18) !important;
            border-bottom: 1px solid rgba(148,163,255,.10) !important;
            padding-top: 12px;
            padding-bottom: 12px;
        }

        /* bo góc trái/phải của row */
        .table-rank tbody tr td:first-child {
            border-left: 1px solid rgba(148,163,255,.18) !important;
            border-top-left-radius: 16px;
            border-bottom-left-radius: 16px;
        }

        .table-rank tbody tr td:last-child {
            border-right: 1px solid rgba(148,163,255,.18) !important;
            border-top-right-radius: 16px;
            border-bottom-right-radius: 16px;
        }

        /* 5) Hover giống style chip */
        .table-rank tbody tr:hover {
            background: linear-gradient(180deg, rgba(124,58,237,.30), rgba(59,92,204,.18)) !important;
            box-shadow: 0 12px 30px rgba(15,23,42,.55);
            transition: .2s ease;
        }
        /* FIX: số bị đen -> trắng trong bảng xếp hạng */
        .table-rank tbody td,
        .table-rank tbody td.text-end {
            color: rgba(248,250,252,0.95) !important;
        }

            .table-rank tbody td.text-end,
            .val-strong {
                color: #fff !important;
            }

    /* 6) Rank pill cũng đồng bộ màu nền */
    .rank-pill {
        background: linear-gradient(180deg, rgba(124,58,237,.25), rgba(59,92,204,.12)) !important;
        border-color: rgba(148,163,255,.30) !important;
    }

    /* 7) Text trong row rõ hơn */
    .movie-title {
        color: #f8fafc;
    }

    .movie-sub {
        color: rgba(226,232,240,.75);
    }

</style>

<div class="container stats-shell">
    <div class="stats-title">Thống kê - Báo cáo</div>
    <div class="stats-sub">Biểu đồ + bảng + xuất Excel</div>

    <div class="stats-card mb-3">
        <div class="stats-card-hd"><h3>Bộ lọc</h3></div>
        <div class="stats-card-bd">
            <form method="get" class="filters" asp-controller="Reports" asp-action="Index">
                <div>
                    <label>Từ ngày</label>
                    <input type="date" class="form-control" name="fromDate" value="@Model.FromDate.ToString("yyyy-MM-dd")" />
                </div>
                <div>
                    <label>Đến ngày</label>
                    <input type="date" class="form-control" name="toDate" value="@Model.ToDate.ToString("yyyy-MM-dd")" />
                </div>
                <div>
                    <label>Nhóm theo</label>
                    <select class="form-select" name="groupBy">
                        <option value="day" selected="@(Model.GroupBy == "day")">Ngày</option>
                        <option value="week" selected="@(Model.GroupBy == "week")">Tuần</option>
                        <option value="month" selected="@(Model.GroupBy == "month")">Tháng</option>
                        <option value="year" selected="@(Model.GroupBy == "year")">Năm</option>
                    </select>
                </div>
                <div>
                    <label>Top N phim</label>
                    <input type="number" class="form-control" min="1" max="50" name="topN" value="@Model.TopN" />
                </div>
                <div>
                    <button class="btn-glow" type="submit">
                        <i class="fa-solid fa-filter"></i> Áp dụng
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div class="kpi-grid mb-3">
        <div class="kpi"><div class="k">Tổng doanh thu (TotalPaid)</div><div class="v">@Model.Kpi.TotalPaid.ToString("#,##0")</div></div>
        <div class="kpi"><div class="k">Doanh thu vé</div><div class="v">@Model.Kpi.TicketRevenue.ToString("#,##0")</div></div>
        <div class="kpi"><div class="k">Doanh thu snack</div><div class="v">@Model.Kpi.SnackRevenue.ToString("#,##0")</div></div>
        <div class="kpi"><div class="k">Số hóa đơn (Paid)</div><div class="v">@Model.Kpi.TotalInvoices</div></div>
        <div class="kpi"><div class="k">Số vé đã bán</div><div class="v">@Model.Kpi.TotalTickets</div></div>
    </div>

    <div class="row g-3">
        <div class="col-lg-8">
            <div class="stats-card h-100">
                <div class="stats-card-hd"><h3>Doanh thu theo kỳ (Vé + Snack)</h3></div>
                <div class="stats-card-bd">
                    <div class="chart-box"><canvas id="revBar"></canvas></div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="stats-card h-100">
                <div class="stats-card-hd"><h3>Tỷ trọng doanh thu</h3></div>
                <div class="stats-card-bd">
                    <div class="chart-box sm"><canvas id="revPie"></canvas></div>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="stats-card h-100">
                <div class="stats-card-hd"><h3>Top phim theo số vé</h3></div>
                <div class="stats-card-bd">
                    <div class="chart-box sm"><canvas id="topMovieBar"></canvas></div>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="stats-card h-100">
                <div class="stats-card-hd">
                    <h3>Bảng xếp hạng</h3>

                    <!-- FIX: dùng TagHelper để tạo URL đúng -->
                    <a class="btn btn-sm btn-glow"
                       asp-controller="Reports"
                       asp-action="ExportTopMoviesExcel"
                       asp-route-fromDate="@Model.FromDate.ToString("yyyy-MM-dd")"
                       asp-route-toDate="@Model.ToDate.ToString("yyyy-MM-dd")"
                       asp-route-topN="@Model.TopN"
                       asp-route-onlyReleasedMovies="true">
                        <i class="fa-solid fa-file-excel"></i> Excel Top phim
                    </a>
                </div>

                <div class="stats-card-bd" style="padding-top:10px;">
                    <div class="table-responsive" style="max-height:340px;">
                        <table class="table table-darkish table-sm table-rank">
                            <thead>
                                <tr>
                                    <th style="width:80px;">Hạng</th>
                                    <th>Phim</th>
                                    <th style="width:120px;" class="text-end">Số vé</th>
                                    <th style="width:150px;" class="text-end">DT vé</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (Model.TopMoviesByTickets.Count == 0)
                                {
                                    <tr>
                                        <td colspan="4" class="empty-rank">
                                            Không có dữ liệu trong khoảng lọc.
                                        </td>
                                    </tr>
                                }
                                else
                                {
                                    foreach (var x in Model.TopMoviesByTickets)
                                    {
                                        var cls = x.Rank == 1 ? "rank-1" : (x.Rank == 2 ? "rank-2" : (x.Rank == 3 ? "rank-3" : ""));
                                        var pct = (maxTickets > 0) ? (int)Math.Round((double)x.TicketsSold * 100.0 / maxTickets) : 0;

                                        <tr>
                                            <td>
                                                <div class="rank-pill @cls">#@x.Rank</div>
                                            </td>

                                            <td>
                                                <div class="movie-cell">
                                                    <div class="movie-title" title="@x.Title">@x.Title</div>

                                                    <div class="movie-meta">
                                                        <span>So với top 1</span>
                                                        <span class="val-muted">@pct%</span>
                                                    </div>

                                                    <div class="meter">
                                                        <span style="width:@pct%"></span>
                                                    </div>
                                                </div>
                                            </td>

                                            <td class="text-end val-strong">@x.TicketsSold</td>
                                            <td class="text-end val-strong">@x.TicketRevenue.ToString("#,##0")</td>
                                        </tr>
                                    }
                                }
                            </tbody>

                        </table>
                    </div>
                </div>

            </div>
        </div>

        <!-- Báo cáo Excel -->
        <div class="col-12">
            <div class="stats-card">
                <div class="stats-card-hd"><h3>Xuất báo cáo Excel</h3></div>
                <div class="stats-card-bd">
                    <div class="d-flex flex-wrap gap-2">

                        <!-- FIX: TagHelper -->
                        <a class="btn btn-sm btn-glow"
                           asp-controller="Reports"
                           asp-action="ExportRevenueExcel"
                           asp-route-fromDate="@Model.FromDate.ToString("yyyy-MM-dd")"
                           asp-route-toDate="@Model.ToDate.ToString("yyyy-MM-dd")"
                           asp-route-groupBy="@Model.GroupBy"
                           asp-route-mode="all">
                            <i class="fa-solid fa-file-excel"></i> Doanh thu (Vé+Snack)
                        </a>

                        <a class="btn btn-sm btn-glow"
                           asp-controller="Reports"
                           asp-action="ExportRevenueExcel"
                           asp-route-fromDate="@Model.FromDate.ToString("yyyy-MM-dd")"
                           asp-route-toDate="@Model.ToDate.ToString("yyyy-MM-dd")"
                           asp-route-groupBy="@Model.GroupBy"
                           asp-route-mode="snack">
                            <i class="fa-solid fa-file-excel"></i> Doanh thu Snack
                        </a>

                        <a class="btn btn-sm btn-glow"
                           asp-controller="Reports"
                           asp-action="ExportRevenueExcel"
                           asp-route-fromDate="@Model.FromDate.ToString("yyyy-MM-dd")"
                           asp-route-toDate="@Model.ToDate.ToString("yyyy-MM-dd")"
                           asp-route-groupBy="@Model.GroupBy"
                           asp-route-mode="movie">
                            <i class="fa-solid fa-file-excel"></i> Doanh thu Vé (mode=movie)
                        </a>
                    </div>

                    <div class="mt-2" style="color:rgba(226,232,240,.72); font-weight:800; font-size:12px;">
                        mode=movie muốn 1 phim: thêm <code>&movieId=...</code> vào URL.
                        mode=snack muốn 1 snack: thêm <code>&snackId=...</code>.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        const labels = @Html.Raw(JsonSerializer.Serialize(labels));
        const ticketSeries = @Html.Raw(JsonSerializer.Serialize(ticketSeries));
        const snackSeries = @Html.Raw(JsonSerializer.Serialize(snackSeries));

        const topMovieLabels = @Html.Raw(JsonSerializer.Serialize(topMovieLabels));
        const topMovieTickets = @Html.Raw(JsonSerializer.Serialize(topMovieTickets));

        const pieTicket = @Html.Raw(JsonSerializer.Serialize(pieTicket));
        const pieSnack = @Html.Raw(JsonSerializer.Serialize(pieSnack));

        new Chart(document.getElementById('revBar'), {
            type: 'bar',
            data: {
                labels,
                datasets: [
                    { label: 'Vé', data: ticketSeries, stack: 'rev' },
                    { label: 'Snack', data: snackSeries, stack: 'rev' }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: { x: { stacked: true }, y: { stacked: true } }
            }
        });

        new Chart(document.getElementById('revPie'), {
            type: 'doughnut',
            data: {
                labels: ['Vé', 'Snack'],
                datasets: [{ data: [pieTicket, pieSnack] }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });

        new Chart(document.getElementById('topMovieBar'), {
            type: 'bar',
            data: {
                labels: topMovieLabels,
                datasets: [{ label: 'Số vé', data: topMovieTickets }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
    </script>
}
